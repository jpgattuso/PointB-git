---
title: "Time series of the carbonate chemistry at Point B"
author: "Jean-Pierre Gattuso, CNRS-SU (gattuso@obs-vlfr.fr), Samir Alliouane, Maïa Durozier, Lydia Kapsenberg and Laure Mousseau"
date: '`r format(Sys.Date(), "%d %B %Y")`'
output:
  html_document:
    code_folding: hide
    fig_caption: yes
    toc: yes
    toc_float: yes
  pdf_document:
    toc: yes
---


```{r setup, include=FALSE}
rm(list = ls())
#define who is the user and define path
if (Sys.getenv("LOGNAME") == "gattuso") {
  path = "../../pCloud\ Sync/Documents/experiments/exp153_carbonates_point_B/"
  path_sami = "../../pCloud\ Sync/Documents/experiments/exp176_sami/sami_data/sami_raw_export/Data_deployment/EOL"
}
if (Sys.getenv("LOGNAME") == "samir") {
  path = "../../pCloud Sync/exp153_carbonates_point_B/"
  path_sami = "../../pCloud\ Sync/exp176_sami/sami_data/sami_raw_export/Data_deployment/EOL"
}
#cutoff_date <- "2020-01-01" #to limit regressions on complete years
cutoff_date <- "2020-09-01" #to limit regressions on complete years
require(readxl)
require(seacarb)
library(cowplot)
library(scales)
library(RColorBrewer)
library(gridExtra)
library(reshape2)
library(xtable)
library(zoo)
library(lubridate)
library(nlme)
library(lmtest)
library(grid)
library(viridis)
library(animation)
library(directlabels)
library(tibble)
require("knitr")
if (!require("pander")) install.packages("pander")
library(pander)
if (!require("tidyverse")) install.packages("tidyverse")
library(tidyverse)
if (!require("todor")) install.packages("todor")
library(todor)
if (!require("skimr")) install.packages("skimr"); library(skimr)
if (!require("dygraphs")) install.packages("dygraphs"); library(dygraphs)
if (!require("xts")) install.packages("xts"); library(xts)
if (!require("patchwork")) install.packages("patchwork"); library(patchwork)

Sys.setenv(TZ='UTC')
dc1 <- "#482173FF" #discrete color 1
dc2 <- "#51C56AFF" #discrete color 2: 
dc3 <- "#482173FF" #discrete color 1
dc4 <- "#51C56AFF" #discrete color 2: 

size_labs <- 6
face_font <- "plain"

Mytheme <- function(size_labs = 6, face_font="plain", ...) {
  theme_bw() +
  theme(axis.text.x = element_text(face=face_font, size=size_labs, color="black"),
        axis.title.x = element_text(face=face_font, size=size_labs, margin=margin(0,0,0,0,"pt")),
        axis.text.y = element_text(face=face_font, color="black", size=size_labs),
        axis.title.y = element_text(face=face_font, size=size_labs),
        axis.ticks.x = element_line(size=0.1),
        axis.ticks.y = element_line(size=0.1),
        axis.ticks.length = unit(1.1, "mm"),
        panel.grid.major = element_line(size = 0.25, color="black", linetype="dotted"),
        aspect.ratio = 1 / 3,
        plot.margin = margin(t = 0, r = 1, b = 0, l = 0, unit = "lines")
  )
}

Mytheme_facet <- function(size_labs = 6, face_font="plain") {
  theme_bw() +
  theme(axis.text.x = element_text(face=face_font, size=size_labs, color="black"),
        axis.title.x = element_text(face=face_font, size=size_labs, margin=margin(0,0,0,0,"pt")),
        axis.text.y = element_text(face=face_font, color="black", size=size_labs),
        axis.title.y = element_text(face=face_font, size=size_labs),
        axis.ticks.x = element_line(size=0.1),
        axis.ticks.y = element_line(size=0.1),
        axis.ticks.length = unit(1.1, "mm"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        aspect.ratio = 1,
        plot.margin = margin(t = 0, r = 1, b = 0, l = 0, unit = "lines")
  )
}
######## To add regression line on ggplots
# use as annotate(aes(x = 25, y = 300, label = lm_eqn(lm(y ~ x, df))), parse = TRUE)
# http://stackoverflow.com/questions/7549694/ggplot2-adding-regression-line-equation-and-r2-on-graph
lm_eqn = function(m) {
  l <- list(a = format(coef(m)[1], digits = 2),
      b = format(abs(coef(m)[2]), digits = 2),
      r2 = format(summary(m)$r.squared, digits = 3));
  if (coef(m)[2] >= 0)  {
    eq <- substitute(italic(y) == a + b %.% italic(x)*","~~italic(r)^2~"="~r2,l)
  } else {
    eq <- substitute(italic(y) == a - b %.% italic(x)*","~~italic(r)^2~"="~r2,l)    
  }
  as.character(as.expression(eq));                 
}

######## function to make regression plot with model I equation in title
ggreg <- function (fit, point_size=2) {
  ggplot(fit$model, aes_string(x = names(fit$model)[2],
                               y = names(fit$model)[1])) +
    geom_point(size = point_size, col = "blue") +
    stat_smooth(method = "lm", col = "black") +
    labs(title = paste(title, "\nAdj R2 = ",signif(summary(fit)$adj.r.squared, 5),
                       "; Intercept =",signif(fit$coef[[1]],5 ),
                       "; Slope =",signif(fit$coef[[2]], 5),
                       "; P =",signif(summary(fit)$coef[2,4], 5))) +
    theme(plot.title = element_text(size=7))
}

```
```{r test regression, include=FALSE}
# This is to test linear regressions with dates
# Conclusion is that the slope is per day but I have decided to use decimal_date() to avoid any confusion
dt <- as_date(c("1916-06-16", "2016-06-15"))
temp <- c(20, 21)
dat <- data.frame(dt, temp)
reg <- lm(data=dat,temp ~ dt)
slope <- 365*coef(reg)[2]
```

# Material and methods

Samples were collected from XX-l Niskin bottles, transferred to glass bottles, overfilled and then poisoned to maintain the integrity of the sample chemistry as recommended by Dickson et al. (2007).  The _Service National d'Analyse des Paramètres Océaniques du CO$_2$_, at the _Université Pierre et Marie Curie_, determined the concentration of dissolved inorganic carbon ($C_\mathrm{T}$) and total alkalinity ($A_\mathrm{T}$), by potentiometric titration, following the methods described by (Edmond1970) and (DOE1994).

Calculations of the carbonate system parameters were performed using the R package \emph{seacarb} (Lavigne2014). The total concentrations of silicate and phosphate were used when available. Otherwise they were set to 0. The total boron concentration was calculated using the formulation of (Lee2010b). The following constants were used: $K_1$ and $K_2$ from (Lueker2000, $K_f$ from (Perez1987b) and $K_s$ from (Dickson1990).

## Data available and quality control
All data are used in the following; none were eliminated according to the quality flags (\textbf{this remains to be done}).

### Les codes du SNAPOCO2

Les "quality flags" "qflag\_sample", "qflag\_ta", "qflag\_DIC" qui apparaissent dans les fichiers de données du LOCEAN sont établis sur la base des codes WOCE (World Ocean Circulation Experiment) : WOCE Operations Manual (1994), WHP Office Report 90-1, WOCE Report N.67/91, p52-53. Woods Hole, Mass., USA.

- Données AT et CT et water sample quality flag : (i.e pour les étapes : "qflag\_ta"et "qflag\_DIC")
  - flag 0 : Dosage avorté (échantillon perdu),
	- flag 2 : dosage correct,
	- flag 3 : dosage douteux

- Codification quality flag réception flacon : (i.e pour l'étape : "qflag\_sample")
	- A : OK;
	- B : mal rempli;
	- C : flacon cassé;
	- D : bouchon cassé;
	- E : dépôt, particule dans le flacon;
	- F : sel au goulot;
	- G : manque de graisse au goulot;
	- H : pas d'élastique.


### Les codes de Villefranche (inspirés des codes SOMLIT)

- Codification qflag\_taking concernant le prélèvement des échantillons en mer : (i.e pour l'étape : "qflag\_taking")
	- 0 : ancien code qui signifie OK
	- 2 : nouveau code qui signifie OK
	- 3 : prélèvement douteux
	- 4 : prélèvement mauvais

- Codification qflag\_final, qui correspond au code "final" des résultats TA et DIC (i.e pour l'étape : "qflag\_final"). Comme TA et DIC sont déterminés par la même titration, qflag\_ta et qflag\_DIC devrait être identiques. Ce n'est pas le cas en décembre 2009 où il manque des qflag\_DIC. On a alors considéré que qflag\_final = qflag\_ta.

	- 0 : Dosage avorté (échantillon perdu)
	- 2 : résultat OK
	- 3 : résultat douteux
	- 4 : résultat mauvais


```{r DYFAMED, include=FALSE}
# read data and create a data frame tbl
#getwd()
dyf <- tibble::as_tibble(read.table(paste0(path, "data/carb_dyfamed.txt"), 
                       encoding="UTF-8", header=TRUE, sep="", dec=".", 
                       as.is=TRUE,
                       na.strings = c("NaN","NA", "999999")))
dyf$date <- mdy(dyf$date)
dyf$year <- year(dyf$date)

# remove questionable data (flag = 3)
dyf$AT[dyf$QF_AT==3 | dyf$QF_AT==4] <- NA 
dyf$CT[dyf$QF_CT==3 | dyf$QF_AT==4] <- NA 
dyf <- filter(dyf, date!="2005-03-29") # very high salinities that seem wrong that day

# remove outliers
#tmp <- dyf[which(dyf$AT>2625),]
fig_dyf_date_AT <- ggplot(data = dyf, aes(x=date, y=AT)) +
  geom_point(na.rm=TRUE)
png(file = "output_jp/figures/fig_dyf_date_AT.png", 
    width = 15, height = 10, units = "cm", res = 300)
print(fig_dyf_date_AT)
dev.off()
dyf <- dplyr::filter(dyf, salinity > 37)
dyf$AT[dyf$date=="2005-08-02" & dyf$pressure==90] <- NA # obvious outlier
dyf$AT[dyf$date=="2005-07-02" & (dyf$pressure>=300 & dyf$pressure<=700)] <- NA # questionable because bad Quality Flag réception flacon
# replot without outliers
fig_dyf_date_AT <- ggplot(data = dyf, aes(x=date, y=AT)) +
  geom_point(na.rm=TRUE)
png(file = "output_jp/figures/fig_dyf_date_AT.png", 
    width = 15, height = 10, units = "cm", res = 300)
print(fig_dyf_date_AT)
dev.off()

# AT vs salinity at DYFAMED all depths
lms <- summary(lm(data = dyf, AT ~ salinity)) #all data
fig_dyf_AT_salinity <- ggplot() +  geom_point(data = dyf, aes(x=salinity, y=AT)) +
  labs(y = "", x="Salinity", title="DYFAMED all depths") +
  stat_smooth(method = lm, na.rm=TRUE)
png(file = "output_jp/figures/fig_dyf_AT_salinity.png", 
    width = 15, height = 10, units = "cm", res = 300)
print(fig_dyf_AT_salinity)
dev.off()

# surface (less than 12 m) data
dyf_surf <- dyf %>% 
  dplyr::filter(pressure <= 12) %>%
  dplyr::mutate(monthd=month(date), year=year(date))
  
# Salinity as a function of time
lms <- summary(lm(data = dyf_surf, salinity ~ decimal_date(date))) #all data
prob <- pf(lms$fstatistic[1],lms$fstatistic[2],lms$fstatistic[3],lower.tail=FALSE)
reg <- cbind(as.numeric(c(lms$coefficients[2,1], lms$coefficients[2,2], 
                               lms$coefficients[2,4], lms$coefficients[1,1], lms$coefficients[1,2],
                               lms$coefficients[1,4], lms$fstatistic[1], lms$fstatistic[3], lms$r.squared, prob)))
lms <- summary(lm(data = filter(dyf_surf, year>2002), salinity ~ decimal_date(date))) #all data
prob <- pf(lms$fstatistic[1],lms$fstatistic[2],lms$fstatistic[3],lower.tail=FALSE)
reg <- cbind(reg, as.numeric(c(lms$coefficients[2,1], lms$coefficients[2,2], 
                          lms$coefficients[2,4], lms$coefficients[1,1], lms$coefficients[1,2],
                          lms$coefficients[1,4], lms$fstatistic[1], lms$fstatistic[3], lms$r.squared, prob)))
lms <- summary(lm(data = filter(dyf_surf, year>=2007), salinity ~ decimal_date(date))) #all data
prob <- pf(lms$fstatistic[1],lms$fstatistic[2],lms$fstatistic[3],lower.tail=FALSE)
reg <- cbind(reg, as.numeric(c(lms$coefficients[2,1], lms$coefficients[2,2], 
                               lms$coefficients[2,4], lms$coefficients[1,1], lms$coefficients[1,2],
                               lms$coefficients[1,4], lms$fstatistic[1], lms$fstatistic[3], lms$r.squared, prob)))
colnames(reg) <- c("Salinity all", "Salinity post 2002", "Salinity post 2007")
row.names(reg) <- c("Slope", "SE Slope", "P Slope","Intercept","SE int.","P int.", "F", "df",
                    "R2","P value")
tab_fig_dyf_surf_date_salinity <- reg


# AT as a function of time
lms <- summary(lm(data = dyf_surf, AT ~ decimal_date(date))) #all data
prob <- pf(lms$fstatistic[1],lms$fstatistic[2],lms$fstatistic[3],lower.tail=FALSE)
reg <- cbind(as.numeric(c(lms$coefficients[2,1], lms$coefficients[2,2], 
                               lms$coefficients[2,4], lms$coefficients[1,1], lms$coefficients[1,2],
                               lms$coefficients[1,4], lms$fstatistic[1], lms$fstatistic[3], lms$r.squared, prob)))
lms <- summary(lm(data = filter(dyf_surf, year>2002), AT ~ decimal_date(date))) #all data
prob <- pf(lms$fstatistic[1],lms$fstatistic[2],lms$fstatistic[3],lower.tail=FALSE)
reg <- cbind(reg, as.numeric(c(lms$coefficients[2,1], lms$coefficients[2,2], 
                          lms$coefficients[2,4], lms$coefficients[1,1], lms$coefficients[1,2],
                          lms$coefficients[1,4], lms$fstatistic[1], lms$fstatistic[3], lms$r.squared, prob)))
lms <- summary(lm(data = filter(dyf_surf, year>=2007), AT ~ decimal_date(date))) #all data
prob <- pf(lms$fstatistic[1],lms$fstatistic[2],lms$fstatistic[3],lower.tail=FALSE)
reg <- cbind(reg, as.numeric(c(lms$coefficients[2,1], lms$coefficients[2,2], 
                               lms$coefficients[2,4], lms$coefficients[1,1], lms$coefficients[1,2],
                               lms$coefficients[1,4], lms$fstatistic[1], lms$fstatistic[3], lms$r.squared, prob)))
colnames(reg) <- c("AT all", "AT post 2002", "AT post 2007")
row.names(reg) <- c("Slope", "SE Slope", "P Slope","Intercept","SE int.","P int.", "F", "dl", "R2","P value")

# AT as a function of time: transform in latex table and save
tab_fig_dyf_surf_date_AT <- reg

# table.tex <- xtable(reg, label = "tab:dyf_surf_date_AT")
# caption(table.tex) <-
# "Linear regression of total alkalinity at DYFAMED, without interpolation, against time at depths shallower than 12 m."
# print(
# table.tex,
# type = "latex",
# file = "tables/dyf_surf_date_AT.tex",
# caption.placement = "top",
# sanitize.text.function = identity,
# scalebox = 0.7
# )
fig_dyf_surf_date_AT <- ggplot(data = dyf_surf, aes(x=date, y=AT)) +
  geom_point(na.rm=TRUE) + 
  labs(y = "",x="Time", title=expression(paste(italic(A)[T] ," ","at <= 12 m"))) +
  stat_smooth(method = lm, na.rm=TRUE)
png(file = "output_jp/figures/fig_dyf_surf_date_AT.png", 
    width = 15, height = 10, units = "cm", res = 300)
print(fig_dyf_surf_date_AT)
dev.off()

reg <- NULL
#all data
lms <- summary(lm(data = dyf_surf, AT ~ salinity)) #all data
prob <- pf(lms$fstatistic[1],lms$fstatistic[2],lms$fstatistic[3],lower.tail=FALSE)
reg <- cbind(as.numeric(c(lms$coefficients[2,1], lms$coefficients[2,2], 
                          lms$coefficients[2,4], lms$coefficients[1,1], lms$coefficients[1,2],
                          lms$coefficients[1,4], lms$fstatistic[1],lms$fstatistic[3], lms$r.squared, prob)))
#2002 to present
lms <- summary(lm(data = filter(dyf_surf, year>2002), AT ~ salinity)) #all data
prob <- pf(lms$fstatistic[1],lms$fstatistic[2],lms$fstatistic[3],lower.tail=FALSE)
reg <- cbind(reg, as.numeric(c(lms$coefficients[2,1], lms$coefficients[2,2], 
                               lms$coefficients[2,4], lms$coefficients[1,1], lms$coefficients[1,2],
                               lms$coefficients[1,4], lms$fstatistic[1],lms$fstatistic[3], lms$r.squared, prob)))
#2007 to present
lms <- summary(lm(data = filter(dyf_surf, year>=2007), AT ~ salinity)) #all data
prob <- pf(lms$fstatistic[1],lms$fstatistic[2],lms$fstatistic[3],lower.tail=FALSE)
reg <- cbind(reg, as.numeric(c(lms$coefficients[2,1], lms$coefficients[2,2], 
                               lms$coefficients[2,4], lms$coefficients[1,1], lms$coefficients[1,2],
                               lms$coefficients[1,4], lms$fstatistic[1], lms$fstatistic[3], lms$r.squared, prob)))
int_dyf <- lms$coefficients[1,1]
slo_dyf <- lms$coefficients[2,1]
colnames(reg) <- c("AT all", "AT post 2002", "AT post 2007")
row.names(reg) <- c("Slope", "SE Slope", "P Slope","Intercept","SE int.","P int.", "F", "df",
                    "R2", "P value")
# AT as a function of salinity: transform in latex table and save
tab_dyf_surf_salinity_AT <- reg

# table.tex <- xtable(reg, label="tab:dyf_surf_salinity_AT")
# caption(table.tex) <- "Linear regression of total alkalinity at DYFAMED, without interpolation, against salinity at depths shallower than 12 m."
# print(table.tex, type="latex", file="tables/dyf_surf_salinity_AT.tex", 
#       caption.placement = "top", sanitize.text.function=identity, scalebox=0.7)


# AT as a function of salinity for all years
p1 <- ggplot(data=dyf_surf) +
  aes(salinity, AT) +
  geom_text(na.rm=TRUE, show.legend=FALSE, aes(label=as.character(monthd), colour = factor(year))) +
  stat_smooth(method=lm, na.rm=TRUE, show.legend=FALSE, se=FALSE, aes(fill=factor(year), colour=factor(year))) +
  geom_abline(intercept = int_dyf, slope = slo_dyf, linetype="dashed", colour = "black") +
  facet_wrap(~ year) +
  scale_x_continuous(limits = c(36.8, 38.4), breaks=c(37, 37.5, 38), expand = c(0,0)) +
  scale_y_continuous(limits = c(2490, 2600), expand = c(0,0)) +
  labs(title = "Point B (1 m, with month of sampling; dotted line is Dyfamed, less than 12 m, 2007-2015)", x = "Salinity", y = "Total alkalinity") +
  theme(axis.text.x=element_text(size=16, color="black"),
        axis.title.x=element_text(face="bold", size=16),
        axis.text.y=element_text(size=16, color="black"),
        axis.title.y=element_text(face="bold", size=16),
        plot.title = element_text(face="bold", size=16)
  )

ggsave(file = "output_jp/figures/fig_ta_vs_salinity_0m.png", p1,
    width = 20, height = 13, units = "cm")


dyf_surf_salinity_AT <- ggplot(data = dyf_surf, aes(x=salinity, y=AT), na.rm=TRUE) +
  geom_point(aes(colour=factor(year)), na.rm=TRUE) + 
  labs(y = "",x="Salinity", title=expression(paste(italic(A)[T] ," ","at <= 12 m"))) +
  stat_smooth(method = lm, na.rm=TRUE)
ggsave(file = "output_jp/figures/dyf_surf_salinity_AT.png", dyf_surf_salinity_AT,
    width = 15, height = 10, units = "cm")

# AT as a function of salinity for every year
j <- 0
reg <- data.frame()
for (i in 1:length(unique(dyf_surf$year))) { #one loops through all years
  j <- j + 1
  yr <- unique(dyf_surf$year)[i]
  d_reg <- filter(dyf_surf, year==yr)
#  fm <- as.formula(paste0(i, " ~ sampling_date"))
  #fit[[i]] <- lm(fm, data = dat0m)
  lms <- summary(lm(data=d_reg, AT ~ salinity))
  # calculate probability of fstatistic because it cannot be extracted from lms above
  # see http://stats.stackexchange.com/questions/92824/extracting-the-model-p-value-for-a-multiple-regression-in-r
  # slope returned by lm is per second
  prob <- pf(lms$fstatistic[1],lms$fstatistic[2],lms$fstatistic[3],lower.tail=FALSE)
  reg <- rbind(reg, as.numeric(c(lms$coefficients[2,1], lms$coefficients[2,2], 
                                 lms$coefficients[2,4], lms$coefficients[1,1], lms$coefficients[1,2],
                                 lms$coefficients[1,4], lms$fstatistic[1], lms$fstatistic[3], lms$r.squared, prob)))
}
names(reg) <- c("Slope", "SE Slope", "P Slope","Intercept","SE int.","P int.", "F", "df",
                "R2","P value")
row.names(reg) <- as.character(unique(dyf_surf$year))
#transform in latex table and save
tab_dyf_surf_salinity_AT_year <- reg

# table.tex <- xtable(reg, digits=c(0,3,3,2,1,2,3,3,3), label="tab:dyf_surf_salinity_AT_year")
# caption(table.tex) <- "Linear regressions of total alkalinity at DYFAMED, without interpolation, against salinity at depths shallower than 12 m."
# print(table.tex, type="latex", fil %>% e="tables/dyf_surf_salinity_AT_year", 
#       caption.placement = "top", sanitize.text.function=identity, scalebox=0.7)

# DYFAMED plots
dyf_surf_salinity_AT_year <- ggplot(data=dyf_surf) +
  aes(salinity, AT) +
  geom_point(na.rm=TRUE, show.legend=FALSE, aes(colour = factor(year))) +
  stat_smooth(method=lm, na.rm=TRUE, show.legend=FALSE, se=FALSE, aes(fill=factor(year), colour=factor(year))) +
#  geom_abline(intercept = int_dyf, slope = slo_dyf, linetype="dashed", colour = "black") +
  facet_wrap(~ year) +
#  scale_x_continuous(limits = c(36.8, 38.4), breaks=c(37, 37.5, 38), expand = c(0,0)) +
#  scale_y_continuous(limits = c(2490, 2600), expand = c(0,0)) +
  labs(title = "DYFAMED (< 12 m)", x = "Salinity", y = "Total alkalinity") +
  theme(axis.text.x=element_text(size=16, color="black"),
        axis.title.x=element_text(face="bold", size=16),
        axis.text.y=element_text(size=16, color="black"),
        axis.title.y=element_text(face="bold", size=16),
        plot.title = element_text(face="bold", size=16)
  )

ggsave(file = "output_jp/figures/dyf_surf_salinity_AT_year.png", dyf_surf_salinity_AT_year,
    width = 20, height = 20, units = "cm")
```

#Results

## Time series salinity at DYFAMED
```{r}
kable(tab_fig_dyf_surf_date_salinity)

```


## AT vs salinity at DYFAMED (all depths)[section added 2017-11-21]


## AT vs time and salinity at DYFAMED
These are for surface (< 12 m) values, with outliers removed. The slope of salinity vs time is significant for all years but not post-2007 (P = 0.08), which is the relevant period of interest.

![figures/dyf_surf_salinity_AT_year.png](output_jp/figures/dyf_surf_salinity_AT_year.png)

The relationship with salinity is highly significant: 
<!-- cat(sprintf("%.3f + salinity x %.3f (P = %.3f)", int_dyf, slo_dyf, tab_dyf_surf_salinity_AT[8,3])) -->
`r int_dyf` + salinity x `r slo_dyf`$ (P = `r tab_dyf_surf_salinity_AT[8,3]`)

```{r DYFAMED AT vs salinity, include=TRUE}
kable(tab_fig_dyf_surf_date_AT)
print(dyf_surf_salinity_AT)
kable(tab_dyf_surf_salinity_AT, caption="")
print(dyf_surf_salinity_AT_year)
kable(tab_dyf_surf_salinity_AT_year, caption="")
```

## Point B

**Statistics on input data are:**

```{r Initialization Point B, include=TRUE, message = FALSE}
z <-  read_delim(
  paste0(path, "data/Data_DIC.csv"),
  delim = ",",
  col_names = TRUE,
  col_types = "ccccdddddddddddcddddddddddddddd",
  na = c("NA", "999999")
  )
#H <- NULL
z <- z %>%
  dplyr::mutate(
    sampling_date = as.POSIXct(sampling_date, format = "%d/%m/%Y"),
    measure_date = as.POSIXct(measure_date, format = "%d/%m/%Y"),
    year = year(sampling_date),
    monthd = month(sampling_date),
    quarter = quarter(sampling_date),
    month = month(sampling_date, label = TRUE, abbr = FALSE),
    #render all variables as.numeric instead of character
    salinity_field = as.numeric(salinity_field),
    # Mercuric chloride correction (Dickson et al. 2007, SOP3a)
    # 100 ul added except between 2019-07-30 and 2020-10-06 when 200 ul were added
    ta_dup = ifelse(sampling_date >= "2019-07-30" & sampling_date <= "2020-10-06", 
                    ta_dup * 1.0004, ta_dup * 1.0002),
    dic_dup = ifelse(sampling_date >= "2019-07-30" & sampling_date <= "2020-10-06", 
                    dic_dup * 1.0004, dic_dup * 1.0002),
    # convert from umol/l to umol/kg
    PO4 = as.numeric(PO4 / (
      rho(S = salinity_field, T = temp_field , P = 0) / 1000
    )),
    SIOH4 = as.numeric(SIOH4 / (
      1000 * rho(S = salinity_field, T = temp_field , P = 0) / 1000
    )),
    temp_lab_eol = as.numeric(temp_lab_eol),
    pH_s_eol_temp_lab = as.numeric(pH_s_eol_temp_lab),
    temp_lab_ptb = as.numeric(temp_lab_ptb),
    pH_s_ptb_temp_lab = as.numeric(pH_s_ptb_temp_lab),
    # qflag_pH_s_eol = as.numeric(qflag_pH_s_eol),
    # qflag_pH_s_ptb = as.numeric(qflag_pH_s_ptb),
    # qflag_ta = as.numeric(qflag_ta),
    # qflag_dic = as.numeric(qflag_dic)
  )

# all flags changed into factors
z <- z %>%
  dplyr::mutate(
    # qflag_taking = as.factor(qflag_taking),
    # qflag_sample = as.factor(qflag_sample),
    # qflag_ta = as.factor(qflag_ta),
    # qflag_dic = as.factor(qflag_dic),
    # qflag_final = as.factor(qflag_final),
    # qflag_pH_s_eol = as.factor(qflag_pH_s_eol),
    # qflag_pH_s_ptb = as.factor(qflag_pH_s_ptb),
    id = row_number(z$sampling_date)
  )

skim(z)

# read POC and PON data
pom <- read_csv(file = paste0(path, "data/POC-PON/POC-2007-2015_PtB_1m.csv"), comment="#")
pom$date <- as.POSIXct(pom$date)
```

```{r Check outliers, include=TRUE}
# "C" means "check"
# Check for outliers at 1 m

# Create qflags salinity_field and temp_field
z <- z %>% 
  dplyr::mutate(qflag_salinity_field = ifelse(!is.na(salinity_field), 2, 3),
                qflag_temp_field = ifelse(!is.na(temp_field), 2, 3))
# Salinity 1 m
CS1_xts <- z %>% 
  dplyr::filter(depth == 0) %>%
  dplyr::select(sampling_date, salinity_field, qflag_salinity_field) %>% 
  dplyr::mutate(salinity_field_q2 = ifelse(qflag_salinity_field == 2, salinity_field, NA),
                salinity_field_q3 = ifelse(qflag_salinity_field == 3, salinity_field, NA)) %>% 
  dplyr::select(-qflag_salinity_field, -salinity_field)
CS1_xts <- as.xts(CS1_xts, order.by = CS1_xts$sampling_date)
dygraph(CS1_xts, group = "pointB", main="Salinity 1 m: remove outliers?", ylab="Salinity") %>%
      dySeries("salinity_field_q2", color = "blue", strokeWidth = 0, label = "flag2") %>%
      dySeries("salinity_field_q3", color = "red", strokeWidth = 0, label = "flag3") %>%
      dyHighlight(highlightCircleSize = 8,highlightSeriesBackgroundAlpha =0.2,hideOnMouseOut =TRUE) %>%
      dyOptions( drawGrid = TRUE, drawPoints = TRUE, pointSize = 2) %>%
    dyLegend(show = "follow")   %>%
      dyRangeSelector(height = 30, dateWindow= NULL)
# Temperature 1 m
CT1_xts <- z %>% 
  dplyr::filter(depth == 0) %>%
  dplyr::select(sampling_date, temp_field, qflag_temp_field) %>% 
  dplyr::mutate(temp_field_q2 = ifelse(qflag_temp_field == 2, temp_field, NA),
                temp_field_q3 = ifelse(qflag_temp_field == 3, temp_field, NA)) %>% 
  dplyr::select(-qflag_temp_field, -temp_field)
CT1_xts <- as.xts(CT1_xts, order.by = CT1_xts$sampling_date)
dygraph(CT1_xts, group = "pointB", main="Temperature 1 m: remove outliers?", ylab="Salinity") %>%
      dySeries("temp_field_q2", color = "blue", strokeWidth = 0, label = "flag2") %>%
      dySeries("temp_field_q3", color = "red", strokeWidth = 0, label = "flag3") %>%
      dyHighlight(highlightCircleSize = 8,highlightSeriesBackgroundAlpha =0.2,hideOnMouseOut =TRUE) %>%
      dyOptions( drawGrid = TRUE, drawPoints = TRUE, pointSize = 2) %>%
    dyLegend(show = "follow")   %>%
      dyRangeSelector(height = 30, dateWindow= NULL)
# AT 1 m
CAT1_xts <- z %>% 
  dplyr::filter(depth == 0) %>%
  dplyr::select(sampling_date, ta_dup, qflag_ta) %>% 
  dplyr::mutate(ta_dup_q2 = ifelse(qflag_ta == 2, ta_dup, NA),
                ta_dup_q3 = ifelse(qflag_ta == 3, ta_dup, NA)) %>% 
  dplyr::select(-qflag_ta, -ta_dup)
CAT1_xts <- as.xts(CAT1_xts, order.by = CAT1_xts$sampling_date)
dygraph(CAT1_xts, group = "pointB", main="AT: remove outliers", ylab="Total alkalinity") %>%
      dySeries("ta_dup_q2", color = "blue", strokeWidth = 0, label = "flag2") %>%
      dySeries("ta_dup_q3", color = "red", strokeWidth = 0, label = "flag3") %>%
      dyHighlight(highlightCircleSize = 8,highlightSeriesBackgroundAlpha =0.2,hideOnMouseOut =TRUE) %>%
      dyOptions( drawGrid = TRUE, drawPoints = TRUE, pointSize = 2) %>%
    dyLegend(show = "follow")   %>%
      dyRangeSelector(height = 30, dateWindow= NULL)
# CT 1 m
CCT1_xts <- z %>% 
  dplyr::filter(depth == 0) %>%
  dplyr::select(sampling_date, dic_dup, qflag_dic) %>% 
  dplyr::mutate(dic_dup_q2 = ifelse(qflag_dic == 2, dic_dup, NA),
                dic_dup_q3 = ifelse(qflag_dic == 3, dic_dup, NA)) %>% 
  dplyr::select(-qflag_dic, -dic_dup)
CCT1_xts <- as.xts(CCT1_xts, order.by = CCT1_xts$sampling_date)
dygraph(CCT1_xts, group = "pointB", main="CT: remove outliers", ylab="Dissolved inorganic carbon") %>%
      dySeries("dic_dup_q2", color = "blue", strokeWidth = 0, label = "flag2") %>%
      dySeries("dic_dup_q3", color = "red", strokeWidth = 0, label = "flag3") %>%
      dyHighlight(highlightCircleSize = 8,highlightSeriesBackgroundAlpha =0.2,hideOnMouseOut =TRUE) %>%
      dyOptions( drawGrid = TRUE, drawPoints = TRUE, pointSize = 2) %>%
    dyLegend(show = "follow")   %>%
      dyRangeSelector(height = 30, dateWindow= NULL)

# Salinity 50 m
CS50_xts <- z %>% 
  dplyr::filter(depth == 50) %>%
  dplyr::select(sampling_date, salinity_field, qflag_salinity_field) %>% 
  dplyr::mutate(salinity_field_q2 = ifelse(qflag_salinity_field == 2, salinity_field, NA),
                salinity_field_q3 = ifelse(qflag_salinity_field == 3, salinity_field, NA)) %>% 
  dplyr::select(-qflag_salinity_field, -salinity_field)
CS50_xts <- as.xts(CS50_xts, order.by = CS50_xts$sampling_date)
dygraph(CS50_xts, group = "pointB", main="Salinity 50 m: remove outliers", ylab="Salinity") %>%
      dySeries("salinity_field_q2", color = "blue", strokeWidth = 0, label = "flag2") %>%
      dySeries("salinity_field_q3", color = "red", strokeWidth = 0, label = "flag3") %>%
      dyHighlight(highlightCircleSize = 8,highlightSeriesBackgroundAlpha =0.2,hideOnMouseOut =TRUE) %>%
      dyOptions( drawGrid = TRUE, drawPoints = TRUE, pointSize = 2) %>%
    dyLegend(show = "follow")   %>%
      dyRangeSelector(height = 30, dateWindow= NULL)
# Temperature 50 m
CT1_xts <- z %>% 
  dplyr::filter(depth == 50) %>%
  dplyr::select(sampling_date, temp_field, qflag_temp_field) %>% 
  dplyr::mutate(temp_field_q2 = ifelse(qflag_temp_field == 2, temp_field, NA),
                temp_field_q3 = ifelse(qflag_temp_field == 3, temp_field, NA)) %>% 
  dplyr::select(-qflag_temp_field, -temp_field)
CT1_xts <- as.xts(CT1_xts, order.by = CT1_xts$sampling_date)
dygraph(CT1_xts, group = "pointB", main="Salinity 50 m: remove outliers", ylab="Salinity") %>%
      dySeries("temp_field_q2", color = "blue", strokeWidth = 0, label = "flag2") %>%
      dySeries("temp_field_q3", color = "red", strokeWidth = 0, label = "flag3") %>%
      dyHighlight(highlightCircleSize = 8,highlightSeriesBackgroundAlpha =0.2,hideOnMouseOut =TRUE) %>%
      dyOptions( drawGrid = TRUE, drawPoints = TRUE, pointSize = 2) %>%
    dyLegend(show = "follow")   %>%
      dyRangeSelector(height = 30, dateWindow= NULL)
# AT 50 m
CAT50_xts <- z %>% 
  dplyr::filter(depth == 50) %>%
  dplyr::select(sampling_date, ta_dup, qflag_ta) %>% 
  dplyr::mutate(ta_dup_q2 = ifelse(qflag_ta == 2, ta_dup, NA),
                ta_dup_q3 = ifelse(qflag_ta == 3, ta_dup, NA)) %>% 
  dplyr::select(-qflag_ta, -ta_dup)
CAT50_xts <- as.xts(CAT50_xts, order.by = CAT50_xts$sampling_date)
dygraph(CAT50_xts, group = "pointB", main="AT: remove outliers", ylab="Total alkalinity") %>%
      dySeries("ta_dup_q2", color = "blue", strokeWidth = 0, label = "flag2") %>%
      dySeries("ta_dup_q3", color = "red", strokeWidth = 0, label = "flag3") %>%
      dyHighlight(highlightCircleSize = 8,highlightSeriesBackgroundAlpha =0.2,hideOnMouseOut =TRUE) %>%
      dyOptions( drawGrid = TRUE, drawPoints = TRUE, pointSize = 2) %>%
    dyLegend(show = "follow")   %>%
      dyRangeSelector(height = 30, dateWindow= NULL)
# CT 50 m
CCT50_xts <- z %>% 
  dplyr::filter(depth == 50) %>%
  dplyr::select(sampling_date, dic_dup, qflag_dic) %>% 
  dplyr::mutate(dic_dup_q2 = ifelse(qflag_dic == 2, dic_dup, NA),
                dic_dup_q3 = ifelse(qflag_dic == 3, dic_dup, NA)) %>% 
  dplyr::select(-qflag_dic, -dic_dup)
CCT50_xts <- as.xts(CCT50_xts, order.by = CCT50_xts$sampling_date)
dygraph(CCT50_xts, group = "pointB", main="CT: remove outliers", ylab="Dissolved inorganic carbon") %>%
      dySeries("dic_dup_q2", color = "blue", strokeWidth = 0, label = "flag2") %>%
      dySeries("dic_dup_q3", color = "red", strokeWidth = 0, label = "flag3") %>%
      dyHighlight(highlightCircleSize = 8,highlightSeriesBackgroundAlpha =0.2,hideOnMouseOut =TRUE) %>%
      dyOptions( drawGrid = TRUE, drawPoints = TRUE, pointSize = 2) %>%
    dyLegend(show = "follow")   %>%
      dyRangeSelector(height = 30, dateWindow= NULL)
```

```{r Remove outliers and plot, include=TRUE}
z <- z %>% 
  dplyr::mutate(qflag_ta = case_when(
    (depth == 0 & ta_dup > 2595) ~ 3,
    (depth == 0 & ta_dup < 2400) ~ 3,
    TRUE ~ qflag_ta))
CAT1 <- ggplot(dplyr::filter(z, depth == 0 & !is.na(ta_dup)), aes(x = sampling_date, y = ta_dup, color = as.factor(qflag_ta))) +
  scale_x_datetime(breaks = date_breaks("2 year"), labels = date_format("%Y")) +
  geom_point(na.rm=TRUE, size = 0.6) +
  lims(y = c(2450, 2650)) +
  theme_bw() + 
  scale_colour_manual(values = c("blue", "red")) +
  labs(y = expression(paste(italic(A)[T]," ","(",mu, mol.kg^-1,")")),x="",
       title="Total alkalinity at 1 m, outliers removed",
       color = "flag")
z <- z %>% 
  dplyr::mutate(qflag_dic = case_when(
    (depth == 0 & dic_dup > 2350) ~ 3,
    (depth == 0 & dic_dup > 2270 & year(z$sampling_date) == 2008) ~ 3,
    (depth == 0 & dic_dup > 2300 & year(z$sampling_date) == 2009) ~ 3,
    (depth == 0 & dic_dup > 2300 & year(z$sampling_date) == 2009) ~ 3,
    (depth == 0 & dic_dup < 2223 & year(z$sampling_date) == 2012) ~ 3,
    (depth == 0 & dic_dup > 2310 & year(z$sampling_date) == 2017) ~ 3,
    (depth == 0 & dic_dup < 2230 & year(z$sampling_date) == 2014) ~ 3,
    (depth == 0 & dic_dup < 2210 & year(z$sampling_date) == 2017) ~ 3,
    TRUE ~ qflag_dic))
CCT1 <- ggplot(dplyr::filter(z, depth == 0), aes(x = sampling_date, y = dic_dup, color = as.factor(qflag_dic))) +
  scale_x_datetime(breaks = date_breaks("2 year"), labels = date_format("%Y")) +
  geom_point(na.rm=TRUE, size = 0.6) +
  lims(y = c(2150, 2350)) +
  theme_bw() + 
  scale_colour_manual(values = c("blue", "red")) +
  labs(y = expression(paste(italic(C)[T]," ","(",mu, mol.kg^-1,")")),x="",
       title="Dissolved inorganic carbon at 1 m, outliers removed",
       color = "flag")
z <- z %>% 
  dplyr::mutate(qflag_ta = case_when(
    (depth == 50 & ta_dup < 2520) ~ 3,
    (depth == 50 & ta_dup > 2600) ~ 3,
    (depth == 50 & ta_dup > 2560 & year(z$sampling_date) == 2009) ~ 3,
    (depth == 50 & ta_dup < 2535 & year(z$sampling_date) == 2015) ~ 3,
    TRUE ~ qflag_ta))
CAT50 <- ggplot(dplyr::filter(z, depth == 50), 
                aes(x = sampling_date, y = ta_dup, color = as.factor(qflag_ta))) +
  scale_x_datetime(breaks = date_breaks("2 year"), labels = date_format("%Y")) +
  geom_point(na.rm=TRUE, size = 0.6) +
  theme_bw() + 
  scale_colour_manual(values = c("blue", "red")) +
  labs(y = expression(paste(italic(A)[T]," ","(",mu, mol.kg^-1,")")),x="",
       title="Total alkalinity at 50 m, outliers removed",
       color = "flag")
z <- z %>% 
  dplyr::mutate(qflag_dic = case_when(
    (depth == 50 & dic_dup < 2190) ~ 3,
    (depth == 50 & dic_dup > 2275 &  year(z$sampling_date) == 2008) ~ 3,
    (depth == 50 & dic_dup > 2290 &  year(z$sampling_date) == 2012) ~ 3,
    TRUE ~ qflag_dic))
CCT50 <- ggplot(dplyr::filter(z, depth == 50), 
                aes(x = sampling_date, y = dic_dup, color = as.factor(qflag_dic))) +
  scale_x_datetime(breaks = date_breaks("2 year"), labels = date_format("%Y")) +
  geom_point(na.rm=TRUE, size = 0.6) +
  theme_bw() + 
  scale_colour_manual(values = c("blue", "red")) +
  labs(y = expression(paste(italic(C)[T]," ","(",mu, mol.kg^-1,")")),x="",
       title="Dissolved inorganic carbon at 50 m, outliers removed",
       color = "flag")
p <- CAT1 + CCT1 + CAT50 + CCT50 + plot_layout(ncol = 1, heights = unit(c(5, 5, 5, 5), c('cm', 'cm', 'cm', 'cm')))  +
  plot_layout(guides="collect", heights = c(1, 1, 1, 1)) + 
  plot_annotation(tag_levels = 'A')
ggsave("output_jp/figures/fig_outliers.png", p, width = 18, height = 25, units = "cm")
#combine graphs on one page
# png(file = "output_jp/figures/fig_outliers.png",
#     width = 17, height = 25, units = "cm", res = 300)
# grid.arrange(CAT1, CCT1, CAT50, CCT50, ncol=1)
# dev.off()
```
**After removal of outliers.**
![output_jp/figures/fig_outliers.png](output_jp/figures/fig_outliers.png)
```{r Handle qflags 3, include=FALSE}
# values flagged as 3 set to NA
z <- z %>% 
  dplyr::mutate(salinity_field = ifelse(qflag_salinity_field == 2, salinity_field, NA),
                temp_field = ifelse(qflag_temp_field == 2, temp_field, NA),
                ta_dup = ifelse(qflag_ta == 2, ta_dup, NA),
                dic_dup = ifelse(qflag_dic == 2, dic_dup, NA),
                NO2 = ifelse(qNO2 == 2, NO2, NA),
                NO3 = ifelse(qNO3 == 2, NO3, NA),
                PO4 = ifelse(qPO4 == 2, PO4, NA),
                SIOH4 = ifelse(qSIOH4 == 2, SIOH4, NA),
                pH_s_eol_temp_lab = ifelse(qflag_pH_s_eol == 2, pH_s_eol_temp_lab, NA),
                pH_s_ptb_temp_lab = ifelse(qflag_pH_s_ptb == 3, pH_s_ptb_temp_lab, NA )
  )
```

```{r Calculate means except pH, include=FALSE}
# AT and CT
mean_at_dic <- z %>%
  dplyr::select(sampling_date, depth, ta_dup, qflag_ta, dic_dup, qflag_dic) %>% 
  dplyr::group_by(sampling_date, depth) %>%
  dplyr::mutate(ta = mean(ta_dup, na.rm = TRUE),
                dic = mean(dic_dup, na.rm = TRUE)) %>% 
  dplyr::ungroup() %>% 
  #dplyr::select(sampling_date, depth, ta, dic) %>% 
  dplyr::distinct()
# salinity and temperature field
mean_sal_temp <- z %>%
  dplyr::select(sampling_date, depth, salinity_field, qflag_salinity_field, temp_field,
                qflag_temp_field) %>% 
  dplyr::group_by(sampling_date, depth) %>%
  dplyr::mutate(salinity = mean(salinity_field, na.rm = TRUE),
                temperature = mean(temp_field, na.rm = TRUE)) %>% 
  dplyr::ungroup() %>% 
  dplyr::select(sampling_date, depth, salinity, temperature) %>% 
  dplyr::distinct()
# Chl-a
mean_Chla <- z %>%
  dplyr::select(sampling_date, depth, Chla) %>% 
  dplyr::group_by(sampling_date, depth) %>%
  dplyr::mutate(Chla = mean(Chla, na.rm = TRUE)) %>% 
  dplyr::ungroup() %>% 
  dplyr::select(sampling_date, depth, Chla) %>% 
  dplyr::distinct()
# NO2, NO3, PO4, SIHO4
mean_nuts <- z %>%
  dplyr::select(sampling_date, depth, NO2, qNO2, NO3, qNO3, PO4, qPO4, SIOH4, qSIOH4) %>% 
  dplyr::group_by(sampling_date, depth) %>%
  dplyr::mutate(NO2 = mean(NO2, na.rm = TRUE),
                NO3 = mean(NO3, na.rm = TRUE),
                PO4 = mean(PO4, na.rm = TRUE),
                SIOH4 = mean(SIOH4, na.rm = TRUE)
                ) %>% 
  dplyr::ungroup() %>% 
  dplyr::select(sampling_date, depth, NO2, NO3, PO4, SIOH4) %>% 
  dplyr::distinct()
dat1 <- dplyr::full_join(mean_sal_temp, mean_at_dic)  %>% 
  dplyr::full_join(mean_nuts) %>% 
  dplyr::full_join(mean_Chla) %>% 
  dplyr::distinct()
# Check that there is only one row per date and depth
# zzz <- dat1 %>% filter(depth==50) %>% select(sampling_date, depth) %>% group_by(sampling_date) %>% mutate(n=n()) %>% ungroup() %>% filter(n!=1)
# zzz
```

```{r Calculate and compare spec pH, include=FALSE}
#First, create df with pH variables plus mean ta
tmp <- z %>% 
  dplyr::select(sampling_date, depth, salinity_field, temp_field, contains("eol"), contains("ptb")) %>% 
  dplyr::left_join(dat1, by = c("sampling_date", "depth"))

# set to NA qglags = 3; calculate in situ spec pH at eol
eol <- tmp %>%
  dplyr::select(sampling_date, depth, ta, dic, salinity_field, temp_field, 
                pH_s_eol_temp_lab, temp_lab_eol, PO4, SIOH4) %>%
  tidyr::drop_na(sampling_date, depth, ta, salinity_field, temp_field, 
                pH_s_eol_temp_lab, temp_lab_eol) %>%
  #dplyr::filter(qflag_pH_s_eol != 3) %>% 
  dplyr::mutate(pH_s_eol_temp_insi = pHinsi(pH = pH_s_eol_temp_lab, ALK=ta,
                             Tinsi = temp_field,
                             Tlab =temp_lab_eol,
                             Pinsi = depth/10, S = salinity_field,
                             Pt = 1e-6*PO4, Sit = 1e-6*SIOH4,
                             k1k2 = "l", kf = "pf", ks = "d",
                             pHscale = "T", b = "l10")) %>% 
  dplyr::group_by(sampling_date, depth) %>%
  dplyr::mutate(pH_s_eol_temp_insi = mean(pH_s_eol_temp_insi, na.rm = TRUE)) %>% 
  dplyr::select(-c(pH_s_eol_temp_lab, temp_lab_eol)) %>% # no 
  # longer needed and prevents efficient unique()
  dplyr::ungroup() %>% 
  dplyr::distinct()

# calculate in situ spec pH at Point B
ptb <- tmp %>%
  dplyr::select(sampling_date, depth, ta, dic, salinity_field, temp_field, 
                pH_s_ptb_temp_lab, temp_lab_ptb, PO4, SIOH4) %>%
  tidyr::drop_na(sampling_date, depth, ta, salinity_field, temp_field, 
                pH_s_ptb_temp_lab, temp_lab_ptb) %>%
  #dplyr::filter(qflag_pH_s_ptb != 3) %>% 
  dplyr::mutate(pH_s_ptb_temp_insi = pHinsi(pH=pH_s_ptb_temp_lab, ALK=ta,
                             Tinsi=temp_field,
                             Tlab=temp_lab_ptb,
                             Pinsi=depth/10, S=salinity_field,
                             Pt=1e-6*PO4, Sit=1e-6*SIOH4,
                             k1k2 = "l", kf = "pf", ks="d",
                             pHscale = "T", b="l10")) %>% 
  dplyr::group_by(sampling_date, depth) %>%
  dplyr::mutate(pH_s_ptb_temp_insi = mean(pH_s_ptb_temp_insi, na.rm = TRUE)) %>% 
  dplyr::select(-c(pH_s_ptb_temp_lab, temp_lab_ptb)) %>% # no 
  # longer needed and prevents efficient unique()
  dplyr::ungroup() %>% 
  dplyr::distinct()
# join pH eol and pointB
eol_ptb <- full_join(eol, ptb, by = c("sampling_date", "depth")) %>% 
  dplyr::select(sampling_date, depth, pH_s_eol_temp_insi, pH_s_ptb_temp_insi) %>% 
  dplyr::distinct()

# check outliers
eol_ptb_long <- eol_ptb %>% 
  tidyr::pivot_longer(!c(depth, sampling_date), names_to = "location", values_to = "pH")
CPHa <- ggplot(eol_ptb_long, aes(x = sampling_date, y = pH, colour = location)) +
  scale_x_datetime(breaks = date_breaks("2 year"), labels = date_format("%Y")) +
  geom_point(na.rm=TRUE) +
  theme_bw() + 
  #scale_colour_manual(values = cols) +
  labs(y = "pH (unit)",x="",
       title="",
       color = "") +
  facet_grid(depth ~ .)
CPHa
# Remove outliers and replot
eol_ptb <- eol_ptb %>% 
  dplyr::mutate(qflag_ph_insi = ifelse(depth == 0 & pH_s_ptb_temp_insi < 7.97, 3, 2),
                qflag_ph_insi = ifelse(depth == 50 & (pH_s_ptb_temp_insi < 8.05 |
                                                      pH_s_ptb_temp_insi > 8.15), 3, 2)) %>% 
  dplyr::filter(qflag_ph_insi != 3)
eol_ptb_long <- eol_ptb %>% 
  tidyr::pivot_longer(!c(depth, sampling_date, qflag_ph_insi), names_to = "location", values_to = "pH")
CPHb <- ggplot(eol_ptb_long, aes(x = sampling_date, y = pH, colour = location)) +
  scale_x_datetime(breaks = date_breaks("2 year"), labels = date_format("%Y")) +
  geom_point(na.rm=TRUE) +
  theme_bw() + 
  #scale_colour_manual(values = cols) +
  labs(y = "pH (unit)",x="",
       title="",
       color = "") +
  facet_grid(depth ~ .)
CPHb
# Difference between pH eol and ptb
eol_ptb <- eol_ptb %>% 
  dplyr::mutate(diff_pH = pH_s_eol_temp_insi - pH_s_ptb_temp_insi)
p <- ggplot(data = eol_ptb, aes(diff_pH)) +
  geom_histogram(na.rm = TRUE) +
  geom_vline(xintercept = -0.015) +
  geom_vline(xintercept = 0.015)
print(p)

# calculate mean pH when data are available both at eol and point B and abs(difference) < 0.01
# if not one uses the Point B pH
eol_ptb <- eol_ptb %>% 
  rowwise() %>%
  dplyr::mutate(mean_pH = mean(c(pH_s_eol_temp_insi, pH_s_ptb_temp_insi), na.rm = TRUE)) %>%
  ungroup() %>% 
  dplyr::mutate(pH_insi = dplyr::case_when(
    !is.na(pH_s_eol_temp_insi) & is.na(pH_s_ptb_temp_insi) ~ pH_s_eol_temp_insi,
    !is.na(pH_s_eol_temp_insi) & !is.na(pH_s_ptb_temp_insi)  ~ pH_s_ptb_temp_insi,
    !is.na(pH_s_eol_temp_insi) & !is.na(pH_s_ptb_temp_insi) & abs(eol_ptb$diff_pH) <= 0.015 ~ mean_pH,
    TRUE ~ pH_s_ptb_temp_insi)) %>% 
  dplyr::select(-mean_pH)

# add pH variables to data
# z <- dplyr::left_join(z, eol_ptb, by = c("sampling_date", "depth")) %>% 
#   dplyr::select(-dplyr::contains(c("eol", "ptb", "qflag", "qNO3", "qNO2", "qPO4", "qSIOH4"))) %>% 
#     distinct()
```

pH spec: the mean value is calculated when data are available both at eol and point B and abs(difference) < 0.01. If not one uses the Point B pH.

```{r Calculate means other than ta, dic, pH, include=FALSE}
dat <- dplyr::full_join(dat1, eol_ptb, by = c("sampling_date", "depth")) %>% 
  dplyr::select(-dplyr::contains(c("eol", "ptb", "qflag", "qNO3", "qNO2", "qPO4", "qSIOH4"))) %>% 
    distinct()
# Check that there is only one row per date and depth
#zzz <- dat %>% filter(depth==0) %>% select(sampling_date, depth) %>% group_by(sampling_date) %>% mutate(n=n()) %>% ungroup() %>% filter(n!=1)
#zzz

# also add time variables, and rename nuts
dat <- dat %>%
  group_by(depth, sampling_date) %>%
  dplyr::mutate(
            Pt = ifelse(is.nan(PO4), NA, PO4),
            Sit =ifelse(is.nan(SIOH4), NA, SIOH4) 
            ) %>%
  dplyr::ungroup() %>% 
  dplyr::select(-c(PO4, SIOH4)) %>% 
  dplyr::mutate(
    year = year(sampling_date),
    quarter = quarter(sampling_date),
    monthd = month(sampling_date),
    month = month(sampling_date, label = TRUE, abbr = FALSE),
    week = week(sampling_date)
    ) %>%
    dplyr::arrange(sampling_date) %>% 
  distinct()

# dat0m_full <- dplyr::filter(means_depth, depth==0, year(sampling_date) < cutoff_date)
# dat50m_full <- dplyr::filter(means_depth, depth==50, year(sampling_date) < cutoff_date)
```

```{r Calculate final derived variable and save, include=FALSE}
#select all rows containing NA for one of the 4 key variables
# NArows <-  dat %>%
#   dplyr::ungroup() %>% 
#   dplyr::filter(is.na(salinity & dic & ta & temperature),
#                 is.nan(salinity & dic & ta & temperature)) # rows with NAs or NaNs

#select all rows containing data because the carb function does not work with NAs
# add calculated values
tmp <- dat %>% 
  dplyr::select(sampling_date, depth, salinity, temperature, dic, ta, Pt, Sit) %>% 
  tidyr::drop_na(salinity, temperature, ta, dic)
carb <- seacarb::carb(flag=15, var1=tmp$ta*1e-6, var2=tmp$dic*1e-6,
             S=tmp$salinity, T=tmp$temperature, P=tmp$depth/10,
             Pt=1e-6*tmp$Pt, Sit=1e-6*tmp$Sit, 
             k1k2 = "l", kf = "pf", pHscale = "T", b="l10") %>% 
  tibble()
tmp <- bind_cols(tmp, carb) %>% 
  dplyr::rename(CSC_flag = flag,
                pH_calc = pH) %>% 
  dplyr::select(-c(S, T, DIC, ALK, salinity, temperature, dic, ta, Pt, Sit)) 
dat2 <- left_join(dat, tmp, by = c("sampling_date", "depth")) %>% 
    rename_at( #to remove variable ending with .x and .y following the join
    vars(ends_with(".x")),
    ~str_replace(., "\\..$","")
  ) %>% 
  select_at(
    vars(-ends_with(".y"))
  ) %>% 
  dplyr::mutate(Nta = ta * 38 / salinity,
              Ndic = dic * 38 / salinity)

# Now pH18 (must be distinct to above because NAs are not the same)
tmp <- dat2 %>% 
  dplyr::select(sampling_date, depth, salinity, temperature, pH_calc, ta, Pt, Sit) %>% 
  tidyr::drop_na(salinity, temperature, ta, pH_calc)
pHat18 <- seacarb::pHinsi(pH=tmp$pH_calc,ALK=tmp$ta*1e-6,Tinsi=18,
                            Tlab=tmp$temperature,S=tmp$salinity,
                            Pt=1e-6*tmp$Pt, Sit=1e-6*tmp$Sit,
                            k1k2 = "l",
                            kf = "pf", pHscale = "T")
tmp <- tmp %>% dplyr::mutate(pH18 = pHat18) %>% 
    dplyr::select(sampling_date, depth, pH18)

dat3 <- left_join(dat2, tmp, by = c("sampling_date", "depth"))
dat3 %>% # this is to get rid of NaN; ugly but it works!
  readr::write_csv(path = "output_jp/data/output.csv")
dat <- readr::read_csv(file = "output_jp/data/output.csv", col_names = TRUE, na = c("NA", "NaN"), guess_max = 30000)

#Prepare data to upload to Pangaea 
pangaea <- dplyr::select(dat, sampling_date, depth, CSC_flag, salinity,
                  temperature, HCO3, CO3,
                  pH_insi, ta, dic, OmegaCalcite,
                  OmegaAragonite, pCO2, fCO2) %>%
  dplyr::mutate(depth = replace(depth, depth == 0, 1),
                sampling_date = as.character(dat$sampling_date))

#Prepare SOMLIT data 
somlit <- dat %>% 
  dplyr::select(sampling_date, depth, salinity, temperature, dic, ta, pH_calc, Pt, Sit)
#save data
write_csv(somlit, path = "output_jp/data/output_somlit.csv")
write_csv(dat, path="output_jp/data/output.csv")
write_csv(pangaea, path="output_jp/data/output_pangaea.csv")
write_rds(dat, "output_jp/data/output.rds")
```

```{r Uncertainties, include=FALSE, echo=FALSE}
dat_no_NA <- dat %>% 
  dplyr::filter(!is.na(ta) & !is.na(dic) & !is.na(salinity) & !is.na(temperature))
evar1 <-
  mean(c(3.6, 3.5, 1.2, 1.99, 2.4, 3.0, 3.9, 2.6, 0.5, 2.6, 3.2))*1e-6 #AT, extracted from SNAPO-CO2 reports
evar2 <-
  mean(c(3.2, 3.7, 3.4, 2.25, 2, 2.8, 4.9, 4, 1.5, 2.7, 2))*1e-6 #CT, extracted from SNAPO-CO2 reports

epKstd  <- c(0.002, 0.01,  0.02, 0.01,  0.01, 0.01, 0.01)

tmp <- seacarb::errors(flag = 15, var1 = dat_no_NA$ta*1e-6, var2 = dat_no_NA$dic*1e-6, 
  S = dat_no_NA$salinity, T = dat_no_NA$temperature, P = dat_no_NA$depth/10, Pt = 1e-6*dat_no_NA$Pt, Sit = 1e-6*dat_no_NA$Sit,
  evar1 = evar1, evar2 = evar1, eS = 0.01, eT = 0.1, ePt = 0, eSit = 0,
  epK = epKstd, 
  #method = "ga", r = 0.0, runs = 10000, 
  k1k2 = "l", kf = "pf", pHscale = "T", b = "l10", warn = "y"
  )
mean_err <- tmp %>% summarise_all(mean)

# Calculate the average percent errors for key parameters
mean_err_percent <- data.frame(
  H = mean(100 * mean_err$H / 10^-(dat_no_NA$pH_calc)),
  pCO2 = mean(100 * mean_err$pCO2 / dat_no_NA$pCO2),
  fCO2 = mean(100 * mean_err$fCO2 / dat_no_NA$fCO2),
  OmegaAragonite = mean(100 * mean_err$OmegaAragonite / dat_no_NA$OmegaAragonite),
  OmegaCalcite   = mean(100 * mean_err$OmegaCalcite   / dat_no_NA$OmegaCalcite)
)
```

The average uncertainties of the derived carbonate parameters were calculated according to the Gaussian method (Dickson & Riley, 1978) implemented in the "errors" function of the R package seacarb 3.1 (Gattuso et al., 2016). More detail is available in Orr et al. (sbm). The uncertainties are `r format(mean_err$H, digits =1, scientific = TRUE)` mol H+, `r format(mean_err$pCO2, digits=0)` umol pCO2, and `r format(mean_err$OmegaAragonite, digits=1)` unit of the aragonite saturation state.

```{r Monthly means, include=TRUE, message= FALSE, }
#separate each means_depth and handle last incomplete year
dat0m <- dplyr::filter(dat, depth==0)
dat50m <- dplyr::filter(dat, depth==50)

# prepare data 0m
tmp <- ungroup(dat0m) %>%
  mutate(month = month(sampling_date, label = TRUE, abb = TRUE)) %>%
  select(
  month,
  temperature,
  salinity,
  Chla,
  ta,
  dic,
  pCO2,
  pH_calc,
  OmegaAragonite
  )
tmp$month <- factor(tmp$month)

# TODO Why the following works fine and the next bloc returns NAs?
# dat_month0m <- dat0m %>%
#   group_by(monthd) %>%
#   summarise(ta_sd = sd(ta, na.rm=TRUE))
# dat_month0m

dat_month0m <- dat0m %>%
  group_by(monthd) %>%
  summarise(
  Salinity = mean(salinity, na.rm = TRUE),
  Salinity_sd = sd(salinity, na.rm = TRUE),
  Salinity_n = sum(!is.na(salinity)),
  Temperature = mean(temperature, na.rm = TRUE),
  Temperature_sd = sd(temperature, na.rm = TRUE),
  Temperature_n = sum(!is.na(temperature)),
  Chla = mean(Chla, na.rm = TRUE),
  Chla_sd = sd(Chla, na.rm=TRUE),
  Chla_n = sum(!is.na(Chla)),
  dic = mean(dic, na.rm = TRUE),
  dic_sd = sd(dic, na.rm = TRUE),
  dic_n = sum(!is.na(dic)),
  ta = mean(ta, na.rm = TRUE),
  ta_sd = sd(ta, na.rm = TRUE),
  ta_n = sum(!is.na(ta)),
  pH_calc = mean(pH_calc, na.rm = TRUE),
  pH_calc_sd = sd(pH_calc, na.rm = TRUE),
  pH_calc_n = sum(!is.na(pH_calc)),
  pH18 = mean(pH18, na.rm = TRUE),
  pH18_sd = sd(pH18, na.rm = TRUE),
  pH18_n = sum(!is.na(pH18)),
  pCO2 = mean(pCO2, na.rm = TRUE),
  pCO2_sd = sd(pCO2, na.rm = TRUE),
  pCO2_n = sum(!is.na(pCO2)),
  OmegaCalcite = mean(OmegaCalcite, na.rm = TRUE),
  OmegaCalcite_sd = sd(OmegaCalcite, na.rm = TRUE),
  OmegaCalcite_n = sum(!is.na(OmegaCalcite)),
  OmegaAragonite = mean(OmegaAragonite, na.rm = TRUE),
  OmegaAragonite_sd = sd(OmegaAragonite, na.rm = TRUE),
  OmegaAragonite_n = sum(!is.na(OmegaAragonite))
  )
colnames_dat_month0m <- colnames(dat_month0m) #to restore them in the plot for paper section
dat_month0m$month <-
  month(dat_month0m$monthd, label = TRUE, abbr = FALSE) # month name for table

colnames(dat_month0m) <-
  c(
  "monthd",
  "Salinity",
  "Salinity_sd",
  "Salinity_n",
  "Temperature",
  "Temperature_sd",
  "Temperature_n",
  "Chla",
  "Chla_sd",
  "Chla_n",
  "CT",
  "CT_sd",
  "CT_n",
  "AT",
  "AT_sd",
  "AT_n",
  "pH_calc",
  "pH_calc_sd",
  "pH_calc_n",
  "pHT18",
  "pHT18_sd",
  "pH18_n",
  "pCO2",
  "pCO2_sd",
  "pCO2_n",
  "Oc",
  "Oc_sd",
  "Oc_n",
  "Oa",
  "Oa_sd",
  "Oa_n",
  "Month"
  )

tmp_long <- tmp %>%
  gather(key = variable, value=value, -month, na.rm = TRUE)
  
size_point <- 0.1 # size of data points
T1vp <- ggplot(filter(tmp_long, variable=="temperature"), aes(x = month, y = value, group=month)) +
  #geom_violin(fill='lightblue', alpha=0.5, size=0.2, trim = TRUE) +
  geom_violin(fill='lightblue', alpha=0.5, size=0.2, trim = TRUE, draw_quantiles = c(0.25, 0.5, 0.75)) +
  #geom_boxplot(notch=TRUE, size=0.2, fill="grey50", outlier.color = "blue", outlier.size = 0.3) +
  geom_boxplot(notch=FALSE, size=0.2, fill="transparent", color="transparent", outlier.color = "blue", outlier.size = 0.3) +
  scale_x_discrete(breaks=c("Jan", "", "Mar", "", "May", "", "Jul", "", "Sep", "", "Nov", "")) +
  scale_y_continuous(limits=c(10,32)) +
  labs(title=NULL, x=NULL, y ="T (°C)") +
#  coord_fixed() +
  Mytheme(size_labs = 9) +
  theme(aspect.ratio = 1/2,
        plot.margin = margin(t = -0.5, r = 0.2, b = -0.5, l = 0, unit = "cm"),
        axis.text.x=element_blank())
  #annotation_custom(grob_A)
S1vp <- ggplot(filter(tmp_long, variable=="salinity"), aes(x = month, y = value, group=month)) +
  geom_violin(fill='lightblue', alpha=0.5, size=0.2, trim = TRUE) +
  geom_boxplot(notch=TRUE, size=0.2, fill="grey50", outlier.color = "blue", outlier.size = 0.3) +
  scale_x_discrete(breaks=c("Jan", "", "Mar", "", "May", "", "Jul", "", "Sep", "", "Nov", "")) +
  scale_y_continuous(limits=c(35.5, 39)) +
  labs(title=NULL,x=NULL,y="Salinity") +
#  coord_fixed() +
  Mytheme(size_labs = 9) +
  theme(aspect.ratio = 1/2,
        plot.margin = margin(t = -0.5, r = 0.2, b = -0.2, l = 0, unit = "cm"),
        axis.text.x=element_blank())
  #annotation_custom(grob_B)
AT1vp <- ggplot(filter(tmp_long, variable=="ta"), aes(x = month, y = value, group=month)) +
  geom_violin(fill='lightblue', alpha=0.5, size=0.2, trim = TRUE) +
  geom_boxplot(notch=TRUE, size=0.2, fill="grey50", outlier.color = "blue", outlier.size = 0.3) +
  scale_x_discrete(breaks=c("Jan", "", "Mar", "", "May", "", "Jul", "", "Sep", "", "Nov", "")) +
  labs(title=NULL,x=NULL,y=expression(paste(italic(A)[T], " (",mu, "mol ", kg^-1,")"))) +
#  coord_fixed() +
  Mytheme(size_labs = 9) +
  theme(aspect.ratio = 1/2,
        plot.margin = margin(t = -0.5, r = 0.2, b = -0.2, l = 0, unit = "cm"),
        axis.text.x=element_blank())
  #annotation_custom(grob_C)
CT1vp <- ggplot(filter(tmp_long, variable=="dic"), aes(x = month, y = value, group=month)) +
  geom_violin(fill='lightblue', alpha=0.5, size=0.2, trim = TRUE) +
  geom_boxplot(notch=TRUE, size=0.2, fill="grey50", outlier.color = "blue", outlier.size = 0.3) +
  scale_x_discrete(breaks=c("Jan", "", "Mar", "", "May", "", "Jul", "", "Sep", "", "Nov", "")) +
  labs(title=NULL,x=NULL,y=expression(paste(italic(C)[T], " (",mu, "mol ", kg^-1,")"))) +
#  coord_fixed() +
  Mytheme(size_labs = 9) +
  theme(aspect.ratio = 1/2,
        plot.margin = margin(t = -0.5, r = 0.2, b = -0.2, l = 0, unit = "cm"),
        axis.text.x=element_blank())
  #annotation_custom(grob_D_bl)
pH1vp <- ggplot(filter(tmp_long, variable=="pH_calc"), aes(x = month, y = value, group=month)) +
  geom_violin(fill='lightblue', alpha=0.5, size=0.2, trim = TRUE) +
  geom_boxplot(notch=TRUE, size=0.2, fill="grey50", outlier.color = "blue", outlier.size = 0.3) +
  scale_x_discrete(breaks=c("Jan", "", "Mar", "", "May", "", "Jul", "", "Sep", "", "Nov", "")) +
  labs(title=NULL,x=NULL,y=expression(paste(pH[T],"calculated"))) +
#  coord_fixed() +
  Mytheme(size_labs = 9) +
  theme(aspect.ratio = 1/2,
        plot.margin = margin(t = -0.5, r = 0.2, b = -0.2, l = 0, unit = "cm"),
        axis.text.x=element_blank())
  #annotation_custom(grob_E_bl)
pCO21vp <- ggplot(filter(tmp_long, variable=="pCO2"), aes(x = month, y = value, group=month)) +
  geom_violin(fill='lightblue', alpha=0.5, size=0.2, trim = TRUE) +
  geom_boxplot(notch=TRUE, size=0.2, fill="grey50", outlier.color = "blue", outlier.size = 0.3) +
  scale_x_discrete(breaks=c("Jan", "", "Mar", "", "May", "", "Jul", "", "Sep", "", "Nov", "")) +
  labs(title=NULL,x=NULL,y=expression(paste(pCO[2], " (",mu, "atm)"))) +
#  coord_fixed() +
  Mytheme(size_labs = 9) +
  theme(aspect.ratio = 1/2,
        plot.margin = margin(t = -0.5, r = 0.2, b = -0.5, l = 0, unit = "cm"),
        axis.text.x=element_blank())
  #annotation_custom(grob_F)
Oa1vp <- ggplot(filter(tmp_long, variable=="OmegaAragonite"), aes(x = month, y = value, group=month)) +
  geom_violin(fill='lightblue', alpha=0.5, size=0.2, trim = TRUE) +
  geom_boxplot(notch=TRUE, size=0.2, fill="grey50", outlier.color = "blue", outlier.size = 0.3) +
  scale_x_discrete(breaks=c("Jan", "", "Mar", "", "May", "", "Jul", "", "Sep", "", "Nov", "")) +
  labs(title=NULL,x=NULL,y=expression(paste(Omega[a]))) +
#  coord_fixed() +
  Mytheme(size_labs = 9) +
  theme(aspect.ratio = 1/2,
        plot.margin = margin(t = 0, r = 0.2, b = 0.3, l = 0, unit = "cm"))
  #annotation_custom(grob_G)

g <- T1vp + S1vp + AT1vp + CT1vp + pH1vp + pCO21vp + Oa1vp + 
  patchwork::plot_layout(ncol = 1, heights = unit(c(5, 5, 5, 5, 5, 5, 5), c('cm', 'cm', 'cm', 'cm', 'cm', 'cm', 'cm')))  +
  patchwork::plot_layout(guides="collect", heights = c(1, 1, 1, 1, 1, 1, 1))
ggsave("output_jp/figures/fig4.pdf", g, width = 8, height = 28, units = "cm")

g <- T1vp + S1vp + AT1vp + CT1vp + pH1vp + pCO21vp + Oa1vp + 
  patchwork::plot_layout(ncol = 2, heights = unit(c(5, 5, 5, 5, 5, 5, 5), c('cm', 'cm', 'cm', 'cm', 'cm', 'cm', 'cm')))  +
  patchwork::plot_layout(guides="collect", heights = c(1, 1, 1, 1, 1, 1, 1))
ggsave("output_jp/figures/fig_paper_monthly_means_1m.png", g, width = 20, height = 20, units = "cm")


# g <- plot_grid(T1vp, S1vp, AT1vp, CT1vp, pH1vp, pCO21vp, Oa1vp, ncol=1,
#                align="v")
# ggsave(file="output_jp/figures/fig4.pdf", g,  width = 8, height = 28, units = "cm")
# g <- plot_grid(T1vp, S1vp, AT1vp, CT1vp, pH1vp, pCO21vp, Oa1vp, ncol=2)
# ggsave(file="output_jp/figures/fig_paper_monthly_means_1m.png", g, width = 18, height = 14, units = "cm")

# prepare data 50m
tmp <- ungroup(dat50m) %>%
  mutate(month = month(sampling_date, label = TRUE, abb = TRUE)) %>%
  select(
  month,
  temperature,
  salinity,
  Chla,
  ta,
  dic,
  pCO2,
  pH_calc,
  OmegaAragonite
  )
tmp$month <- factor(tmp$month)

dat_month50m <- dat50m %>%
  group_by(monthd) %>%
  summarise(
  Salinity = mean(salinity, na.rm = TRUE),
  Salinity_sd = sd(salinity, na.rm = TRUE),
  Salinity_n = sum(!is.na(salinity)),
  Temperature = mean(temperature, na.rm = TRUE),
  Temperature_sd = sd(temperature, na.rm = TRUE),
  Temperature_n = sum(!is.na(temperature)),
  Chla = mean(Chla, na.rm = TRUE),
  Chla_sd = sd(Chla, na.rm=TRUE),
  Chla_n = sum(!is.na(Chla)),
  dic = mean(dic, na.rm = TRUE),
  dic_sd = sd(dic, na.rm = TRUE),
  dic_n = sum(!is.na(dic)),
  ta = mean(ta, na.rm = TRUE),
  ta_sd = sd(ta, na.rm = TRUE),
  ta_n = sum(!is.na(ta)),
  pH_calc = mean(pH_calc, na.rm = TRUE),
  pH_calc_sd = sd(pH_calc, na.rm = TRUE),
  pH_calc_n = sum(!is.na(pH_calc)),
  pH18 = mean(pH18, na.rm = TRUE),
  pH18_sd = sd(pH18, na.rm = TRUE),
  pH18_n = sum(!is.na(pH18)),
  pCO2 = mean(pCO2, na.rm = TRUE),
  pCO2_sd = sd(pCO2, na.rm = TRUE),
  pCO2_n = sum(!is.na(pCO2)),
  OmegaCalcite = mean(OmegaCalcite, na.rm = TRUE),
  OmegaCalcite_sd = sd(OmegaCalcite, na.rm = TRUE),
  OmegaCalcite_n = sum(!is.na(OmegaCalcite)),
  OmegaAragonite = mean(OmegaAragonite, na.rm = TRUE),
  OmegaAragonite_sd = sd(OmegaAragonite, na.rm = TRUE),
  OmegaAragonite_n = sum(!is.na(OmegaAragonite))
  )
colnames_dat_month50m <- colnames(dat_month50m) #to restore them in the plot for paper section
dat_month50m$month <-
  month(dat_month50m$monthd, label = TRUE, abbr = FALSE) # month name for table

colnames(dat_month50m) <-
  c(
  "monthd",
  "Salinity",
  "Salinity_sd",
  "Salinity_n",
  "Temperature",
  "Temperature_sd",
  "Temperature_n",
  "Chla",
  "Chla_sd",
  "Chla_n",
  "CT",
  "CT_sd",
  "CT_n",
  "AT",
  "AT_sd",
  "AT_n",
  "pHT",
  "pHT_sd",
  "pH_n",
  "pHT18",
  "pHT18_sd",
  "pH18_n",
  "pCO2",
  "pCO2_sd",
  "pCO2_n",
  "Oc",
  "Oc_sd",
  "Oc_n",
  "Oa",
  "Oa_sd",
  "Oa_n",
  "Month"
  )
```

## Monthly means at the surface
![fig_paper_monthly_means_1m.png](output_jp/figures/fig_paper_monthly_means_1m.png)

```{r table monthly means}
# TODO make month column the first and do not display monthd
kable(dat_month0m, digits = 3, caption="Monthly means at the surface")
kable(dat_month50m, digits = 3, caption="Monthly means at 50 m")
```

## Interannual changes
TODO: calculate slopes as suggested by JOI.

```{r Figure Interannual changes and anomalies at 1 m, include=FALSE}
#TODO calculate slopes as suggested by JOI.
size_point <- 0.2 # size of data points

# Plot interannual changes
T1p <- ggplot(dat0m, aes(x = sampling_date, y = temperature), na.rm=TRUE) +
  scale_x_datetime(date_breaks="4 year", date_minor_breaks="1 years", labels = date_format("%Y")) +
  geom_point(colour="black", na.rm=TRUE, size=size_point) + 
  #geom_smooth(method=lm, colour="black", fill="grey", size=0.6, na.rm=TRUE) +
  labs(title=NULL,x="", y="Temp. (°C)") +
  coord_fixed() +
  Mytheme(size_labs = 8) +
  theme(axis.text.x=element_blank())
  #annotation_custom(grob_A_bl)
S1p <- ggplot(dat0m, aes(x = sampling_date, y = salinity), na.rm=TRUE) +
  scale_x_datetime(date_breaks="4 year", date_minor_breaks="1 years", labels = date_format("%Y")) +
    scale_y_continuous(limits=c(35.5, 39), breaks=c(36,37,38)) +
  geom_point(colour="black", na.rm=TRUE, size=size_point) + 
  #geom_smooth(method=lm, colour="black", fill="grey", size=0.6, na.rm=TRUE) +
  labs(title=NULL,x="", y="Salinity") +
  coord_fixed() +
  Mytheme(size_labs = 8) +
  theme(axis.text.x=element_blank())
  #annotation_custom(grob_B_bl)
CT1p <- ggplot(dat0m, aes(x = sampling_date, y = dic), na.rm=TRUE) +
  scale_x_datetime(date_breaks="4 year", date_minor_breaks="1 years", labels = date_format("%Y")) +
  geom_point(colour="black", na.rm=TRUE, size=size_point) + 
  #geom_smooth(method=lm, colour="black", fill="grey", size=0.6, na.rm=TRUE) +
  labs(title=NULL,x="",y=expression(paste(italic(C)[T], " (",mu, "mol ", kg^-1,")"))) +
  #annotate("text", x =as.POSIXct("2016-01-01"), y= min(dat0m$dic, na.rm=TRUE), 
  #         label="*", colour="blue", size=10, fontface="plain") +
  coord_fixed() +
  Mytheme(size_labs = 8) +
  theme(axis.text.x=element_blank())
  #annotation_custom(grob_D_bl)
AT1p <- ggplot(dat0m, aes(x = sampling_date, y = ta), na.rm=TRUE) +
  scale_x_datetime(date_breaks="4 year", date_minor_breaks="1 years", labels = date_format("%Y")) +
  geom_point(colour="black", na.rm=TRUE, size=size_point) + 
  #geom_smooth(method=lm, colour="black", fill="grey", size=0.6, na.rm=TRUE) +
  labs(title=NULL,x="",y=expression(paste(italic(A)[T], " (",mu, "mol ", kg^-1,")"))) +
  #annotate("text", x =as.POSIXct("2016-01-01"), y= min(dat0m$ta, na.rm=TRUE), 
  #         label="*", colour="blue", size=9, fontface="plain") +
  coord_fixed() +
  Mytheme(size_labs = 8) +
  theme(axis.text.x=element_blank())
  #annotation_custom(grob_C_bl)
pH1p <- ggplot(dat0m, aes(x = sampling_date, y = pH_calc), na.rm=TRUE) +
  scale_x_datetime(date_breaks="4 year", date_minor_breaks="1 years", labels = date_format("%Y")) +
  geom_point(colour="black", na.rm=TRUE, size=size_point) + 
  geom_point(data=dat0m, aes(x = sampling_date, y = pH_calc), color= "blue", size=size_point) +
  #geom_point(data=dat0m, aes(x = sampling_date, y = mean_pH_s_ptb_temp_insi), color ="red", size=1) +
  #geom_smooth(method=lm, colour="black", fill="grey", size=0.6, na.rm=TRUE) +
 labs(title=NULL, x="", y=expression(paste(pH[T]," calculated"))) +
  coord_fixed() +
  Mytheme(size_labs = 8) #+
  #theme(axis.text.x=element_blank())
  #annotation_custom(grob_E_bl)
pCO21p <- ggplot(dat0m, aes(x = sampling_date, y = pCO2), na.rm=TRUE) +
  scale_x_datetime(date_breaks="4 year", date_minor_breaks="1 years", labels = date_format("%Y")) +
  geom_point(colour="black", na.rm=TRUE, size=size_point) + 
  #geom_smooth(method=lm, colour="black", fill="grey", size=0.6, na.rm=TRUE) +
  labs(title=NULL,x="",y=expression(paste(pCO[2], " (",mu, "atm)"))) +
  #annotate("text", x =as.POSIXct("2016-01-01"), y= min(dat0m$mean_pCO2, na.rm=TRUE), 
  #         label="*", colour="blue", size=9, fontface="plain") +
  coord_fixed() +
  Mytheme(size_labs = 8) +
  theme(axis.text.x=element_blank())
  #annotation_custom(grob_F_bl)
Oa1p <- ggplot(dat0m, aes(x = sampling_date, y = OmegaAragonite), na.rm=TRUE) +
  scale_x_datetime(date_breaks="4 year", date_minor_breaks="1 years", labels = date_format("%Y")) +
  geom_point(colour="black", na.rm=TRUE, size=size_point) + 
  geom_smooth(method=lm, colour="black", fill="grey", size=0.6, na.rm=TRUE) +
  labs(title=NULL,x="",y=expression(paste(Omega[a]))) +
  coord_fixed() +
  Mytheme(size_labs = 8)
  #annotation_custom(grob_G_bl)
ATvsCT1p <- ggplot(dat0m, aes(x = sampling_date, y = ta/dic), na.rm=TRUE) +
  scale_x_datetime(date_breaks="4 year", date_minor_breaks="1 years", labels = date_format("%Y")) +
  geom_point(colour="#482173FF", na.rm=TRUE, size=size_point) +
  geom_smooth(method=lm, colour="black", fill="grey", size=0.6, na.rm=TRUE) +
  labs(title=NULL,x="",y=expression(paste(A[T]:C[T]))) +
  annotate("text", x = as.POSIXct("2008-01-01"), 
           y = max(dat0m$ta/dat0m$dic, na.rm=TRUE), 
           label = lm_eqn(lm(ta/dic ~sampling_date, data=dat0m)), parse = TRUE) +
  coord_fixed() +
  Mytheme(size_labs = 8)
ggsave(filename = "output_jp/figures/ATvsCT1p.png", plot = ATvsCT1p)

# Calculate anomalies
# At 1 m
# Calculate monthly means
tmp <- ungroup(dat0m) %>%
  group_by(monthd) %>%
  summarise(
  Salinity_month = mean(salinity, na.rm = TRUE),
  Temperature_month = mean(temperature, na.rm = TRUE),
  dic_month = mean(dic, na.rm = TRUE),
  ta_month = mean(ta, na.rm = TRUE),
  pH_calc_month = mean(pH_calc, na.rm = TRUE),
  pH18_month = mean(pH18, na.rm = TRUE),
  pCO2_month = mean(pCO2, na.rm = TRUE),
  OmegaCalcite_month = mean(OmegaCalcite, na.rm = TRUE),
  OmegaAragonite_month = mean(OmegaAragonite, na.rm = TRUE),
  Nta_month = mean(Nta, na.rm = TRUE),
  Ndic_month = mean(dic, na.rm = TRUE)
  )
# Calculate anomalies
ano_month0m <- left_join(ungroup(dat0m), tmp, by = "monthd") %>%
  mutate(
  Salinity_ano = salinity - Salinity_month,
  Temperature_ano = temperature - Temperature_month,
  dic_ano = dic - dic_month,
  ta_ano = ta - ta_month,
  pH_calc_ano = pH_calc - pH_calc_month,
  pH18_ano = pH18 - pH18_month,
  pCO2_ano = pCO2 - pCO2_month,
  OmegaCalcite_ano = OmegaCalcite - OmegaCalcite_month,
  OmegaAragonite_ano = OmegaAragonite - OmegaAragonite_month,
  Nta_ano = Nta - Nta_month,
  Ndic_ano = dic - Ndic_month
  )

# Regressions and tables of key parameters
var_list <-
  c(
  "salinity",
  "temperature",
  "dic",
  "ta",
  "pH_calc",
  "pH18",
  "pCO2",
  "OmegaCalcite",
  "OmegaAragonite",
  "Nta",
  "Ndic"
  )
# lm.test <- vector("list", length(var_list))
# 
# for(i in seq_along(var_list)){
#     lm.test[[i]] <- lm(reformulate(var_list[i], "sampling_date"), data = ano_month0m)
# }

lms <- lapply(var_list, function(x) {
  summary(lm(substitute(i ~ decimal_date(sampling_date), list(i = as.name(x))), 
             data = dplyr::filter(ano_month0m, sampling_date < cutoff_date)))
  })
reg <- NULL
for (i in 1:length(var_list)) {
  #one loops through all anomalies
  # calculate probability of fstatistic because it cannot be extracted from lms above
  # see http://stats.stackexchange.com/questions/92824/extracting-the-model-p-value-for-a-multiple-regression-in-r
  # slope returned by lm is per second
  prob <- pf(lms[[i]]$fstatistic[1],
  lms[[i]]$fstatistic[2],
  lms[[i]]$fstatistic[3],
  lower.tail = FALSE)
  reg <- rbind(reg, as.numeric(c(
    lms[[i]]$coefficients[2, 1],
    lms[[i]]$coefficients[2, 2],
    lms[[i]]$coefficients[2, 4],
  lms[[i]]$coefficients[1, 1],
  lms[[i]]$coefficients[1, 2],
  lms[[i]]$coefficients[1, 4],
  lms[[i]]$fstatistic[1],
  lms[[i]]$fstatistic[3],
  lms[[i]]$r.squared,
  prob
  )
  ))
}
colnames(reg) <-
  c("Slope",
  "SE Slope",
  "P Slope",
  "Intercept",
  "SE int.",
  "P int.",
  "F",
  "df",
  "R2",
  "P value")
row.names(reg) <- var_list
reg_var_1m <- reg
slope_ta <- reg_var_1m[4,1]
intercept_ta <- reg_var_1m[4,4]

# Regression and table anomalies
var_list <-
  c(
  "Salinity_ano",
  "Temperature_ano",
  "dic_ano",
  "ta_ano",
  "pH_calc_ano",
  "pH18_ano",
  "pCO2_ano",
  "OmegaCalcite_ano",
  "OmegaAragonite_ano",
  "Nta_ano",
  "Ndic_ano"
  )
lms <- lapply(var_list, function(x) {
  summary(lm(substitute(i ~ decimal_date(sampling_date), list(i = as.name(x))), data = ano_month0m))
  })
reg <- NULL
for (i in 1:length(var_list)) {
  #one loops through all anomalies
  # calculate probability of fstatistic because it cannot be extracted from lms above
  # see http://stats.stackexchange.com/questions/92824/extracting-the-model-p-value-for-a-multiple-regression-in-r
  # slope returned by lm is per second
prob <-
  pf(lms[[i]]$fstatistic[1],
  lms[[i]]$fstatistic[2],
  lms[[i]]$fstatistic[3],
  lower.tail = FALSE)
reg <-
  rbind(reg, as.numeric(
  c(
  lms[[i]]$coefficients[2, 1],
  lms[[i]]$coefficients[2, 2],
  lms[[i]]$coefficients[2, 4],
  lms[[i]]$coefficients[1, 1],
  lms[[i]]$coefficients[1, 2],
  lms[[i]]$coefficients[1, 4],
  lms[[i]]$fstatistic[1],
  lms[[i]]$fstatistic[3],
  lms[[i]]$r.squared,
  prob
  )
  ))
}
colnames(reg) <-
  c("Slope",
  "SE Slope",
  "P Slope",
  "Intercept",
  "SE int.",
  "P int.",
  "F",
  "df",
  "R2",
  "P value")
row.names(reg) <- var_list
reg_ano_1m <- reg
slope_temp <- reg_ano_1m[2, 1]
slope_pH <- reg_ano_1m[7, 1]

# Plot anomalies
#Anomalies 1 m
anT1p <- ggplot(data = ano_month0m, aes(x = sampling_date, y = Temperature_ano), na.rm=TRUE) +
  scale_x_datetime(date_breaks="4 year", date_minor_breaks="1 years", labels = date_format("%Y")) +
  geom_point(colour="blue", na.rm=TRUE, size=size_point) + 
  geom_smooth(method=lm, colour="black", fill="grey", size=0.6, na.rm=TRUE) +
  labs(title=NULL,x="", y="Temp. (°C)") +
  annotate("text", x =as.POSIXct("2016-01-01"), y= min(ano_month0m$Temperature_ano, na.rm=TRUE), 
           label="", colour="black", size=9, fontface="plain") +
  coord_fixed() +
  Mytheme(size_labs = 8) +
  theme(axis.text.x=element_blank())
  #annotation_custom(grob_H_bl)
anS1p <- ggplot(data = ano_month0m, aes(x = sampling_date, y = Salinity_ano), na.rm=TRUE) +
  scale_x_datetime(date_breaks="4 year", date_minor_breaks="1 years", labels = date_format("%Y")) +
  scale_y_continuous(breaks=c(-2,-1,0,0.5)) +
  geom_point(colour="blue", na.rm=TRUE, size=size_point) + 
  geom_smooth(method=lm, colour="black", fill="grey", size=0.6, na.rm=TRUE) +
  labs(title=NULL,x="", y="Salinity") +
  coord_fixed() +
  Mytheme(size_labs = 8) +
  theme(axis.text.x=element_blank())
  #annotation_custom(grob_I_bl)
anCT1p <- ggplot(data = ano_month0m, aes(x = sampling_date, y = dic_ano), na.rm=TRUE) +
  scale_x_datetime(date_breaks="4 year", date_minor_breaks="1 years", labels = date_format("%Y")) +
  geom_point(colour="blue", na.rm=TRUE, size=size_point) + 
  geom_smooth(method=lm, colour="black", fill="grey", size=0.6, na.rm=TRUE) +
  labs(title=NULL,x="", y=expression(paste(italic(C)[T], " (",mu, "mol ", kg^-1,")"))) +
  annotate("text", x =as.POSIXct("2016-01-01"), y= min(ano_month0m$dic_ano, na.rm=TRUE), 
           label="", colour="black", size=9, fontface="plain") +
  coord_fixed() +
  Mytheme(size_labs = 8) +
  theme(axis.text.x=element_blank())
  #annotation_custom(grob_K_bl)
anAT1p <- ggplot(data = ano_month0m, aes(x = sampling_date, y = ta_ano), na.rm=TRUE) +
  scale_x_datetime(date_breaks="4 year", date_minor_breaks="1 years", labels = date_format("%Y")) +
  geom_point(colour="blue", na.rm=TRUE, size=size_point) + 
  geom_smooth(method=lm, colour="black", fill="grey", size=0.6, na.rm=TRUE) +
  labs(title=NULL,x="", y=expression(paste(italic(A)[T], " (",mu, "mol ", kg^-1,")"))) +
  theme(axis.text.x=element_blank()) +
  annotate("text", x =as.POSIXct("2016-01-01"), y= min(ano_month0m$ta_ano, na.rm=TRUE), 
           label="", colour="black", size=9, fontface="plain") +
  coord_fixed() +
  Mytheme(size_labs = 8) +
  theme(axis.text.x=element_blank())
  #annotation_custom(grob_J_bl)
anpH1p <- ggplot(data = ano_month0m, aes(x = sampling_date, y = pH_calc_ano), na.rm=TRUE) +
  scale_x_datetime(date_breaks="4 year", date_minor_breaks="1 years", labels = date_format("%Y")) +
  geom_point(colour="blue", na.rm=TRUE, size=size_point) + 
  geom_smooth(method=lm, colour="black", fill="grey", size=0.6, na.rm=TRUE) +
 labs(title=NULL, x="", y=expression(paste(pH[T]," calculated"))) +
  annotate("text", x =as.POSIXct("2016-01-01"), y= min(ano_month0m$pH_ano, na.rm=TRUE), 
           label="", colour="black", size=9, fontface="plain") +
  coord_fixed() +
  Mytheme(size_labs = 8) +
  theme(axis.text.x=element_blank())
  #annotation_custom(grob_L_bl)
anpCO21p <- ggplot(data = ano_month0m, aes(x = sampling_date, y = pCO2_ano), na.rm=TRUE) +
  scale_x_datetime(date_breaks="4 year", date_minor_breaks="1 years", labels = date_format("%Y")) +
   geom_point(colour="blue", na.rm=TRUE, size=size_point) + 
  geom_smooth(method=lm, colour="black", fill="grey", size=0.6, na.rm=TRUE) +
 labs(title=NULL,x="",y=expression(paste(pCO[2], " (",mu, "atm)"))) +
  annotate("text", x =as.POSIXct("2016-01-01"), y= min(ano_month0m$pCO2_ano, na.rm=TRUE), 
           label="", colour="black", size=9, fontface="plain") +
  coord_fixed() +
  Mytheme(size_labs = 8) +
  theme(axis.text.x=element_blank())
  #annotation_custom(grob_M_bl)
anOa1p <- ggplot(data = ano_month0m, aes(x = sampling_date, y = OmegaAragonite_ano), na.rm=TRUE) +
  scale_x_datetime(date_breaks="4 year", date_minor_breaks="1 years", labels = date_format("%Y")) +
  scale_y_continuous(breaks=c(-0.2,0,0.2)) +
  geom_point(colour="blue", na.rm=TRUE, size=size_point) + 
  geom_smooth(method=lm, colour="black", fill="grey", size=0.6, na.rm=TRUE) +
  labs(title=NULL,x="",y=expression(paste(Omega[a]))) +
  annotate("text", x =as.POSIXct("2016-01-01"), y= min(ano_month0m$OmegaAragonite_ano, na.rm=TRUE), 
           label="", colour="black", size=9, fontface="plain") +
  coord_fixed() +
  Mytheme(size_labs = 8)
  #annotation_custom(grob_N_bl)

g <- T1p + anT1p + S1p + anS1p + AT1p + anAT1p + CT1p + anCT1p + pH1p + anpH1p + pCO21p + anpCO21p + Oa1p + anOa1p + 
  patchwork::plot_layout(ncol = 2, guides="collect")
ggsave("output_jp/figures/fig_paper_interannual_1m.png", g, width=15, height = 17, units = "cm")

# g <- plot_grid(T1p, anT1p, S1p, anS1p, AT1p, anAT1p, CT1p, anCT1p, pH1p, anpH1p, pCO21p, anpCO21p, Oa1p, anOa1p, align='vh', ncol=2)
# ggsave(file="output_jp/figures/fig_paper_interannual_1m.png", g, width=15, height = 17, units = "cm")
# ggsave(file="output_jp/figures/fig2.pdf", g, width = 18, height = 21, units = "cm")

# AT as a function of salinity for every year
j <- 0
reg <- data.frame()
for (i in 1:(length(unique(dat0m$year))-1)) { #one loops through all years except the last
  j <- j + 1
  yr <- unique(dat0m$year)[i]
  d_reg <- filter(dat0m, year==yr)
#  fm <- as.formula(paste0(i, " ~ sampling_date"))
  #fit[[i]] <- lm(fm, data = dat0m)
  lms <- summary(lm(data=d_reg, ta ~ salinity))
  # calculate probability of fstatistic because it cannot be extracted from lms above
  # see http://stats.stackexchange.com/questions/92824/extracting-the-model-p-value-for-a-multiple-regression-in-r
  # slope returned by lm is per second
  prob <- pf(lms$fstatistic[1],lms$fstatistic[2],lms$fstatistic[3],lower.tail=FALSE)
  reg <- rbind(reg, as.numeric(c(lms$coefficients[2,1], lms$coefficients[2,2], 
                                 lms$coefficients[2,4], lms$coefficients[1,1], lms$coefficients[1,2],
                                 lms$coefficients[1,4], lms$fstatistic[1],   lms$fstatistic[3],
                                 lms$r.squared, prob)))
}
names(reg) <- c("Slope", "SE Slope", "P Slope","Intercept","SE int.","P int.", "F", "df",
                "R2","P value")
row.names(reg) <- as.character(unique(dat0m$year)[-length(unique(dat0m$year))]) # remove last year
#transform in latex table and save
tab_surf_salinity_AT_year <- reg

# POC and PON
pom_l <-pom %>% 
  filter(depth==1 | depth==50) %>%
  select(-q_poc, -q_pon) %>%
  gather(key=pom, value=value, poc, pon)
fig_poc_pon <- ggplot(data = filter(pom_l, depth==1), aes(x = date, y = value), na.rm=TRUE) + 
  geom_point(aes(colour=pom), na.rm=TRUE, size=size_point) +
  scale_x_datetime(breaks = date_breaks("2 year"), labels = date_format("%Y")) +
  labs(title="Point B at 1 m",x="",y="Particulate organic matter") +
  Mytheme()
ggsave(file="output_jp/figures/fig_poc_pon.png", fig_poc_pon, width = 18, height = 20, units = "cm")
```


```{r Removing the effect of changes in AT at 1m, include=FALSE}
#intercept_ta <- 0
first_at <- intercept_ta + decimal_date(dat$sampling_date[1]) * slope_ta # 1st AT value of the time series
dat$ta_no_change <- dat$ta - ((intercept_ta + decimal_date(dat$sampling_date) * slope_ta) - first_at)
p_ta_no_change <- ggplot(data=dat, na.rm=TRUE) +
  geom_point(aes(x=sampling_date, y= ta), col="red") +
  geom_point(aes(x=sampling_date, y= ta_no_change), col="blue")
zzz <- drop_na(dat,ta_no_change, dic, salinity,temperature)
carb_ta_no_change <- carb(flag=15, var1=zzz$ta_no_change*1e-6, var2=zzz$dic*1e-6, S=zzz$salinity,
             T=zzz$temperature, P=zzz$depth/10, Pt=1e-6*zzz$Pt, Sit=1e-6*zzz$Sit, 
             k1k2 = "l", kf = "pf", pHscale = "T", b="l10")
zzz$pH <- carb_ta_no_change$pH
# calculate rate of pH change
# les deux lignes qui suivent ne marchent pas. J'ai dû recourir à ce qui suit.
# JE NE COMPRENDS pas pourquoi.
#zzz_reg <- summary(lm(data=zzz, decimal_date(sampling_date) ~ pH))
#slope_ta_no_change <- zzz_reg$coefficients[2, 1]

var_list <- c("pH_calc")
lms <- lapply(var_list, function(x) {
  summary(lm(substitute(i ~ decimal_date(sampling_date), list(i = as.name(x))), data = zzz))
  })
reg_ta_no_change <- NULL
for (i in 1:length(var_list)) {
  #one loops through all anomalies
  # calculate probability of fstatistic because it cannot be extracted from lms above
  # see http://stats.stackexchange.com/questions/92824/extracting-the-model-p-value-for-a-multiple-regression-in-r
  # slope returned by lm is per second
  prob <- pf(lms[[i]]$fstatistic[1],
  lms[[i]]$fstatistic[2],
  lms[[i]]$fstatistic[3],
  lower.tail = FALSE)
  reg_ta_no_change <- rbind(reg_ta_no_change, as.numeric(c(
    lms[[i]]$coefficients[2, 1],
    lms[[i]]$coefficients[2, 2],
    lms[[i]]$coefficients[2, 4],
  lms[[i]]$coefficients[1, 1],
  lms[[i]]$coefficients[1, 2],
  lms[[i]]$coefficients[1, 4],
  lms[[i]]$fstatistic[1],
  lms[[i]]$fstatistic[3],
  lms[[i]]$r.squared,
  prob
  )
  ))
}
colnames(reg_ta_no_change) <-
  c("Slope",
  "SE Slope",
  "P Slope",
  "Intercept",
  "SE int.",
  "P int.",
  "F",
  "df",
  "R2",
  "P value")
row.names(reg_ta_no_change) <- var_list
```


## Interannual changes at 1 m
![fig_paper_interannual_1m.png](output_jp/figures/fig_paper_interannual_1m.png)
<!-- ![fig_poc_pon.png](output_jp/figures/fig_poc_pon.png) -->
![fig_ta_vs_salinity_month_pointB_0m.png](output_jp/figures/fig_ta_vs_salinity_month_pointB_0m.png)



```{r kable regressions 1 m}
kable(reg_var_1m, digits = c(4,4,3,3,3,2,3), caption="Regressions on values at 1 m depth.")
kable(reg_ano_1m, digits = c(4,4,3,3,3,2,3), caption="Regressions on anomalies at 1 m depth.")  
kable(tab_surf_salinity_AT_year, digits = c(2,2), caption="Regressions AT vs salinity on values at 1 m depth for every year.")
```
Changes at 1 m depth calculated on anomalies are:

* temperature: `r round(reg_ano_1m[2, 1], digits=3)`± `r round(reg_ano_1m[2,2], digits=3)` °C per year. 
* pH: `r 1000*round(reg_ano_1m[5,1], digits=4)` ± `r 1000*round(reg_ano_1m[5,2], digits=4)` mpH units per year.

```{r Figure Interannual changes and anomalies at 50 m, include=FALSE}
size_point <- 0.4 # size of data points

# Plot interannual changes
T50p <- ggplot(dat50m, aes(x = sampling_date, y = temperature), na.rm=TRUE) +
  scale_x_datetime(breaks = date_breaks("2 year"), labels = date_format("%Y")) +
  scale_y_continuous(limits = c(12.5, 22.6)) +
  geom_point(colour="black", na.rm=TRUE, size=size_point) + 
  #geom_smooth(method=lm, colour="black", fill="grey", size=0.6, na.rm=TRUE) +
  labs(title=NULL,x="", y="Temp. (°C)") +
  # annotate("text", x =as.POSIXct("2016-01-01"), y= min(dat50m$temp_field, na.rm=TRUE), 
  #          label="*", colour="blue", size=10, fontface="plain") +
  coord_fixed() +
  Mytheme(size_labs = 8) +
  theme(axis.text.x=element_blank())
  #annotation_custom(grob_A)
S50p <- ggplot(dat50m, aes(x = sampling_date, y = salinity), na.rm=TRUE) +
  scale_x_datetime(breaks = date_breaks("2 year"), labels = date_format("%Y")) +
#    scale_y_continuous(limits=c(37, 39), breaks=c(37,38,39)) +
  geom_point(colour="black", na.rm=TRUE, size=size_point) + 
  #geom_smooth(method=lm, colour="black", fill="grey", size=0.6, na.rm=TRUE) +
  labs(title=NULL,x="",y="Salinity") +
  # annotate("text", x =as.POSIXct("2016-01-01"), y= min(dat50m$mean_salinity, na.rm=TRUE), 
  #          label="*", colour="blue", size=10, fontface="plain") +
  coord_fixed() +
  Mytheme(size_labs = 8) +
  theme(axis.text.x=element_blank())
  #annotation_custom(grob_B)
CT50p <- ggplot(dat50m, aes(x = sampling_date, y = dic), na.rm=TRUE) +
  scale_x_datetime(breaks = date_breaks("2 year"), labels = date_format("%Y")) +
  geom_point(colour="black", na.rm=TRUE, size=size_point) + 
  #geom_smooth(method=lm, colour="black", fill="grey", size=0.6, na.rm=TRUE) +
  labs(title=NULL,x="",y=expression(paste(italic(C)[T], " (",mu, "mol ", kg^-1,")"))) +
  coord_fixed() +
  Mytheme(size_labs = 8) +
  theme(axis.text.x=element_blank())
  #annotation_custom(grob_D)
AT50p <- ggplot(dat50m, aes(x = sampling_date, y = ta), na.rm=TRUE) +
  scale_x_datetime(breaks = date_breaks("2 year"), labels = date_format("%Y")) +
  scale_y_continuous(breaks=c(2530, 2550, 2570)) +
  geom_point(colour="black", na.rm=TRUE, size=size_point) + 
  #geom_smooth(method="loess", span=0.4, se=FALSE, colour="orange") +
  #geom_smooth(method=lm, colour="black", fill="grey", size=0.6, na.rm=TRUE) +
  labs(title=NULL,x="",y=expression(paste(italic(A)[T], " (",mu, "mol ", kg^-1,")"))) +
  coord_fixed() +
  Mytheme(size_labs = 8) +
  theme(axis.text.x=element_blank())
  #annotation_custom(grob_C)
pH50p <- ggplot(dat50m, aes(x = sampling_date, y = pH_calc), na.rm=TRUE) +
  scale_x_datetime(breaks = date_breaks("2 year"), labels = date_format("%Y")) +
  geom_point(colour="black", na.rm=TRUE, size=size_point) + 
  geom_point(data=dat50m, aes(x = sampling_date, y = pH_calc), color ="red", size=size_point) +
  #geom_smooth(method=lm, colour="black", fill="grey", size=0.6, na.rm=TRUE) +
 labs(title=NULL,x="", y=expression(paste(pH[T]," calculated"))) +
  # annotate("text", x =as.POSIXct("2016-01-01"), y= min(dat50m$mean_pH, na.rm=TRUE), 
  #          label="*", colour="blue", size=10, fontface="plain") +
  coord_fixed() +
  Mytheme(size_labs = 8) +
  theme(axis.text.x=element_blank())
  #annotation_custom(grob_E)
pCO250p <- ggplot(dat50m, aes(x = sampling_date, y = pCO2), na.rm=TRUE) +
  scale_x_datetime(breaks = date_breaks("2 year"), labels = date_format("%Y")) +
  geom_point(colour="black", na.rm=TRUE, size=size_point) + 
  #geom_smooth(method=lm, colour="black", fill="grey", size=0.6, na.rm=TRUE) +
  labs(title=NULL,x="",y=expression(paste(pCO[2], " (",mu, "atm)"))) +
  coord_fixed() +
  Mytheme(size_labs = 8) +
  theme(axis.text.x=element_blank())
  #annotation_custom(grob_F)
Oa50p <- ggplot(dat50m, aes(x = sampling_date, y = OmegaAragonite), na.rm=TRUE) +
  scale_x_datetime(breaks = date_breaks("2 year"), labels = date_format("%Y")) +
  geom_point(colour="black", na.rm=TRUE, size=size_point) + 
  #geom_smooth(method=lm, colour="black", fill="grey", size=0.6, na.rm=TRUE) +
  labs(title=NULL,x="",y=expression(paste(Omega[a]))) +
  # annotate("text", x =as.POSIXct("2016-01-01"), y= min(dat50m$mean_OmegaAragonite, na.rm=TRUE), 
  #          label="*", colour="blue", size=10, fontface="plain") +  
  coord_fixed() +
  Mytheme(size_labs = 8)
  #annotation_custom(grob_G)
ATvsCT50p <- ggplot(dat50m, aes(x = sampling_date, y = ta/dic), na.rm=TRUE) +
  scale_x_datetime(breaks = date_breaks("2 year"), labels = date_format("%Y")) +
  geom_point(colour="black", na.rm=TRUE, size=size_point) +
  geom_smooth(method=lm, colour="black", fill="grey", size=0.6, na.rm=TRUE) +
  labs(title=NULL,x="",y=expression(paste(A[T]:C[T]))) +
  coord_fixed() +
  Mytheme(size_labs = 8)
ggsave(filename = "output_jp/figures/ATvsCT50p.png", plot = ATvsCT50p)

# Calculate monthly means
tmp <- ungroup(dat50m) %>%
  group_by(monthd) %>%
  summarise(
  Salinity_month = mean(salinity, na.rm = TRUE),
  Temperature_month = mean(temperature, na.rm = TRUE),
  dic_month = mean(dic, na.rm = TRUE),
  ta_month = mean(ta, na.rm = TRUE),
  pH_calc_month = mean(pH_calc, na.rm = TRUE),
  pH18_month = mean(pH18, na.rm = TRUE),
  pCO2_month = mean(pCO2, na.rm = TRUE),
  OmegaCalcite_month = mean(OmegaCalcite, na.rm = TRUE),
  OmegaAragonite_month = mean(OmegaAragonite, na.rm = TRUE),
  Nta_month = mean(Nta, na.rm = TRUE),
  Ndic_month = mean(dic, na.rm = TRUE)
  )

# Calculate anomalies
ano_month50m <- left_join(ungroup(dat50m), tmp, by = "monthd") %>%
  mutate(
  Salinity_ano = salinity - Salinity_month,
  Temperature_ano = temperature - Temperature_month,
  dic_ano = dic - dic_month,
  ta_ano = ta - ta_month,
  pH_calc_ano = pH_calc - pH_calc_month,
  pH18_ano = pH18 - pH18_month,
  pCO2_ano = pCO2 - pCO2_month,
  OmegaCalcite_ano = OmegaCalcite - OmegaCalcite_month,
  OmegaAragonite_ano = OmegaAragonite - OmegaAragonite_month,
  Nta_ano = Nta - Nta_month,
  Ndic_ano = dic - Ndic_month
  )

# Regressions and tables of key parameters
var_list <-
  c(
  "salinity",
  "temperature",
  "dic",
  "ta",
  "pH_calc",
  "pH18",
  "pCO2",
  "OmegaCalcite",
  "OmegaAragonite",
  "Nta",
  "Ndic"
  )
lms <- lapply(var_list, function(x) {
  summary(lm(substitute(i ~ decimal_date(sampling_date), list(i = as.name(x))), data = ano_month50m))
  })
reg <- NULL
for (i in 1:length(var_list)) {
  #one loops through all anomalies
  # calculate probability of fstatistic because it cannot be extracted from lms above
  # see http://stats.stackexchange.com/questions/92824/extracting-the-model-p-value-for-a-multiple-regression-in-r
  # slope returned by lm is per second
  prob <-
  pf(lms[[i]]$fstatistic[1],
  lms[[i]]$fstatistic[2],
  lms[[i]]$fstatistic[3],
  lower.tail = FALSE)
  reg <-
  rbind(reg, as.numeric(
  c(
    lms[[i]]$coefficients[2, 1],
    lms[[i]]$coefficients[2, 2],
  lms[[i]]$coefficients[2, 4],
  lms[[i]]$coefficients[1, 1],
  lms[[i]]$coefficients[1, 2],
  lms[[i]]$coefficients[1, 4],
  lms[[i]]$fstatistic[1],
  lms[[i]]$fstatistic[3],
  lms[[i]]$r.squared,
  prob
  )
  ))
}
colnames(reg) <-
  c("Slope",
  "SE Slope",
  "P Slope",
  "Intercept",
  "SE int.",
  "P int.",
  "F",
  "df",
  "R2",
  "P value")
row.names(reg) <- var_list
reg_var_50m <- reg


# Regression and table anomalies
var_list <-
  c(
  "Salinity_ano",
  "Temperature_ano",
  "dic_ano",
  "ta_ano",
  "pH_calc_ano",
  "pH18_ano",
  "pCO2_ano",
  "OmegaCalcite_ano",
  "OmegaAragonite_ano",
  "Nta_ano",
  "Ndic_ano"
  )
lms <- lapply(var_list, function(x) {
  summary(lm(substitute(i ~ decimal_date(sampling_date), list(i = as.name(x))), data = ano_month50m))
  })
reg <- NULL
for (i in 1:length(var_list)) {
  #one loops through all anomalies
  # calculate probability of fstatistic because it cannot be extracted from lms above
  # see http://stats.stackexchange.com/questions/92824/extracting-the-model-p-value-for-a-multiple-regression-in-r
  # slope returned by lm is per second
prob <-
  pf(lms[[i]]$fstatistic[1],
  lms[[i]]$fstatistic[2],
  lms[[i]]$fstatistic[3],
  lower.tail = FALSE)
reg <-
  rbind(reg, as.numeric(
  c(
  lms[[i]]$coefficients[2, 1],
  lms[[i]]$coefficients[2, 2],
  lms[[i]]$coefficients[2, 4],
  lms[[i]]$coefficients[1, 1],
  lms[[i]]$coefficients[1, 2],
  lms[[i]]$coefficients[1, 4],
  lms[[i]]$fstatistic[1],
  lms[[i]]$fstatistic[3],
  lms[[i]]$r.squared,
  prob
  )
  ))
}
colnames(reg) <-
  c("Slope",
  "SE Slope",
  "P Slope",
  "Intercept",
  "SE int.",
  "P int.",
  "F",
  "df",
  "R2",
  "P value")
row.names(reg) <- var_list
reg_ano_50m <- reg
reg_ano_50m["Salinity_ano", "P value"]

# Plot anomalies at 50 m
anT50p <- ggplot(data = ano_month50m, aes(x = sampling_date, y = Temperature_ano), na.rm=TRUE) +
  scale_x_datetime(breaks = date_breaks("2 year"), labels = date_format("%Y")) +
  geom_point(colour="blue", na.rm=TRUE, size=size_point) + 
  geom_smooth(method=lm, colour="black", fill="grey", size=0.6, na.rm=TRUE) +
  labs(title=NULL,x="", y="Temp. (°C)") +
  # annotate("text", x =as.POSIXct("2016-01-01"), y= min(ano_month50m$Temperature_ano, na.rm=TRUE), 
  #          label="*", colour="black", size=10, fontface="plain") +
  coord_fixed() +
  Mytheme(size_labs = 8) +
  theme(axis.text.x=element_blank())
  #annotation_custom(grob_H)
anS50p <- ggplot(data = ano_month50m, aes(x = sampling_date, y = Salinity_ano), na.rm=TRUE) +
  scale_x_datetime(breaks = date_breaks("2 year"), labels = date_format("%Y")) +
  #scale_y_continuous(breaks=c(-2,-1,0,0.5)) +
  geom_point(colour="blue", na.rm=TRUE, size=size_point) + 
  geom_smooth(method=lm, colour="black", fill="grey", size=0.6, na.rm=TRUE) +
  labs(title=NULL,x="", y="Salinity") +
  annotate("text", x =as.POSIXct("2016-01-01"), y= min(ano_month50m$Salinity_ano, na.rm=TRUE), label="*", colour="black", size=10, fontface="plain") +
  coord_fixed() +
  Mytheme(size_labs = 8) +
  theme(axis.text.x=element_blank())
  #annotation_custom(grob_I)
anCT50p <- ggplot(data = ano_month50m, aes(x = sampling_date, y = dic_ano), na.rm=TRUE) +
  scale_x_datetime(breaks = date_breaks("2 year"), labels = date_format("%Y")) +
  geom_point(colour="blue", na.rm=TRUE, size=size_point) + 
  geom_smooth(method=lm, colour="black", fill="grey", size=0.6, na.rm=TRUE) +
  labs(title=NULL,x="", y=expression(paste(italic(C)[T], " (",mu, "mol ", kg^-1,")"))) +
  # annotate("text", x =as.POSIXct("2016-01-01"), y= min(ano_month50m$dic_ano, na.rm=TRUE), 
  #          label="*", colour="black", size=10, fontface="plain") +
  coord_fixed() +
  Mytheme(size_labs = 8) +
  theme(axis.text.x=element_blank())
  #annotation_custom(grob_K)
anAT50p <- ggplot(data = ano_month50m, aes(x = sampling_date, y = ta_ano), na.rm=TRUE) +
  scale_x_datetime(breaks = date_breaks("2 year"), labels = date_format("%Y")) +
  scale_y_continuous(breaks=c(-20, 0, 20)) +
  geom_point(colour="blue", na.rm=TRUE, size=size_point) + 
  geom_smooth(method=lm, colour="black", fill="grey", size=0.6, na.rm=TRUE) +
  labs(title=NULL,x="", y=expression(paste(italic(A)[T], " (",mu, "mol ", kg^-1,")"))) +
  #annotate("text", x =as.POSIXct("2016-01-01"), y= min(ano_month50m$ta_ano, na.rm=TRUE), label="*", colour="black", size=10, fontface="plain") +
  theme(axis.text.x=element_blank()) +
  coord_fixed() +
  Mytheme(size_labs = 8) +
  theme(axis.text.x=element_blank())
  #annotation_custom(grob_J)
anpH50p <- ggplot(data = ano_month50m, aes(x = sampling_date, y = pH_calc_ano), na.rm=TRUE) +
  scale_x_datetime(breaks = date_breaks("2 year"), labels = date_format("%Y")) +
  geom_point(colour="blue", na.rm=TRUE, size=size_point) + 
  geom_smooth(method=lm, colour="black", fill="grey", size=0.6, na.rm=TRUE) +
 labs(title=NULL, x="", y=expression(paste(pH[T]," calculated"))) +
  #annotate("text", x =as.POSIXct("2016-01-01"), y= min(ano_month50m$pH_ano, na.rm=TRUE),  label="*", colour="black", size=10, fontface="plain") +
  coord_fixed() +
  Mytheme(size_labs = 8) +
  theme(axis.text.x=element_blank())
  #annotation_custom(grob_L)
anpCO250p <- ggplot(data = ano_month50m, aes(x = sampling_date, y = pCO2_ano), na.rm=TRUE) +
  scale_x_datetime(breaks = date_breaks("2 year"), labels = date_format("%Y")) +
  geom_point(colour="blue", na.rm=TRUE, size=size_point) + 
  geom_smooth(method=lm, colour="black", fill="grey", size=0.6, na.rm=TRUE) +
  labs(title=NULL,x="",y=expression(paste(pCO[2], " (",mu, "atm)"))) +
  #annotate("text", x =as.POSIXct("2016-01-01"), y= min(ano_month50m$pCO2_ano, na.rm=TRUE),  label="*", colour="black", size=10, fontface="plain") +
  coord_fixed() +
  Mytheme(size_labs = 8) +
  theme(axis.text.x=element_blank())
  #annotation_custom(grob_M)
anOa50p <- ggplot(data = ano_month50m, aes(x = sampling_date, y = OmegaAragonite_ano), na.rm=TRUE) +
  scale_x_datetime(breaks = date_breaks("2 year"), labels = date_format("%Y")) +
  scale_y_continuous(breaks=c(-0.2,0,0.2)) +
  geom_point(colour="blue", na.rm=TRUE, size=size_point) + 
  geom_smooth(method=lm, colour="black", fill="grey", size=0.6, na.rm=TRUE) +
  labs(title=NULL,x="",y=expression(paste(Omega[a]))) +
  #annotate("text", x =as.POSIXct("2016-01-01"), y= min(ano_month50m$OmegaAragonite_ano, na.rm=TRUE), label="*", colour="black", size=10, fontface="plain") +
  coord_fixed() +
  Mytheme(size_labs = 8)
  #annotation_custom(grob_N)

g <- plot_grid(T50p, anT50p, S50p, anS50p, AT50p, anAT50p, CT50p, anCT50p, pH50p, anpH50p, pCO250p, anpCO250p, Oa50p, anOa50p, align='vh', ncol=2)
ggsave(file="output_jp/figures/fig_paper_interannual_50m.png", g, width=15, height = 17, units = "cm")
ggsave(file="output_jp/figures/fig3.pdf", g, width = 18, height = 21, units = "cm")
```
## Interannual changes at 50 m
![fig_paper_interannual_50m.png](output_jp/figures/fig_paper_interannual_50m.png)

```{r kable regressions 50 m}
kable(reg_var_50m, digits = c(4,4,3,3,3,2,3), caption="Regressions on values at 50 m depth.")
kable(reg_ano_50m, digits = c(4,4,3,3,3,2,3), caption="Regressions on anomalies at 50 m depth.")
```

## Annual, monthly and quarterly of T, AT and pCO2 at 1m

```{r monthly and quarterly temperature and AT at 1 m, include=FALSE}
dat0m_month <- dat0m %>%
  group_by(year, monthd) %>%
  summarise(salinity = mean(salinity, na.rm=TRUE),
            temperature = mean(temperature, na.rm=TRUE),
            at = mean(ta, na.rm=TRUE),
            pCO2 = mean(pCO2, na.rm=TRUE),
            ct = mean(dic, na.rm=TRUE)) %>%
  mutate(date = ymd(paste(year,monthd,"01")))

fig_temp_month <- ggplot(data=dat0m_month, aes(x=year, y=temperature)) + 
  geom_line(aes(color=as.factor(monthd)), size=1) +
  xlab("Time") + ylab("Temperature") +
  Mytheme() +
  scale_color_viridis(name="Month", discrete=TRUE, option="plasma") + 
  theme(legend.position="top") +
  guides(col = guide_legend(ncol = 12, byrow = TRUE))
ggsave(file="output_jp/figures/fig_temp_month.png", fig_temp_month, width = 15, height = 10, units = "cm")
fig_at_month <- ggplot(data=dat0m_month, aes(x=year, y=at)) + 
  geom_line(aes(color=as.factor(monthd)), size=1) +
  guides(guide_legend(title = "Month")) +
  xlab("Time") + ylab("Total alkalinity") +
  Mytheme() +
  scale_color_viridis(name="Month", discrete=TRUE, option="plasma") + 
  theme(legend.position="top") +
  guides(col = guide_legend(ncol = 12, byrow = TRUE))
ggsave(file="output_jp/figures/fig_at_month.png", fig_at_month, width = 15, height = 10, units = "cm")
fig_pCO2_month <- ggplot(data=dat0m_month, aes(x=year, y=pCO2)) + 
  geom_line(aes(color=as.factor(monthd)), size=1) +
  xlab("Time") + ylab("pCO2") +
  Mytheme() +
  scale_color_viridis(name="Month", discrete=TRUE, option="plasma") + 
  theme(legend.position="top") +
  guides(col = guide_legend(ncol = 12, byrow = TRUE))
ggsave(file="output_jp/figures/fig_pCO2_month.png", fig_pCO2_month, width = 15, height = 10, units = "cm")
fig_ct_month <- ggplot(data=dat0m_month, aes(x=year, y=ct)) + 
  geom_line(aes(color=as.factor(monthd)), size=1) +
  xlab("Time") + ylab("Dissolved inorganic carbon") +
  Mytheme() +
  scale_color_viridis(name="Month", discrete=TRUE, option="plasma") + 
  theme(legend.position="top") +
  guides(col = guide_legend(ncol = 12, byrow = TRUE))
ggsave(file="output_jp/figures/fig_ct_month.png", fig_ct_month, width = 15, height = 10, units = "cm")

# Regressions annual monthly temperature
j <- 0
reg <- data.frame()
for (i in 1:length(unique(dat0m_month$monthd))) { #one loops through all months
  j <- j + 1
  lms <- summary(lm(data=dplyr::filter(dat0m_month, monthd==i), temperature ~ year))
  # calculate probability of fstatistic because it cannot be extracted from lms above
  # see http://stats.stackexchange.com/questions/92824/extracting-the-model-p-value-for-a-multiple-regression-in-r
  # slope returned by lm is per second
  prob <- pf(lms$fstatistic[1],lms$fstatistic[2],lms$fstatistic[3],lower.tail=FALSE)
  reg <- rbind(reg, as.numeric(c(lms$coefficients[2,1], lms$coefficients[2,2], 
                                 lms$coefficients[2,4], lms$coefficients[1,1], lms$coefficients[1,2],
                                 lms$fstatistic[1], lms$fstatistic[3], lms$coefficients[1,4], lms$r.squared, prob)))
}
names(reg) <- c("Slope", "SE Slope", "P Slope","Intercept","SE int.","P int.", "F", "df",
                "R2","P value")
row.names(reg) <- month(ymd(080101) + months(0:11), label = TRUE, abbr = FALSE)
#transform in latex table and save
tab_temp_month <- reg

# Regressions annual monthly AT
j <- 0
reg <- data.frame()
for (i in 1:length(unique(dat0m_month$monthd))) { #one loops through all months
  j <- j + 1
  lms <- summary(lm(data=dplyr::filter(dat0m_month, monthd==i), at ~ year))
  # calculate probability of fstatistic because it cannot be extracted from lms above
  # see http://stats.stackexchange.com/questions/92824/extracting-the-model-p-value-for-a-multiple-regression-in-r
  # slope returned by lm is per second
  prob <- pf(lms$fstatistic[1],lms$fstatistic[2],lms$fstatistic[3],lower.tail=FALSE)
  reg <- rbind(reg, as.numeric(c(lms$coefficients[2,1], lms$coefficients[2,2], 
                                 lms$coefficients[2,4], lms$coefficients[1,1], lms$coefficients[1,2],
                                 lms$fstatistic[1], lms$fstatistic[3], lms$coefficients[1,4], lms$r.squared, prob)))
}
names(reg) <- c("Slope", "SE Slope", "P Slope","Intercept","SE int.","P int.", "F", "df",
                "R2","P value")
row.names(reg) <- month(ymd(080101) + months(0:11), label = TRUE, abbr = FALSE)
#transform in latex table and save
tab_at_month <- reg
# Regressions annual monthly pCO2
j <- 0
reg <- data.frame()
for (i in 1:length(unique(dat0m_month$monthd))) { #one loops through all months
  j <- j + 1
  lms <- summary(lm(data=dplyr::filter(dat0m_month, monthd==i), pCO2 ~ year))
  # calculate probability of fstatistic because it cannot be extracted from lms above
  # see http://stats.stackexchange.com/questions/92824/extracting-the-model-p-value-for-a-multiple-regression-in-r
  # slope returned by lm is per second
  prob <- pf(lms$fstatistic[1],lms$fstatistic[2],lms$fstatistic[3],lower.tail=FALSE)
  reg <- rbind(reg, as.numeric(c(lms$coefficients[2,1], lms$coefficients[2,2], 
                                 lms$coefficients[2,4], lms$coefficients[1,1], lms$coefficients[1,2],
                                 lms$fstatistic[1], lms$fstatistic[3], lms$coefficients[1,4], lms$r.squared, prob)))
}
names(reg) <- c("Slope", "SE Slope", "P Slope","Intercept","SE int.","P int.", "F", "df",
                "R2","P value")
row.names(reg) <- month(ymd(080101) + months(0:11), label = TRUE, abbr = FALSE)
#transform in latex table and save
tab_pCO2_month <- reg
# Regressions annual monthly CT
j <- 0
reg <- data.frame()
for (i in 1:length(unique(dat0m_month$monthd))) { #one loops through all months
  j <- j + 1
  lms <- summary(lm(data=dplyr::filter(dat0m_month, monthd==i), ct ~ year))
  # calculate probability of fstatistic because it cannot be extracted from lms above
  # see http://stats.stackexchange.com/questions/92824/extracting-the-model-p-value-for-a-multiple-regression-in-r
  # slope returned by lm is per second
  prob <- pf(lms$fstatistic[1],lms$fstatistic[2],lms$fstatistic[3],lower.tail=FALSE)
  reg <- rbind(reg, as.numeric(c(lms$coefficients[2,1], lms$coefficients[2,2], 
                                 lms$coefficients[2,4], lms$coefficients[1,1], lms$coefficients[1,2],
                                 lms$fstatistic[1], lms$fstatistic[3], lms$coefficients[1,4], lms$r.squared, prob)))
}
names(reg) <- c("Slope", "SE Slope", "P Slope","Intercept","SE int.","P int.", "F", "df",
                "R2","P value")
row.names(reg) <- month(ymd(080101) + months(0:11), label = TRUE, abbr = FALSE)
#transform in latex table and save
tab_ct_month <- reg

#Plot monthly increases in AT and CT at 1 m
#Prepare dataframe
monthly_rate_AT_CT <- 
  cbind(rename(select(tab_at_month, Slope), AT=Slope),
        rename(select(tab_ct_month, Slope), CT=Slope)
) %>%
  mutate(month=factor(month.abb, as.character(month.abb))) %>%
  gather(key, value, -month) %>%
  mutate(se=c(tab_at_month[,2], tab_ct_month[,2])) %>%
  mutate(p=c(tab_at_month[,3], tab_ct_month[,3])) %>%
  mutate(significance=ifelse(p<=0.05, "*", ""))

# Scatter plot
fig_paper_monthly_rate_AT_CT <- 
  ggplot(data=monthly_rate_AT_CT, group=key) +
  geom_point(aes(x=month, y=value, color=key), size=2, position=position_dodge(0.2)) +
  geom_errorbar(aes(x=month, ymin=value-se, ymax=value+se, color=key), 
                position=position_dodge(0.2), width=0.1) +
  labs(title=NULL, x= NULL, y=expression(paste("Monthly change (",mu, "mol ", kg^-1, " ", yr^-1, ")")),
       colour="") +
  scale_y_continuous(limits = c(-2.5, 7.5), expand=c(0,0)) +
  scale_color_manual(values = c("blue", "#51C56AFF"),
                     labels=c(expression(paste(italic(A)[T])), expression(paste(italic(C)[T])))) +
  geom_text(aes(x=month, y=value, label=significance), nudge_x=0.25, nudge_y=-0.2, size=8) +
  geom_hline(yintercept = 0, size=0.1) +
  Mytheme(size_labs = 9) +
  theme(aspect.ratio=1/2, 
        legend.position = c(1,1),
        legend.justification = c(1,1),
        panel.grid.major.x = element_blank(),
        legend.title = element_blank(),
        legend.key = element_rect(colour = 'white', fill = 'white', size = 0),
        legend.background = element_rect(fill=alpha('white', alpha=0))
        )
ggsave(file="output_jp/figures/fig_paper_monthly_rate_AT_CT.png", fig_paper_monthly_rate_AT_CT, width = 8, height = 8*2/3, units = "cm")
ggsave(file="output_jp/figures/fig5.pdf", fig_paper_monthly_rate_AT_CT, width = 16, height= 10, units = "cm")

# Quarterly
dat0m_quart <- dat0m %>%
  group_by(year, quarter) %>%
  summarise(temperature = mean(temperature, na.rm=TRUE),
            at = mean(ta, na.rm=TRUE))
fig_temp_quarter <- ggplot(data=dat0m_quart, aes(x=year, y=temperature)) + 
  geom_line(aes(color=as.factor(quarter)), size=1) +
  xlab("Time") + ylab("Temperature") +
  Mytheme() +
  scale_color_viridis(name="Quarter", discrete=TRUE, option="plasma") + 
  theme(legend.position="top") +
  guides(col = guide_legend(ncol = 12, byrow = TRUE))
ggsave(file="output_jp/figures/fig_temp_quarter.png", fig_temp_quarter, width = 15, height = 10, units = "cm")

fig_at_quarter <- ggplot(data=dat0m_quart, aes(x=year, y=at)) + 
  geom_line(aes(color=as.factor(quarter)), size=1) +
  xlab("Time") + ylab("Total alkalinity") +
  Mytheme() +
  scale_color_viridis(name="Quarter", discrete=TRUE, option="plasma") + 
  theme(legend.position="top") +
  guides(col = guide_legend(ncol = 12, byrow = TRUE))
ggsave(file="output_jp/figures/fig_at_quarter.png", fig_at_quarter, width = 15, height = 10, units = "cm")
```

```{r}
kable(tab_temp_month, raw.names=TRUE, digits = c(4,4,3,3,3,2,3), caption="Regressions on annual monthly values of temperature at 1 m depth.")
kable(tab_at_month, digits = c(4,4,3,3,3,2,3), caption="Regressions on annual monthly values of total alkalinity at 1 m depth.")
kable(tab_pCO2_month, digits = c(4,4,3,3,3,2,3), caption="Regressions on annual monthly values of pCO2 at 1 m depth.")
kable(tab_ct_month, digits = c(4,4,3,3,3,2,3), caption="Regressions on annual monthly values of CT at 1 m depth.")
```

<!-- ![fig_temp_month.png](output_jp/figures/fig_temp_month.png) -->
<!-- ![fig_at_month.png](output_jp/figures/fig_at_month.png) -->
<!-- ![fig_pCO2_month.png](output_jp/figures/fig_pCO2_month.png) -->
<!-- ![fig_temp_quarter.png](output_jp/figures/fig_temp_quarter.png) -->
<!-- ![fig_at_quarter.png](output_jp/figures/fig_at_quarter.png) -->

## Annual, monthly and quarterly ranges of T, AT and pCO2 at 50 m

```{r monthly and quarterly temperature and AT at 50 m, include=FALSE}
dat50m_month <- dat50m %>%
  group_by(year, monthd) %>%
  summarise(salinity = mean(salinity, na.rm = TRUE),
            temperature = mean(temperature, na.rm=TRUE),
            at = mean(ta, na.rm=TRUE),
            pCO2 = mean(pCO2, na.rm=TRUE),
            ct = mean(dic, na.rm=TRUE)) %>%
  mutate(date = ymd(paste(year,monthd,"01")))

# Regressions annual monthly temperature
j <- 0
reg <- data.frame()
for (i in 1:length(unique(dat50m_month$monthd))) { #one loops through all months
  j <- j + 1
  lms <- summary(lm(data=dplyr::filter(dat50m_month, monthd==i), temperature ~ year))
  # calculate probability of fstatistic because it cannot be extracted from lms above
  # see http://stats.stackexchange.com/questions/92824/extracting-the-model-p-value-for-a-multiple-regression-in-r
  # slope returned by lm is per second
  prob <- pf(lms$fstatistic[1],lms$fstatistic[2],lms$fstatistic[3],lower.tail=FALSE)
  reg <- rbind(reg, as.numeric(c(lms$coefficients[2,1], lms$coefficients[2,2], 
                                 lms$coefficients[2,4], lms$coefficients[1,1], lms$coefficients[1,2],
                                 lms$fstatistic[1], lms$fstatistic[3], lms$coefficients[1,4], lms$r.squared, prob)))
}
names(reg) <- c("Slope", "SE Slope", "P Slope","Intercept","SE int.","P int.", "F", "df",
                "R2","P value")
row.names(reg) <- month(ymd(080101) + months(0:11), label = TRUE, abbr = FALSE)
#transform in latex table and save
tab_temp_month_50m <- reg

# Regressions annual monthly AT
j <- 0
reg <- data.frame()
for (i in 1:length(unique(dat50m_month$monthd))) { #one loops through all months
  j <- j + 1
  lms <- summary(lm(data=dplyr::filter(dat50m_month, monthd==i), at ~ year))
  # calculate probability of fstatistic because it cannot be extracted from lms above
  # see http://stats.stackexchange.com/questions/92824/extracting-the-model-p-value-for-a-multiple-regression-in-r
  # slope returned by lm is per second
  prob <- pf(lms$fstatistic[1],lms$fstatistic[2],lms$fstatistic[3],lower.tail=FALSE)
  reg <- rbind(reg, as.numeric(c(lms$coefficients[2,1], lms$coefficients[2,2], 
                                 lms$coefficients[2,4], lms$coefficients[1,1], lms$coefficients[1,2],
                                 lms$fstatistic[1], lms$fstatistic[3], lms$coefficients[1,4], lms$r.squared, prob)))
}
names(reg) <- c("Slope", "SE Slope", "P Slope","Intercept","SE int.","P int.", "F", "df",
                "R2","P value")
row.names(reg) <- month(ymd(080101) + months(0:11), label = TRUE, abbr = FALSE)
#transform in latex table and save
tab_at_month_50m <- reg
# Regressions annual monthly pCO2
j <- 0
reg <- data.frame()
for (i in 1:length(unique(dat50m_month$monthd))) { #one loops through all months
  j <- j + 1
  lms <- summary(lm(data=dplyr::filter(dat50m_month, monthd==i), pCO2 ~ year))
  # calculate probability of fstatistic because it cannot be extracted from lms above
  # see http://stats.stackexchange.com/questions/92824/extracting-the-model-p-value-for-a-multiple-regression-in-r
  # slope returned by lm is per second
  prob <- pf(lms$fstatistic[1],lms$fstatistic[2],lms$fstatistic[3],lower.tail=FALSE)
  reg <- rbind(reg, as.numeric(c(lms$coefficients[2,1], lms$coefficients[2,2], 
                                 lms$coefficients[2,4], lms$coefficients[1,1], lms$coefficients[1,2],
                                 lms$fstatistic[1], lms$fstatistic[3], lms$coefficients[1,4], lms$r.squared, prob)))
}
names(reg) <- c("Slope", "SE Slope", "P Slope","Intercept","SE int.","P int.", "F", "df",
                "R2","P value")
row.names(reg) <- month(ymd(080101) + months(0:11), label = TRUE, abbr = FALSE)
#transform in latex table and save
tab_pCO2_month_50m <- reg
# Regressions annual monthly CT
j <- 0
reg <- data.frame()
for (i in 1:length(unique(dat50m_month$monthd))) { #one loops through all months
  j <- j + 1
  lms <- summary(lm(data=dplyr::filter(dat50m_month, monthd==i), ct ~ year))
  # calculate probability of fstatistic because it cannot be extracted from lms above
  # see http://stats.stackexchange.com/questions/92824/extracting-the-model-p-value-for-a-multiple-regression-in-r
  # slope returned by lm is per second
  prob <- pf(lms$fstatistic[1],lms$fstatistic[2],lms$fstatistic[3],lower.tail=FALSE)
  reg <- rbind(reg, as.numeric(c(lms$coefficients[2,1], lms$coefficients[2,2], 
                                 lms$coefficients[2,4], lms$coefficients[1,1], lms$coefficients[1,2],
                                 lms$fstatistic[1], lms$fstatistic[3], lms$coefficients[1,4], lms$r.squared, prob)))
}
names(reg) <- c("Slope", "SE Slope", "P Slope","Intercept","SE int.","P int.", "F", "df",
                "R2","P value")
row.names(reg) <- month(ymd(080101) + months(0:11), label = TRUE, abbr = FALSE)
#transform in latex table and save
tab_ct_month_50m <- reg

#Plot monthly increases in AT and CT at 50 m
#Prepare dataframe
monthly_rate_AT_CT_50m <- 
  cbind(rename(select(tab_at_month_50m, Slope), AT=Slope),
        rename(select(tab_ct_month_50m, Slope), CT=Slope)
) %>%
  mutate(month=factor(month.abb, as.character(month.abb))) %>%
  gather(key, value, -month) %>%
  mutate(se=c(tab_at_month[,2], tab_ct_month[,2])) %>%
  mutate(p=c(tab_at_month[,3], tab_ct_month[,3])) %>%
  mutate(significance=ifelse(p<=0.05, "*", ""))

# Scatter plot
fig_paper_monthly_rate_AT_CT_50m <- 
  ggplot(data=monthly_rate_AT_CT_50m, group=key) +
  geom_point(aes(x=month, y=value, color=key), size=2, position=position_dodge(0.2)) +
  geom_errorbar(aes(x=month, ymin=value-se, ymax=value+se, color=key), 
                position=position_dodge(0.2), width=0.1) +
  labs(title=NULL, x= NULL, y=expression(paste("Monthly change (",mu, "mol ", kg^-1, " ", yr^-1, ")")),
       colour="") +
  scale_y_continuous(limits = c(-2.5, 7.5)) +
  scale_color_manual(values = c("blue", "#51C56AFF"),
                     labels=c(expression(paste(italic(A)[T])), expression(paste(italic(C)[T])))) +
  geom_text(aes(x=month, y=value, label=significance), nudge_x=0.25, nudge_y=-0.2, size=8) +
  geom_hline(yintercept = 0, size=0.1) +
  Mytheme(size_labs = 9) +
  theme(aspect.ratio=1/2, 
        legend.position = c(1,1),
        legend.justification = c(1,1),
        panel.grid.major.x = element_blank(),
        legend.title = element_blank(),
        legend.key = element_rect(colour = 'white', fill = 'white', size = 0),
        legend.background = element_rect(fill="white", size=0.15, colour="black"))
ggsave(file="output_jp/figures/fig_paper_monthly_rate_AT_CT_50m.png", fig_paper_monthly_rate_AT_CT_50m, width = 8, height = 8*2/3, units = "cm")
ggsave(file="output_jp/figures/fig4b.pdf", fig_paper_monthly_rate_AT_CT_50m, width = 16, height= 10, units = "cm")
```
<!-- Deconvolution commented because of an error "Error: vector memory exhausted (limit reached?). I have followed, to no avail, the recommendation of this thread: -->
<!-- https://stackoverflow.com/questions/51295402/r-on-macos-error-vector-memory-exhausted-limit-reached -->

<!-- ## Deconvolution of pH changes at 1 m with my approach -->
<!-- ```{r Deconvolution of pH changes at 1 m my appproach, include=FALSE} -->
<!-- #We construct a dataframe with monthly means for the entire series (mXX) as well as real data (without prefix m) -->
<!-- deconv_dat_pH_1m <- tibble(date=as.POSIXct(dat0m$sampling_date), mAT=dat0m_month$at[dat0m$monthd]*1e-6, mCT=dat0m_month$ct[dat0m$monthd]*1e-6, mS=dat0m_month$salinity[dat0m$monthd], mT=dat0m_month$temperature[dat0m$monthd], P=dat0m$depth/10, Pt=dat0m$Pt, Sit=dat0m$Sit, AT=dat0m$ta*1e-6, CT=dat0m$dic*1e-6, S=dat0m$salinity, T=dat0m$temperature) -->

<!-- #d <- NULL; deconv <- NULL # d is for the data to use in carb, deconv is to store the results -->
<!-- deconv_pH_1m <- tibble(date = as.POSIXct(dat0m$sampling_date)) -->

<!-- # delta pHT due to temperature -->
<!-- d <- dplyr::filter(deconv_dat_pH_1m, !is.na(mAT), !is.na(mCT), !is.na(mS), !is.na(T)) # we eliminate rows with NAs -->
<!-- deconv_pH_T_1m <- tibble(date = d$date, -->
<!--                      deconv_pH_T_1m = carb(flag=15, var1=d$mAT, var2=d$mCT, S=d$mS, -->
<!--                                            T=d$T, P=d$P, Pt=d$Pt, Sit=d$Sit,  -->
<!--                                            k1k2 = "l", kf = "pf",  -->
<!--                                            pHscale = "T", b="l10")$pH -->
<!--                      ) -->

<!-- # delta pHT due to salinity -->
<!-- d <- filter(deconv_dat_pH_1m, !is.na(mAT), !is.na(mCT), !is.na(S), !is.na(mT)) # we eliminate rows with NAs -->
<!-- deconv_pH_S_1m <- tibble(date=d$date, -->
<!--                           deconv_pH_S_1m=carb(flag=15, var1=d$mAT, var2=d$mCT,  -->
<!--                                               S=d$S, T=d$mT, P=d$P, Pt=d$Pt, -->
<!--                                               Sit=d$Sit, k1k2 = "l", kf = "pf",  -->
<!--                                               pHscale = "T", b="l10")$pH -->
<!--                           ) -->

<!-- # delta pHT due to AT -->
<!-- d <- filter(deconv_dat_pH_1m, !is.na(AT), !is.na(mCT), !is.na(mS), !is.na(mT)) # we eliminate date with NAs -->
<!-- deconv_pH_AT_1m <- tibble(date=d$date, -->
<!--                      deconv_pH_AT_1m=carb(flag=15, var1=d$AT, var2=d$mCT, S=d$mS, -->
<!--                                           T=d$mT, P=d$P, Pt=d$Pt, Sit=d$Sit,  -->
<!--                                           k1k2 = "l", kf = "pf",  -->
<!--                                           pHscale = "T", b="l10")$pH -->
<!--                      ) -->

<!-- # delta pHT due to CT -->
<!-- d <- filter(deconv_dat_pH_1m, !is.na(mAT), !is.na(CT), !is.na(mS), !is.na(mT)) # we eliminate date with NAs -->
<!-- deconv_pH_CT_1m <- tibble(date=d$date, -->
<!--                               deconv_pH_CT_1m=carb(flag=15, var1=d$mAT, var2=d$CT, -->
<!--                                                    S=d$mS, T=d$mT,  -->
<!--                                                    P=d$P, Pt=d$Pt, Sit=d$Sit,  -->
<!--                                                    k1k2 = "l", kf = "pf",  -->
<!--                                                    pHscale = "T", b="l10")$pH -->
<!--                      ) -->

<!-- # Bring all results together -->
<!-- deconv_pH_1m <- deconv_pH_1m %>% -->
<!--   left_join(deconv_pH_T_1m) %>% -->
<!--   left_join(deconv_pH_S_1m) %>% -->
<!--   left_join(deconv_pH_AT_1m) %>% -->
<!--   left_join(deconv_pH_CT_1m) -->
<!-- deconv_pH_1m$monthd <- month(deconv_pH_1m$date) -->

<!-- # Calculate monthly means -->
<!-- tmp <- ungroup(deconv_pH_1m) %>% -->
<!--   group_by(monthd) %>% -->
<!--   summarise( -->
<!--   deconv_pH_T_1m_month = mean(deconv_pH_T_1m, na.rm = TRUE), -->
<!--   deconv_pH_S_1m_month = mean(deconv_pH_S_1m, na.rm = TRUE), -->
<!--   deconv_pH_AT_1m_month = mean(deconv_pH_AT_1m, na.rm = TRUE), -->
<!--   deconv_pH_CT_1m_month = mean(deconv_pH_CT_1m, na.rm = TRUE) -->
<!--   ) -->

<!-- # Calculate anomalies -->
<!-- ano_deconv_pH_1m <- left_join(ungroup(deconv_pH_1m), tmp, by = "monthd") %>% -->
<!--   mutate( -->
<!--   deconv_pH_T_1m_ano = deconv_pH_T_1m - deconv_pH_T_1m_month, -->
<!--   deconv_pH_S_1m_ano = deconv_pH_S_1m - deconv_pH_S_1m_month, -->
<!--   deconv_pH_AT_1m_ano = deconv_pH_AT_1m - deconv_pH_AT_1m_month, -->
<!--   deconv_pH_CT_1m_ano = deconv_pH_CT_1m - deconv_pH_CT_1m_month -->
<!--   ) %>% -->
<!--   select(-deconv_pH_T_1m, -deconv_pH_S_1m, -deconv_pH_AT_1m, -deconv_pH_CT_1m, -deconv_pH_T_1m_month, -deconv_pH_S_1m_month, -deconv_pH_AT_1m_month, -deconv_pH_CT_1m_month) -->

<!-- # Regressions and tables of key parameters on real values (as opposed to anomalies) -->
<!-- var_list <- -->
<!--   c( -->
<!--   "deconv_pH_T_1m", -->
<!--   "deconv_pH_S_1m", -->
<!--   "deconv_pH_AT_1m", -->
<!--   "deconv_pH_CT_1m" -->
<!--   ) -->
<!-- lms <- lapply(var_list, function(x) { -->
<!--   summary(lm(substitute(i ~ decimal_date(date), list(i = as.name(x))), data = deconv_pH_1m)) -->
<!--   }) -->
<!-- reg <- NULL -->
<!-- for (i in 1:length(var_list)) { -->
<!--   #one loops through all real variables -->
<!--   # calculate probability of fstatistic because it cannot be extracted from lms above -->
<!--   # see http://stats.stackexchange.com/questions/92824/extracting-the-model-p-value-for-a-multiple-regression-in-r -->
<!--   # slope returned by lm is per second -->
<!--   prob <- -->
<!--   pf(lms[[i]]$fstatistic[1], -->
<!--   lms[[i]]$fstatistic[2], -->
<!--   lms[[i]]$fstatistic[3], -->
<!--   lower.tail = FALSE) -->
<!--   reg <- -->
<!--   rbind(reg, as.numeric( -->
<!--   c( -->
<!--     lms[[i]]$coefficients[2, 1], -->
<!--     lms[[i]]$coefficients[2, 2], -->
<!--   lms[[i]]$coefficients[2, 4], -->
<!--   lms[[i]]$coefficients[1, 1], -->
<!--   lms[[i]]$coefficients[1, 2], -->
<!--   lms[[i]]$coefficients[1, 4], -->
<!--   lms[[i]]$r.squared, -->
<!--   prob -->
<!--   ) -->
<!--   )) -->
<!-- } -->
<!-- colnames(reg) <- -->
<!--   c("Slope", -->
<!--   "SE Slope", -->
<!--   "P Slope", -->
<!--   "Intercept", -->
<!--   "SE int.", -->
<!--   "P int.", -->
<!--   "R2", -->
<!--   "P value") -->
<!-- row.names(reg) <- var_list -->
<!-- reg_deconv_pH_1m <- reg -->

<!-- # Regressions and tables of key parameters on anomalies (as opposed to real values) -->
<!-- var_list <- -->
<!--   c( -->
<!--   "deconv_pH_T_1m_ano", -->
<!--   "deconv_pH_S_1m_ano", -->
<!--   "deconv_pH_AT_1m_ano", -->
<!--   "deconv_pH_CT_1m_ano" -->
<!--   ) -->
<!-- lms <- lapply(var_list, function(x) { -->
<!--   summary(lm(substitute(i ~ decimal_date(date), list(i = as.name(x))), data = ano_deconv_pH_1m)) -->
<!--   }) -->
<!-- reg <- NULL -->
<!-- for (i in 1:length(var_list)) { -->
<!--   #one loops through all anomalies -->
<!--   # calculate probability of fstatistic because it cannot be extracted from lms above -->
<!--   # see http://stats.stackexchange.com/questions/92824/extracting-the-model-p-value-for-a-multiple-regression-in-r -->
<!--   # slope returned by lm is per second -->
<!--   prob <- -->
<!--   pf(lms[[i]]$fstatistic[1], -->
<!--   lms[[i]]$fstatistic[2], -->
<!--   lms[[i]]$fstatistic[3], -->
<!--   lower.tail = FALSE) -->
<!--   reg <- -->
<!--   rbind(reg, as.numeric( -->
<!--   c( -->
<!--     lms[[i]]$coefficients[2, 1], -->
<!--     lms[[i]]$coefficients[2, 2], -->
<!--   lms[[i]]$coefficients[2, 4], -->
<!--   lms[[i]]$coefficients[1, 1], -->
<!--   lms[[i]]$coefficients[1, 2], -->
<!--   lms[[i]]$coefficients[1, 4], -->
<!--   lms[[i]]$r.squared, -->
<!--   prob -->
<!--   ) -->
<!--   )) -->
<!-- } -->
<!-- colnames(reg) <- -->
<!--   c("Slope", -->
<!--   "SE Slope", -->
<!--   "P Slope", -->
<!--   "Intercept", -->
<!--   "SE int.", -->
<!--   "P int.", -->
<!--   "R2", -->
<!--   "P value") -->
<!-- row.names(reg) <- var_list -->
<!-- reg_deconv_pH_1m_ano <- reg -->

<!-- # Plot with real values -->
<!-- deconv_pH_1m_melt <-  gather(data = select(deconv_pH_1m, -monthd), key = variable, value=value, -date) -->
<!-- fig_deconv_pH_1m <- ggplot(deconv_pH_1m_melt) + geom_point(aes(x=date, y=value, color=variable), size=0.5) + -->
<!--   facet_grid(variable ~., scales="free_y") +  -->
<!--   xlab("Time") + ylab("pH (total scale)")+ -->
<!--   Mytheme() + -->
<!--   scale_colour_discrete(guide="none") -->
<!-- ggsave(file="output_jp/figures/fig_deconv_pH_1m.png", fig_deconv_pH_1m, width = 18, height = 20, units = "cm") -->

<!-- # Plot with anomalies -->
<!-- ano_deconv_pH_1m_melt <-  gather(data = select(ano_deconv_pH_1m, -monthd), key = variable, value=value, -date) -->
<!-- fig_deconv_pH_1m_ano <- ggplot(ano_deconv_pH_1m_melt) + geom_point(aes(x=date, y=value, color=variable), size=0.5) + -->
<!--   facet_grid(variable ~., scales="free_y") +  -->
<!--   xlab("Time") + ylab("pH (total scale)")+ -->
<!--   Mytheme() + -->
<!--   scale_colour_discrete(guide="none") -->
<!-- ggsave(file="output_jp/figures/fig_deconv_pH_1m_ano.png", fig_deconv_pH_1m_ano, width = 18, height = 20, units = "cm") -->
<!-- ``` -->
<!-- García-Ibáñez et al. (2016) provide a method to partition the changes in pH due to changes in salinity, temperature, total alkalinity and dissolved inorganic carbon. -->
<!-- ![garcia-ibanez.png](output_jp/various/garcia-ibanez.png) -->

<!-- García-Ibáñez M. I., Zunino P., Fröb F., Carracedo L. I., Ríos A. F., Mercier H., Olsen A. \& Pérez F. F., 2016. Ocean acidification in the North Atlantic: controlling mechanisms. \textit{Biogeosciences Discussions} 1-26. -->

<!-- Below is the deconvolution performed on values. Here, dvar is the monthly mean value of T, S and CT for the entire time-series. -->

<!-- ![fig_deconv_pH_1m.png](output_jp/figures/fig_deconv_pH_1m.png) -->
<!-- Below is the deconvolution performed on anomalies Here, dvar is the monthly mean value of the anomalies of T, S and CT for the entire time-series. -->

<!-- ![fig_deconv_pH_1m_ano.png](output_jp/figures/fig_deconv_pH_1m_ano.png) -->


<!-- ```{r kable regressions deconvolution pH 1 m} -->
<!-- kable(reg_deconv_pH_1m, digits = c(4,4,11,3,3,2,3), caption="Regressions on values at 1 m depth.") -->
<!-- kable(reg_deconv_pH_1m_ano, digits = c(4,4,11,3,3,2,3), caption="Regressions on anomalies at 1 m depth.") -->
<!-- ``` -->

<!-- Using the real values rather than anomalies, in contrast to Garcia-Ibanez et al., the sum of the slopes is higher that the slope found earlier (`r #round(sum(as.data.frame(reg_deconv_pH_1m)$Slope), digits=4)` vs `r #round(as.data.frame(reg_var_1m)["mean_pH", "Slope"], digits=4)`). -->

<!-- Using the anomalies rather than the real values, the sum of the slopes is much closer to the slope found earlier (`r #round(sum(as.data.frame(reg_deconv_pH_1m_ano)$Slope), digits=4)` vs `r #round(as.data.frame(reg_ano_1m)["pH_ano", "Slope"], digits=4)`). -->

<!-- ## Deconvolution of observed pH changes at 1 m according to Garcia-Ibanez -->
<!-- ```{r Prepare observed data for Garcia-Ibanez pH, include=FALSE} -->
<!-- #We construct a dataframe with yearly means (yXX), monthly/year means (ymXX) as well as total mean (tXX) -->
<!-- deconv_garcia_dat_pH_1m <- NULL -->
<!-- dat0m <- ungroup(dat0m) -->
<!-- y <- dat0m %>% -->
<!--   group_by(year) %>% # First, yearly means -->
<!--   summarise(yS = mean(salinity, na.rm = TRUE),  -->
<!--             yT = mean(temperature, na.rm = TRUE), -->
<!--             yCT = mean(dic, na.rm = TRUE), -->
<!--             yAT = mean(ta, na.rm = TRUE), -->
<!--             yP = mean(P, na.rm = TRUE), -->
<!--             yPt = mean(Pt, na.rm = TRUE), -->
<!--             ySit = mean(Sit, na.rm = TRUE) -->
<!--             ) %>% -->
<!--   ungroup() -->
<!-- # Second, monthly means -->
<!-- dat0m$year_month <- format(dat0m$sampling_date, '%Y-%m') -->
<!-- ym <- dat0m %>% -->
<!--   group_by(year_month) %>% # First, monthly means -->
<!--   summarise(ymS = mean(salinity, na.rm = TRUE),  -->
<!--             ymT = mean(temperature, na.rm = TRUE), -->
<!--             ymCT = mean(dic, na.rm = TRUE), -->
<!--             ymAT = mean(ta, na.rm = TRUE), -->
<!--             ymP = mean(P, na.rm = TRUE), -->
<!--             ymPt = mean(Pt, na.rm = TRUE), -->
<!--             ymSit = mean(Sit, na.rm = TRUE) -->
<!--             ) %>% -->
<!--   ungroup()  -->
<!-- # Third, total means (no grouping) -->
<!-- t <- dat0m %>% -->
<!--   summarise(tS = mean(salinity, na.rm = TRUE), -->
<!--          tT = mean(temperature, na.rm = TRUE), -->
<!--          tAT = mean(ta, na.rm = TRUE), -->
<!--          tCT = mean(dic, na.rm = TRUE), -->
<!--          tP = mean(P, na.rm = TRUE), -->
<!--          tPt = mean(Pt, na.rm = TRUE), -->
<!--          tSit = mean(Sit, na.rm = TRUE) -->
<!--          ) -->
<!-- # bring all variables together -->
<!-- deconv_garcia_dat_pH_1m <- dat0m %>% -->
<!--   select(sampling_date, year, monthd, year_month, CT = dic, AT = ta, -->
<!--          S = salinity, T = temperature) %>% -->
<!--   left_join(y) %>% -->
<!--   left_join(ym) %>% -->
<!--   mutate(tS = t$tS, -->
<!--          tT = t$tT, -->
<!--          tAT = t$tAT, -->
<!--          tCT = t$tCT, -->
<!--          tP = t$tP, -->
<!--          tPt = t$tPt, -->
<!--          tSit = t$tSit) -->
<!-- ``` -->

<!-- ### Deconvolution of pH changes at 1 m using yearly means for not changing variables -->

<!-- ```{r Garcia-Ibanez delta pH using yearly means for not changing variables, include=FALSE} -->
<!-- ### delta pH due to temperature using yearly means for not changing variables -->
<!-- d <- filter(deconv_garcia_dat_pH_1m, !is.na(yAT), !is.na(yCT), !is.na(yS),  -->
<!--             !is.na(T)) # we eliminate date with NAs -->
<!-- d$pH_T_y <- carb( -->
<!--   flag = 15, -->
<!--   var1 = d$yAT * 1e-6, -->
<!--   var2 = d$yCT * 1e-6, -->
<!--   S = d$yS, -->
<!--   T = d$T, -->
<!--   P = d$yP, -->
<!--   Pt = d$yPt, -->
<!--   Sit = d$ySit, -->
<!--   k1k2 = "l", -->
<!--   kf = "pf", -->
<!--   pHscale = "T", -->
<!--   b = "l10" -->
<!--   )$pH -->
<!-- dpH_T_dT_y <- summary(lm(d$pH_T_y ~ d$T))$coefficient[2,1] # slope -->
<!-- dpH_T_dT_y_se <- summary(lm(d$pH_T_y ~ d$T))$coefficient[2,2] # SE slope -->
<!-- dT_dt <- summary(lm(deconv_garcia_dat_pH_1m$T ~ decimal_date(deconv_garcia_dat_pH_1m$sampling_date)))$coefficient[2,1] # slope -->
<!-- dT_dt_se <- summary(lm(deconv_garcia_dat_pH_1m$T ~ decimal_date(deconv_garcia_dat_pH_1m$sampling_date)))$coefficient[2,2] # SE slope -->
<!-- dpH_T_dT_dT_dt_y <- dpH_T_dT_y * dT_dt -->
<!-- #dpH_T_dT_dT_dt_y_se <- sqrt((dpH_T_dT_y_se/dpH_T_dT_y)^2 + (dT_dt_se/dT_dt)^2) -->

<!-- title <- "delta pH due to temperature using yearly means for not changing variables" -->
<!-- fit <- lm(data = d, pH_T_y ~ T) -->
<!-- fig_dpH_T_dT_y_1m <- ggreg(fit) + -->
<!--   labs(x="Temperature (yearly mean)", y="pH") + -->
<!--   Mytheme(size_labs = 10) -->
<!-- ggsave(file="output_jp/figures/fig_dpH_T_y_dT_1m.png", fig_dpH_T_dT_y_1m, width = 18, height = 12, units = "cm") -->

<!-- title <- "" -->
<!-- fit <- lm(data = deconv_garcia_dat_pH_1m, T ~ sampling_date) -->
<!-- fig_dT_dt <- ggreg(fit) + -->
<!--   labs(x="Year", y="Temperature") + -->
<!--   Mytheme(size_labs = 10) -->
<!-- ggsave(file="output_jp/figures/fig_dT_dt_1m.png", fig_dT_dt, width = 18, height = 12, units = "cm") -->

<!-- ### delta pH due to salinity using yearly means for not changing variables -->
<!-- d <- filter(deconv_garcia_dat_pH_1m, !is.na(yAT), !is.na(yCT), !is.na(S),  -->
<!--             !is.na(yT)) # we eliminate date with NAs -->
<!-- d$pH_S_y <- carb( -->
<!--   flag = 15, -->
<!--   var1 = d$yAT * 1e-6, -->
<!--   var2 = d$yCT * 1e-6, -->
<!--   S = d$S, -->
<!--   T = d$yT, -->
<!--   P = d$yP, -->
<!--   Pt = d$yPt, -->
<!--   Sit = d$ySit, -->
<!--   k1k2 = "l", -->
<!--   kf = "pf", -->
<!--   pHscale = "T", -->
<!--   b = "l10" -->
<!--   )$pH -->

<!-- dpH_S_dS_y <- summary(lm(d$pH_S_y ~ d$S))$coefficient[2,1] # slope -->
<!-- dpH_S_dS_y_se <- summary(lm(d$pH_S_y ~ d$S))$coefficient[2,2] # SE slope -->
<!-- dS_dt <- summary(lm(deconv_garcia_dat_pH_1m$S ~ decimal_date(deconv_garcia_dat_pH_1m$sampling_date)))$coefficient[2,1] # slope -->
<!-- dS_dt_se <- summary(lm(deconv_garcia_dat_pH_1m$S ~ decimal_date(deconv_garcia_dat_pH_1m$sampling_date)))$coefficient[2,2] # SE slope -->
<!-- dpH_S_dT_dS_dt_y <- dpH_S_dS_y * dS_dt -->

<!-- title <- "delta pH due to salinity using yearly means for not changing variables" -->
<!-- fit <- lm(data = d, pH_S_y ~ S) -->
<!-- fig_dpH_S_dS_y_1m <- ggreg(fit) + -->
<!--   labs(x="Salinity (yearly mean)", y="pH") + -->
<!--   Mytheme(size_labs = 10) -->
<!-- ggsave(file="output_jp/figures/fig_dpH_S_dS_y_1m.png", fig_dpH_S_dS_y_1m, width = 18, height = 12, units = "cm") -->

<!-- title <- "" -->
<!-- fit <- lm(data = deconv_garcia_dat_pH_1m, S ~ sampling_date) -->
<!-- fig_dS_dt_1m <- ggreg(fit) + -->
<!--   labs(x="Year", y="Salinity") + -->
<!--   Mytheme(size_labs = 10) -->
<!-- ggsave(file="output_jp/figures/fig_dS_dt_1m.png", fig_dS_dt_1m, width = 18, height = 12, units = "cm") -->

<!-- ### delta pH due to AT using yearly means for not changing variables -->
<!-- d <- filter(deconv_garcia_dat_pH_1m, !is.na(AT), !is.na(yCT), !is.na(yS),  -->
<!--             !is.na(yT)) # we eliminate date with NAs -->
<!-- d$pH_AT_y <- carb( -->
<!--   flag = 15, -->
<!--   var1 = d$AT * 1e-6, -->
<!--   var2 = d$yCT * 1e-6, -->
<!--   S = d$yS, -->
<!--   T = d$yT, -->
<!--   P = d$yP, -->
<!--   Pt = d$yPt, -->
<!--   Sit = d$ySit, -->
<!--   k1k2 = "l", -->
<!--   kf = "pf", -->
<!--   pHscale = "T", -->
<!--   b = "l10" -->
<!--   )$pH -->

<!-- dpH_AT_dAT_y <- summary(lm(d$pH_AT_y ~ d$AT))$coefficient[2,1] # slope -->
<!-- dpH_AT_dAT_y_se <- summary(lm(d$pH_AT_y ~ d$AT))$coefficient[2,2] # SE slope -->
<!-- dAT_dt <- summary(lm(deconv_garcia_dat_pH_1m$AT ~ decimal_date(deconv_garcia_dat_pH_1m$sampling_date)))$coefficient[2,1] # slope -->
<!-- dAT_dt_se <- summary(lm(deconv_garcia_dat_pH_1m$AT ~ decimal_date(deconv_garcia_dat_pH_1m$sampling_date)))$coefficient[2,2] # SE slope -->
<!-- dpH_AT_dT_dAT_dt_y <- dpH_AT_dAT_y * dAT_dt -->

<!-- title <- "delta pH due to AT using yearly means for not changing variables" -->
<!-- fit <- lm(data = d, pH_AT_y ~ AT) -->
<!-- fig_dpH_AT_dAT_y_1m <- ggreg(fit) + -->
<!--   labs(x="AT (yearly mean)", y="pH") + -->
<!--   Mytheme(size_labs = 10) -->
<!-- ggsave(file="output_jp/figures/fig_dpH_AT_dT_y_1m.png", fig_dpH_AT_dAT_y_1m, width = 18, height = 12, units = "cm") -->

<!-- title <- "" -->
<!-- fit <- lm(data = deconv_garcia_dat_pH_1m, AT ~ sampling_date) -->
<!-- fig_dAT_dt_1m <- ggreg(fit) + -->
<!--   labs(x="Year", y="AT") + -->
<!--   Mytheme(size_labs = 10) -->
<!-- ggsave(file="output_jp/figures/fig_dAT_dt_1m.png", fig_dAT_dt_1m, width = 18, height = 12, units = "cm") -->

<!-- ### delta pH due to CT using yearly means for not changing variables -->
<!-- d <- filter(deconv_garcia_dat_pH_1m, !is.na(yAT), !is.na(CT), !is.na(yS),  -->
<!--             !is.na(yT)) # we eliminate date with NAs -->
<!-- d$pH_CT_y <- carb( -->
<!--   flag = 15, -->
<!--   var1 = d$yAT * 1e-6, -->
<!--   var2 = d$CT * 1e-6, -->
<!--   S = d$yS, -->
<!--   T = d$yT, -->
<!--   P = d$yP, -->
<!--   Pt = d$yPt, -->
<!--   Sit = d$ySit, -->
<!--   k1k2 = "l", -->
<!--   kf = "pf", -->
<!--   pHscale = "T", -->
<!--   b = "l10" -->
<!--   )$pH -->
<!-- dpH_CT_dCT_y <- summary(lm(d$pH_CT_y ~ d$CT))$coefficient[2,1] # slope -->
<!-- dpH_CT_dCT_y_se <- summary(lm(d$pH_CT_y ~ d$CT))$coefficient[2,2] # SE slope -->
<!-- dCT_dt <- summary(lm(deconv_garcia_dat_pH_1m$CT ~ decimal_date(deconv_garcia_dat_pH_1m$sampling_date)))$coefficient[2,1] # slope -->
<!-- dCT_dt_se <- summary(lm(deconv_garcia_dat_pH_1m$CT ~ decimal_date(deconv_garcia_dat_pH_1m$sampling_date)))$coefficient[2,2] # SE slope -->
<!-- dpH_CT_dCT_dCT_dt_y <- dpH_CT_dCT_y * dCT_dt -->

<!-- title <- "delta pH due to CT using yearly means for not changing variables" -->
<!-- fit <- lm(data = d, pH_CT_y ~ CT) -->
<!-- fig_dpH_CT_dCT_y_1m <- ggreg(fit) + -->
<!--   labs(x="CT (yearly mean)", y="pH") + -->
<!--   Mytheme(size_labs = 10) -->
<!-- ggsave(file="output_jp/figures/fig_dpH_CT_y_dT_1m.png", fig_dpH_CT_dCT_y_1m, width = 18, height = 12, units = "cm") -->

<!-- title <- "" -->
<!-- fit <- lm(data = deconv_garcia_dat_pH_1m, CT ~ sampling_date) -->
<!-- fig_dCT_dt_1m <- ggreg(fit) + -->
<!--   labs(x="Year", y="CT") + -->
<!--   Mytheme(size_labs = 10) -->
<!-- ggsave(file="output_jp/figures/fig_dCT_dt_1m.png", fig_dCT_dt_1m, width = 18, height = 12, units = "cm") -->

<!-- deconv_garcia_year <- tibble( -->
<!--   means = c("year", "year", "year", "year", "year"), -->
<!--   var = c("T", "S", "AT", "CT", "sum"), -->
<!--   dpHT_dvar = c(dpH_T_dT_y, dpH_S_dS_y, dpH_AT_dAT_y, dpH_CT_dCT_y, NA), -->
<!--   dpHT_dvar_SE = c(NA, NA, NA, NA, NA), -->
<!--   dvar_dt = c(dT_dt, dS_dt, dAT_dt, dCT_dt, NA), -->
<!--   dvar_dt_SE = c(NA, NA, NA, NA, NA), -->
<!--   dpHT_dt = c(dpH_T_dT_dT_dt_y, dpH_S_dT_dS_dt_y, dpH_AT_dT_dAT_dt_y, -->
<!--               dpH_CT_dCT_dCT_dt_y, -->
<!--               sum(dpH_T_dT_dT_dt_y, dpH_S_dT_dS_dt_y, dpH_AT_dT_dAT_dt_y, -->
<!--               dpH_CT_dCT_dCT_dt_y) -->
<!--               ), -->
<!--   dpHT_dt_SE = c(NA, NA, NA, NA, NA) -->
<!-- ) -->
<!-- ``` -->


<!-- ![fig_dpH_CT_dCT_y_1m.png](output_jp/figures/fig_dpH_T_y_dT_1m.png) -->
<!-- ![fig_dT_dt_1m.png](output_jp/figures/fig_dT_dt_1m.png) -->
<!-- ![fig_dpH_S_dS_y_1m.png](output_jp/figures/fig_dpH_S_dS_y_1m.png) -->
<!-- ![fig_dS_dt_1m.png](output_jp/figures/fig_dS_dt_1m.png) -->
<!-- ![fig_dpH_AT_dT_y_1m.png](output_jp/figures/fig_dpH_AT_dT_y_1m.png) -->

<!-- ![fig_dAT_dt_1m.png](output_jp/figures/fig_dAT_dt_1m.png) -->




<!-- ![fig_dpH_CT_y_dT_1m.png](output_jp/figures/fig_dpH_CT_y_dT_1m.png) -->
<!-- ![fig_dCT_dt_1m.png](output_jp/figures/fig_dCT_dt_1m.png) -->

<!-- ### Deconvolution of pH changes at 1 m using year/month means for not changing variables -->

<!-- ```{r Garcia-Ibanez delta pH using year/month means for not changing variables, include=FALSE} -->
<!-- ### delta pH due to temperature using year/month means for not changing variables -->
<!-- d <- filter(deconv_garcia_dat_pH_1m, !is.na(ymAT), !is.na(ymCT), !is.na(ymS),  -->
<!--             !is.na(T)) # we eliminate date with NAs -->
<!-- d$pH_T_ym <- carb( -->
<!--   flag = 15, -->
<!--   var1 = d$ymAT * 1e-6, -->
<!--   var2 = d$ymCT * 1e-6, -->
<!--   S = d$ymS, -->
<!--   T = d$T, -->
<!--   P = d$ymP, -->
<!--   Pt = d$ymPt, -->
<!--   Sit = d$ymSit, -->
<!--   k1k2 = "l", -->
<!--   kf = "pf", -->
<!--   pHscale = "T", -->
<!--   b = "l10" -->
<!--   )$pH -->
<!-- dpH_T_dT_ym <- coef(lm(d$pH_T_ym ~ d$T))[[2]] -->
<!-- dT_dt <- coef(lm(deconv_garcia_dat_pH_1m$T ~ decimal_date(deconv_garcia_dat_pH_1m$sampling_date)))[[2]] -->
<!-- dpH_T_dT_dT_dt_ym <- dpH_T_dT_ym * dT_dt -->

<!-- title <- "delta pH due to temperature using year/month means for not changing variables" -->
<!-- fit <- lm(data = d, pH_T_ym ~ T) -->
<!-- fig_dpH_T_dT_ym_1m <- ggreg(fit) + -->
<!--   labs(x="Temperature (year/month mean)", y="pH") + -->
<!--   Mytheme(size_labs = 10) -->
<!-- ggsave(file="output_jp/figures/fig_dpH_T_ym_dT_1m.png", fig_dpH_T_dT_ym_1m, width = 18, height = 12, units = "cm") -->

<!-- title <- "" -->
<!-- fit <- lm(data = deconv_garcia_dat_pH_1m, T ~ sampling_date) -->
<!-- fig_dT_dt_1m <- ggreg(fit) + -->
<!--   labs(x="Year", y="Temperature") + -->
<!--   Mytheme(size_labs = 10) -->
<!-- ggsave(file="output_jp/figures/fig_dT_dt_1m.png", fig_dT_dt_1m, width = 18, height = 12, units = "cm") -->

<!-- ### delta pH due to salinity using year/month means for not changing variables -->
<!-- d <- filter(deconv_garcia_dat_pH_1m, !is.na(ymAT), !is.na(ymCT), !is.na(S),  -->
<!--             !is.na(ymT)) # we eliminate date with NAs -->
<!-- d$pH_S_ym <- carb( -->
<!--   flag = 15, -->
<!--   var1 = d$ymAT * 1e-6, -->
<!--   var2 = d$ymCT * 1e-6, -->
<!--   S = d$S, -->
<!--   T = d$ymT, -->
<!--   P = d$ymP, -->
<!--   Pt = d$ymPt, -->
<!--   Sit = d$ymSit, -->
<!--   k1k2 = "l", -->
<!--   kf = "pf", -->
<!--   pHscale = "T", -->
<!--   b = "l10" -->
<!--   )$pH -->
<!-- dpH_S_dS_ym <- coef(lm(d$pH_S_ym ~ d$S))[[2]] -->
<!-- dS_dt <- coef(lm(deconv_garcia_dat_pH_1m$S ~ decimal_date(deconv_garcia_dat_pH_1m$sampling_date)))[[2]] -->
<!-- dpH_S_dT_dS_dt_ym <- dpH_S_dS_ym * dS_dt -->

<!-- title <- "delta pH due to salinity using year/month means for not changing variables" -->
<!-- fit <- lm(data = d, pH_S_ym ~ S) -->
<!-- fig_dpH_S_dS_ym_1m <- ggreg(fit) + -->
<!--   labs(x="Salinity (year/month mean)", y="pH") + -->
<!--   Mytheme(size_labs = 10) -->
<!-- ggsave(file="output_jp/figures/fig_dpH_S_dS_ym_1m.png", fig_dpH_S_dS_ym_1m, width = 18, height = 12, units = "cm") -->

<!-- title <- "" -->
<!-- fit <- lm(data = deconv_garcia_dat_pH_1m, S ~ sampling_date) -->
<!-- fig_dS_dt_1m <- ggreg(fit) + -->
<!--   labs(x="Year", y="Salinity") + -->
<!--   Mytheme(size_labs = 10) -->
<!-- ggsave(file="output_jp/figures/fig_dS_dt_1m.png", fig_dS_dt_1m, width = 18, height = 12, units = "cm") -->

<!-- ### delta pH due to AT using year/month means for not changing variables -->
<!-- d <- filter(deconv_garcia_dat_pH_1m, !is.na(AT), !is.na(ymCT), !is.na(ymS),  -->
<!--             !is.na(ymT)) # we eliminate date with NAs -->
<!-- d$pH_AT_ym <- carb( -->
<!--   flag = 15, -->
<!--   var1 = d$AT * 1e-6, -->
<!--   var2 = d$ymCT * 1e-6, -->
<!--   S = d$ymS, -->
<!--   T = d$ymT, -->
<!--   P = d$ymP, -->
<!--   Pt = d$ymPt, -->
<!--   Sit = d$ymSit, -->
<!--   k1k2 = "l", -->
<!--   kf = "pf", -->
<!--   pHscale = "T", -->
<!--   b = "l10" -->
<!--   )$pH -->
<!-- dpH_AT_dAT_ym <- coef(lm(d$pH_AT_ym ~ d$AT))[[2]] -->
<!-- dAT_dt <- coef(lm(deconv_garcia_dat_pH_1m$AT ~ decimal_date(deconv_garcia_dat_pH_1m$sampling_date)))[[2]] -->
<!-- dpH_AT_dT_dAT_dt_ym <- dpH_AT_dAT_ym * dAT_dt -->

<!-- title <- "delta pH due to AT using year/month means for not changing variables" -->
<!-- fit <- lm(data = d, pH_AT_ym ~ AT) -->
<!-- fig_dpH_AT_dAT_ym_1m <- ggreg(fit) + -->
<!--   labs(x="AT (year/month mean)", y="pH") + -->
<!--   Mytheme(size_labs = 10) -->
<!-- ggsave(file="output_jp/figures/fig_dpH_AT_dT_ym_1m.png", fig_dpH_AT_dAT_ym_1m, width = 18, height = 12, units = "cm") -->

<!-- title <- "" -->
<!-- fit <- lm(data = deconv_garcia_dat_pH_1m, AT ~ sampling_date) -->
<!-- fig_dAT_dt_1m <- ggreg(fit) + -->
<!--   labs(x="Year", y="AT") + -->
<!--   Mytheme(size_labs = 10) -->
<!-- ggsave(file="output_jp/figures/fig_dAT_dt_1m.png", fig_dAT_dt_1m, width = 18, height = 12, units = "cm") -->

<!-- ### delta pH due to CT using year/month means for not changing variables -->
<!-- d <- filter(deconv_garcia_dat_pH_1m, !is.na(ymAT), !is.na(CT), !is.na(ymS),  -->
<!--             !is.na(ymT)) # we eliminate date with NAs -->
<!-- d$pH_CT_ym <- carb( -->
<!--   flag = 15, -->
<!--   var1 = d$ymAT * 1e-6, -->
<!--   var2 = d$CT * 1e-6, -->
<!--   S = d$ymS, -->
<!--   T = d$ymT, -->
<!--   P = d$ymP, -->
<!--   Pt = d$ymPt, -->
<!--   Sit = d$ymSit, -->
<!--   k1k2 = "l", -->
<!--   kf = "pf", -->
<!--   pHscale = "T", -->
<!--   b = "l10" -->
<!--   )$pH -->
<!-- dpH_CT_dCT_ym <- coef(lm(d$pH_CT_ym ~ d$CT))[[2]] -->
<!-- dCT_dt <- coef(lm(deconv_garcia_dat_pH_1m$CT ~ decimal_date(deconv_garcia_dat_pH_1m$sampling_date)))[[2]] -->
<!-- dpH_CT_dCT_dCT_dt_ym <- dpH_CT_dCT_ym * dCT_dt -->

<!-- title <- "delta pH due to CT using year/month means for not changing variables" -->
<!-- fit <- lm(data = d, pH_CT_ym ~ CT) -->
<!-- fig_dpH_CT_dCT_ym_1m <- ggreg(fit) + -->
<!--   labs(x="CT (year/month mean)", y="pH") + -->
<!--   Mytheme(size_labs = 10) -->
<!-- ggsave(file="output_jp/figures/fig_dpH_CT_ym_dT_1m.png", fig_dpH_CT_dCT_ym_1m, width = 18, height = 12, units = "cm") -->

<!-- title <- "" -->
<!-- fit <- lm(data = deconv_garcia_dat_pH_1m, CT ~ sampling_date) -->
<!-- fig_dCT_dt_1m <- ggreg(fit) + -->
<!--   labs(x="Year", y="CT") + -->
<!--   Mytheme(size_labs = 10) -->
<!-- ggsave(file="output_jp/figures/fig_dCT_dt_1m.png", fig_dCT_dt_1m, width = 18, height = 12, units = "cm") -->

<!-- deconv_garcia_year_month <- tibble( -->
<!--   means = c("year/month", "year/month", "year/month", "year/month", "year/month"), -->
<!--   var = c("T", "S", "AT", "CT", "sum"), -->
<!--   dpHT_dvar = c(dpH_T_dT_ym, dpH_S_dS_ym, dpH_AT_dAT_ym, dpH_CT_dCT_ym, NA), -->
<!--   dpHT_dvar_SE = c(NA, NA, NA, NA, NA), -->
<!--   dvar_dt = c(dT_dt, dS_dt, dAT_dt, dCT_dt, NA), -->
<!--   dvar_dt_SE = c(NA, NA, NA, NA, NA), -->
<!--   dpHT_dt = c(dpH_T_dT_dT_dt_ym, dpH_S_dT_dS_dt_ym, dpH_AT_dT_dAT_dt_ym, -->
<!--               dpH_CT_dCT_dCT_dt_ym, -->
<!--               sum(dpH_T_dT_dT_dt_ym, dpH_S_dT_dS_dt_ym, dpH_AT_dT_dAT_dt_ym, -->
<!--               dpH_CT_dCT_dCT_dt_ym) -->
<!--               ), -->
<!--   dpHT_dt_SE = c(NA, NA, NA, NA, NA) -->
<!-- ) -->
<!-- ``` -->

<!-- ![fig_dpH_T_dT_ym_1m.png](output_jp/figures/fig_dpH_T_ym_dT_1m.png) -->
<!-- ![fig_dT_dt_1m.png](output_jp/figures/fig_dT_dt_1m.png) -->
<!-- ![fig_dpH_S_dS_ym_1m.png](output_jp/figures/fig_dpH_S_dS_ym_1m.png) -->
<!-- ![fig_dS_dt_1m.png](output_jp/figures/fig_dS_dt_1m.png) -->
<!-- ![fig_dpH_AT_dT_ym_1m.png](output_jp/figures/fig_dpH_AT_dT_ym_1m.png) -->
<!-- ![fig_dAT_dt_1m.png](output_jp/figures/fig_dAT_dt_1m.png) -->
<!-- ![fig_dpH_CT_ym_dT_1m.png](output_jp/figures/fig_dpH_CT_ym_dT_1m.png) -->
<!-- ![fig_dCT_dt_1m.png](output_jp/figures/fig_dCT_dt_1m.png) -->

<!-- ### Deconvolution of pH changes at 1 m using total means for not changing variables -->

<!-- ```{r Garcia-Ibanez delta pH using total means for not changing variables, include=FALSE} -->
<!-- ### delta pH due to temperature using total means for not changing variables -->
<!-- d <- dplyr::filter(deconv_garcia_dat_pH_1m, !is.na(tAT), !is.na(tCT), !is.na(tS),  -->
<!--             !is.na(T)) # we eliminate date with NAs -->
<!-- d$pH_T_t <- seacarb::carb( -->
<!--   flag = 15, -->
<!--   var1 = d$tAT * 1e-6, -->
<!--   var2 = d$tCT * 1e-6, -->
<!--   S = d$tS, -->
<!--   T = d$T, -->
<!--   P = d$tP, -->
<!--   Pt = d$tPt, -->
<!--   Sit = d$tSit, -->
<!--   k1k2 = "l", -->
<!--   kf = "pf", -->
<!--   pHscale = "T", -->
<!--   b = "l10" -->
<!--   )$pH -->
<!-- dpH_T_dT_t <- summary(lm(d$pH_T_t ~ d$T))$coefficient[2,1] # slope -->
<!-- dpH_T_dT_t_se <- summary(lm(d$pH_T_t ~ d$T))$coefficient[2,2] # SE slope -->
<!-- dT_dt <- summary(lm(deconv_garcia_dat_pH_1m$T ~ decimal_date(deconv_garcia_dat_pH_1m$sampling_date)))$coefficient[2,1] # slope -->
<!-- dT_dt_se <- summary(lm(deconv_garcia_dat_pH_1m$T ~ decimal_date(deconv_garcia_dat_pH_1m$sampling_date)))$coefficient[2,2] # SE slope -->
<!-- dpH_T_dT_dT_dt_t <- dpH_T_dT_t * dT_dt -->
<!-- dpH_T_dT_dT_dt_t_se <- abs(dpH_T_dT_dT_dt_t) * sqrt((dpH_T_dT_t_se/dpH_T_dT_t)^2 + -->
<!--                                                  (dT_dt_se/dT_dt)^2) -->

<!-- title <- "delta pH due to temperature using total means for not changing variables" -->
<!-- fit <- lm(data = d, pH_T_t ~ T) -->
<!-- fig_dpH_T_dT_t_1m <- ggreg(fit) + -->
<!--   labs(x="Temperature (total mean)", y="pH") + -->
<!--   Mytheme(size_labs = 10) -->
<!-- ggsave(file="output_jp/figures/fig_dpH_T_t_dT_1m.png", fig_dpH_T_dT_t_1m, width = 18, height = 12, units = "cm") -->

<!-- fit <- lm(data = deconv_garcia_dat_pH_1m, T ~ sampling_date) -->
<!-- fig_dT_dt_1m <- ggreg(fit) + -->
<!--   labs(x="Year", y="Temperature") + -->
<!--   Mytheme(size_labs = 10) -->
<!-- ggsave(file="output_jp/figures/fig_dT_dt_1m.png", fig_dT_dt_1m, width = 18, height = 12, units = "cm") -->

<!-- title <- "" -->
<!-- d <- filter(deconv_garcia_dat_pH_1m, !is.na(tAT), !is.na(tCT), !is.na(S),  -->
<!--             !is.na(tT)) # we eliminate date with NAs -->
<!-- d$pH_S_t <- carb( -->
<!--   flag = 15, -->
<!--   var1 = d$tAT * 1e-6, -->
<!--   var2 = d$tCT * 1e-6, -->
<!--   S = d$S, -->
<!--   T = d$tT, -->
<!--   P = d$tP, -->
<!--   Pt = d$tPt, -->
<!--   Sit = d$tSit, -->
<!--   k1k2 = "l", -->
<!--   kf = "pf", -->
<!--   pHscale = "T", -->
<!--   b = "l10" -->
<!--   )$pH -->
<!-- dpH_S_dS_t <- summary(lm(d$pH_S_t ~ d$S))$coefficient[2,1] # slope -->
<!-- dpH_S_dS_t_se <- summary(lm(d$pH_S_t ~ d$S))$coefficient[2,2] # SE slope -->
<!-- dS_dt <- summary(lm(deconv_garcia_dat_pH_1m$S ~ decimal_date(deconv_garcia_dat_pH_1m$sampling_date)))$coefficient[2,1] # slope -->
<!-- dS_dt_se <- summary(lm(deconv_garcia_dat_pH_1m$S ~ decimal_date(deconv_garcia_dat_pH_1m$sampling_date)))$coefficient[2,2] # SE slope -->
<!-- dpH_S_dT_dS_dt_t <- dpH_S_dS_t * dS_dt -->
<!-- dpH_S_dS_dS_dt_t_se <- abs(dpH_S_dT_dS_dt_t) * sqrt((dpH_S_dS_t_se/dpH_S_dS_t)^2 + (dS_dt_se/dS_dt)^2) -->

<!-- title <- "delta pH due to salinity using total means for not changing variables" -->
<!-- fit <- lm(data = d, pH_S_t ~ S) -->
<!-- fig_dpH_S_dS_t_1m <- ggreg(fit) + -->
<!--   labs(x="Salinity (total mean)", y="pH") + -->
<!--   Mytheme(size_labs = 10) -->
<!-- ggsave(file="output_jp/figures/fig_dpH_S_dS_t_1m.png", fig_dpH_S_dS_t_1m, width = 18, height = 12, units = "cm") -->

<!-- fit <- lm(data = deconv_garcia_dat_pH_1m, S ~ sampling_date) -->
<!-- fig_dS_dt_1m <- ggreg(fit) + -->
<!--   labs(x="Year", y="Salinity") + -->
<!--   Mytheme(size_labs = 10) -->
<!-- ggsave(file="output_jp/figures/fig_dS_dt_1m.png", fig_dS_dt_1m, width = 18, height = 12, units = "cm") -->

<!-- title <- "" -->
<!-- d <- filter(deconv_garcia_dat_pH_1m, !is.na(AT), !is.na(tCT), !is.na(tS),  -->
<!--             !is.na(tT)) # we eliminate date with NAs -->
<!-- d$pH_AT_t <- carb( -->
<!--   flag = 15, -->
<!--   var1 = d$AT * 1e-6, -->
<!--   var2 = d$tCT * 1e-6, -->
<!--   S = d$tS, -->
<!--   T = d$tT, -->
<!--   P = d$tP, -->
<!--   Pt = d$tPt, -->
<!--   Sit = d$tSit, -->
<!--   k1k2 = "l", -->
<!--   kf = "pf", -->
<!--   pHscale = "T", -->
<!--   b = "l10" -->
<!--   )$pH -->
<!-- dpH_AT_dAT_t <- summary(lm(d$pH_AT_t ~ d$AT))$coefficient[2,1] # slope -->
<!-- dpH_AT_dAT_t_se <- summary(lm(d$pH_AT_t ~ d$AT))$coefficient[2,2] # SE slope -->
<!-- dAT_dt <- summary(lm(deconv_garcia_dat_pH_1m$AT ~ decimal_date(deconv_garcia_dat_pH_1m$sampling_date)))$coefficient[2,1] # slope -->
<!-- dAT_dt_se <- summary(lm(deconv_garcia_dat_pH_1m$AT ~ decimal_date(deconv_garcia_dat_pH_1m$sampling_date)))$coefficient[2,2] # SE slope -->
<!-- dpH_AT_dAT_dAT_dt_t <- dpH_AT_dAT_t * dAT_dt -->
<!-- dpH_AT_dAT_dAT_dt_t_se <- abs(dpH_AT_dAT_dAT_dt_t) * -->
<!--   sqrt((dpH_AT_dAT_t_se/dpH_AT_dAT_t)^2 + (dAT_dt_se/dAT_dt)^2) -->

<!-- title <- "delta pH due to AT using total means for not changing variables" -->
<!-- fit <- lm(data = d, pH_AT_t ~ AT) -->
<!-- fig_dpH_AT_dAT_t_1m <- ggreg(fit) + -->
<!--   labs(x="AT (total mean)", y="pH") + -->
<!--   Mytheme(size_labs = 10) -->
<!-- ggsave(file="output_jp/figures/fig_dpH_AT_dT_t_1m.png", fig_dpH_AT_dAT_t_1m, width = 18, height = 12, units = "cm") -->

<!-- title <- "" -->
<!-- fit <- lm(data = deconv_garcia_dat_pH_1m, AT ~ sampling_date) -->
<!-- fig_dAT_dt_1m <- ggreg(fit) + -->
<!--   labs(x="Year", y="AT") + -->
<!--   Mytheme(size_labs = 10) -->
<!-- ggsave(file="output_jp/figures/fig_dAT_dt_1m.png", fig_dAT_dt_1m, width = 18, height = 12, units = "cm") -->

<!-- ### delta pH due to CT using total means for not changing variables -->
<!-- d <- filter(deconv_garcia_dat_pH_1m, !is.na(tAT), !is.na(CT), !is.na(tS),  -->
<!--             !is.na(tT)) # we eliminate date with NAs -->
<!-- d$pH_CT_t <- carb( -->
<!--   flag = 15, -->
<!--   var1 = d$tAT * 1e-6, -->
<!--   var2 = d$CT * 1e-6, -->
<!--   S = d$tS, -->
<!--   T = d$tT, -->
<!--   P = d$tP, -->
<!--   Pt = d$tPt, -->
<!--   Sit = d$tSit, -->
<!--   k1k2 = "l", -->
<!--   kf = "pf", -->
<!--   pHscale = "T", -->
<!--   b = "l10" -->
<!--   )$pH -->
<!-- dpH_CT_dCT_t <- summary(lm(d$pH_CT_t ~ d$CT))$coefficient[2,1] # slope -->
<!-- dpH_CT_dCT_t_se <- summary(lm(d$pH_CT_t ~ d$CT))$coefficient[2,2] # SE slope -->
<!-- dCT_dt <- summary(lm(deconv_garcia_dat_pH_1m$CT ~ decimal_date(deconv_garcia_dat_pH_1m$sampling_date)))$coefficient[2,1] # slope -->
<!-- dCT_dt_se <- summary(lm(deconv_garcia_dat_pH_1m$CT ~ decimal_date(deconv_garcia_dat_pH_1m$sampling_date)))$coefficient[2,2] # SEslope -->
<!-- dpH_CT_dCT_dCT_dt_t <- dpH_CT_dCT_t * dCT_dt -->
<!-- dpH_CT_dCT_dCT_dt_t_se <- abs(dpH_CT_dCT_dCT_dt_t) * -->
<!--   sqrt((dpH_CT_dCT_t_se/dpH_CT_dCT_t)^2 + (dCT_dt_se/dCT_dt)^2) -->

<!-- title <- "delta pH due to CT using total means for not changing variables" -->
<!-- fit <- lm(data = d, pH_CT_t ~ CT) -->
<!-- fig_dpH_CT_dCT_t_1m <- ggreg(fit) + -->
<!--   labs(x="CT (total mean)", y="pH") + -->
<!--   Mytheme(size_labs = 10) -->
<!-- ggsave(file="output_jp/figures/fig_dpH_CT_t_dT_1m.png", fig_dpH_CT_dCT_t_1m, width = 18, height = 12, units = "cm") -->

<!-- title <- "" -->
<!-- fit <- lm(data = deconv_garcia_dat_pH_1m, CT ~ sampling_date) -->
<!-- fig_dCT_dt_1m <- ggreg(fit) + -->
<!--   labs(x="Year", y="CT") + -->
<!--   Mytheme(size_labs = 10) -->
<!-- ggsave(file="output_jp/figures/fig_dCT_dt_1m.png", fig_dCT_dt_1m, width = 18, height = 12, units = "cm") -->

<!-- deconv_garcia_total <- tibble( -->
<!--   means = c("total", "total", "total", "total", "total"), -->
<!--   var = c("T", "S", "AT", "CT", "sum"), -->
<!--   dpHT_dvar = c(dpH_T_dT_t, dpH_S_dS_t, dpH_AT_dAT_t, dpH_CT_dCT_t, NA), -->
<!--   dpHT_dvar_SE = c(dpH_T_dT_t_se, dpH_S_dS_t_se, dpH_AT_dAT_t_se, dpH_CT_dCT_t_se, NA), -->
<!--   dvar_dt = c(dT_dt, dS_dt, dAT_dt, dCT_dt, NA), -->
<!--   dvar_dt_SE = c(dT_dt_se, dS_dt_se, dAT_dt_se, dCT_dt_se, NA), -->
<!--   dpHT_dt = c(dpH_T_dT_dT_dt_t, dpH_S_dT_dS_dt_t, dpH_AT_dAT_dAT_dt_t, -->
<!--               dpH_CT_dCT_dCT_dt_t, -->
<!--               sum(dpH_T_dT_dT_dt_t, dpH_S_dT_dS_dt_t, dpH_AT_dAT_dAT_dt_t, -->
<!--               dpH_CT_dCT_dCT_dt_t)), -->
<!--   dpHT_dt_SE = c(dpH_T_dT_dT_dt_t_se, dpH_S_dS_dS_dt_t_se, dpH_AT_dAT_dAT_dt_t_se, -->
<!--               dpH_CT_dCT_dCT_dt_t_se,  -->
<!--               sqrt(sum(dpH_T_dT_dT_dt_t_se^2, dpH_S_dS_dS_dt_t_se^2, -->
<!--                         dpH_AT_dAT_dAT_dt_t_se^2, dpH_CT_dCT_dCT_dt_t_se^2)) -->
<!--               ) -->
<!-- ) -->
<!-- ``` -->

<!-- ![fig_dpH_T_t_dT_1m.png](output_jp/figures/fig_dpH_T_t_dT_1m.png) -->
<!-- ![fig_dT_dt_1m.png](output_jp/figures/fig_dT_dt_1m.png) -->
<!-- ![fig_dpH_S_dS_t_1m.png](output_jp/figures/fig_dpH_S_dS_t_1m.png) -->
<!-- ![fig_dS_dt_1m.png](output_jp/figures/fig_dS_dt_1m.png) -->
<!-- ![fig_dpH_AT_dT_t_1m.png](output_jp/figures/fig_dpH_AT_dT_t_1m.png) -->
<!-- ![fig_dAT_dt_1m.png](output_jp/figures/fig_dAT_dt_1m.png) -->
<!-- ![fig_dpH_CT_t_dT_1m.png](output_jp/figures/fig_dpH_CT_t_dT_1m.png) -->
<!-- ![fig_dCT_dt_1m.png](output_jp/figures/fig_dCT_dt_1m.png) -->

<!-- ###Summary Garcia-Ibanez compared with my approach -->

<!-- ```{r kable Garcia-Ibanez pH 1 m} -->
<!-- deconv_garcia <- rbind(deconv_garcia_year, deconv_garcia_year_month, deconv_garcia_total) -->
<!-- kable(deconv_garcia, digits = c(1,4,4,7,4,4,4,4), caption="Contributions of 4 variables to pH change at 1 m") -->
<!-- ``` -->

<!-- pH is calculated from AT and CT. There are 4 explanatory variables: T, S, AT and CT. One variable is used at a time while data used for the 3 remaining variables are yearly, year/monthly or total means (also for Pt, Sit and P). Propagation of errors was performed according to http://www.met.rdg.ac.uk/~swrhgnrj/combining_errors.pdf -->

<!-- Using Garcia-Ibanez's approach, the sum of the contributions of each variable to pH changes is `r #round(deconv_garcia$dpHT_dt[5], digits=4)`, `r #round(deconv_garcia$dpHT_dt[10], digits=4)` and `r #round(deconv_garcia$dpHT_dt[15], digits=4)`, respectively using yearly, year/monthly or total means. This is compared with the regression of the observed values against time (that is the real change) of `r #round(as.data.frame(reg_var_1m)["mean_pH", "Slope"], digits=4)`.  -->

<!-- With my approach, using the observed values rather than anomalies, the sum of the slopes is `r #round(sum(as.data.frame(reg_deconv_pH_1m)$Slope), digits=4)` compared with regression of the observed values against time (that is the real change) of `r #round(as.data.frame(reg_var_1m)["mean_pH", "Slope"], digits=4)`. -->

<!-- With my approach, using the anomalies rather than the observed values, the sum of the slopes is `r #round(sum(as.data.frame(reg_deconv_pH_1m_ano)$Slope), digits=4)` compared with regression of the anomalies values against time (that is the real change) of `r #round(as.data.frame(reg_ano_1m)["pH_ano", "Slope"], digits=4)`. -->

<!-- **To summarize**: -->

<!-- - Among the different means used for Garcia's approach, only the total means seem to make senses. -->
<!-- - With Garcia's approach using total means, the result is almost identical to the slope of the observed values (and closer than with my approach). -->
<!-- - It seems to me that this settles the matter and that we ought to use Garcia's approach with total means. -->
<!-- - I do not really see the need to apply the Garcia's approach on anomalies (which were calculated in a weird manner in my approach). -->

<!-- **Final considerations**: -->

<!-- Since the rates of change on the anomalies have lower uncertainties than the rates calculated on the observed values, we recalculate below the contributions. -->

<!-- ```{r Deconvolution pH 1 m according to Garcia-Ibanez using rates of anomalies, include=FALSE} -->
<!-- dT_dt <- reg_ano_1m["Temperature_ano", "Slope"] -->
<!-- dS_dt <- reg_ano_1m["Salinity_ano", "Slope"] -->
<!-- dAT_dt <- reg_ano_1m["ta_ano", "Slope"] -->
<!-- dCT_dt <- reg_ano_1m["dic_ano", "Slope"] -->
<!-- dT_dt_se <- reg_ano_1m["Temperature_ano", "SE Slope"] -->
<!-- dS_dt_se <- reg_ano_1m["Salinity_ano", "SE Slope"] -->
<!-- dAT_dt_se <- reg_ano_1m["ta_ano", "SE Slope"] -->
<!-- dCT_dt_se <- reg_ano_1m["dic_ano", "SE Slope"] -->

<!-- #recalculate dpHT_dt with new dvar_dt above (on anomalies) -->
<!-- dpH_T_dT_dT_dt_t <- dpH_T_dT_t * dT_dt -->
<!-- dpH_S_dT_dS_dt_t <- dpH_S_dS_t * dS_dt -->
<!-- dpH_AT_dAT_dAT_dt_t <- dpH_AT_dAT_t * dAT_dt -->
<!-- dpH_CT_dCT_dCT_dt_t <- dpH_CT_dCT_t * dCT_dt -->

<!-- #recalculate dpHT_dt_SE with new dvar_dt AND dpHT_dt above (on anomalies) -->
<!-- dpH_T_dT_dT_dt_t_se <- abs(dpH_T_dT_dT_dt_t) * sqrt((dpH_T_dT_t_se/dpH_T_dT_t)^2 + -->
<!--                                                  (dT_dt_se/dT_dt)^2) -->
<!-- dpH_S_dS_dS_dt_t_se <- abs(dpH_S_dT_dS_dt_t) * sqrt((dpH_S_dS_t_se/dpH_S_dS_t)^2 + (dS_dt_se/dS_dt)^2) -->
<!-- dpH_AT_dAT_dAT_dt_t_se <- abs(dpH_AT_dAT_dAT_dt_t) * -->
<!--   sqrt((dpH_AT_dAT_t_se/dpH_AT_dAT_t)^2 + (dAT_dt_se/dAT_dt)^2) -->
<!-- dpH_CT_dCT_dCT_dt_t_se <- abs(dpH_CT_dCT_dCT_dt_t) * -->
<!--   sqrt((dpH_CT_dCT_t_se/dpH_CT_dCT_t)^2 + (dCT_dt_se/dCT_dt)^2) -->



<!-- deconv_garcia_total_pH_ano <- tibble( -->
<!--   means = c("total", "total", "total", "total", "total"), -->
<!--   var = c("T", "S", "AT", "CT", "sum"), -->
<!--   dpHT_dvar = c(dpH_T_dT_t, dpH_S_dS_t, dpH_AT_dAT_t, dpH_CT_dCT_t, NA), -->
<!--   dpHT_dvar_SE = c(dpH_T_dT_t_se, dpH_S_dS_t_se, dpH_AT_dAT_t_se, dpH_CT_dCT_t_se, NA), -->
<!--   dvar_dt = c(dT_dt, dS_dt, dAT_dt, dCT_dt, NA), -->
<!--   dvar_dt_SE = c(dT_dt_se, dS_dt_se, dAT_dt_se, dCT_dt_se, NA), -->
<!--   dpHT_dt = c(dpH_T_dT_dT_dt_t, dpH_S_dT_dS_dt_t, dpH_AT_dAT_dAT_dt_t, -->
<!--               dpH_CT_dCT_dCT_dt_t, -->
<!--               sum(dpH_T_dT_dT_dt_t, dpH_S_dT_dS_dt_t, dpH_AT_dAT_dAT_dt_t, -->
<!--               dpH_CT_dCT_dCT_dt_t)), -->
<!--   dpHT_dt_SE = c(dpH_T_dT_dT_dt_t_se, dpH_S_dS_dS_dt_t_se, dpH_AT_dAT_dAT_dt_t_se, -->
<!--               dpH_CT_dCT_dCT_dt_t_se,  -->
<!--               sqrt(sum(dpH_T_dT_dT_dt_t_se^2, dpH_S_dS_dS_dt_t_se^2, -->
<!--                         dpH_AT_dAT_dAT_dt_t_se^2, dpH_CT_dCT_dCT_dt_t_se^2)) -->
<!--               ), -->
<!--   dpHT_dt_percent = c(dpH_T_dT_dT_dt_t, dpH_S_dT_dS_dt_t, dpH_AT_dAT_dAT_dt_t, -->
<!--               dpH_CT_dCT_dCT_dt_t,  -->
<!--               sum(dpH_T_dT_dT_dt_t, dpH_S_dT_dS_dt_t, -->
<!--                   dpH_AT_dAT_dAT_dt_t, dpH_CT_dCT_dCT_dt_t))* -->
<!--     100 /sum(dpH_T_dT_dT_dt_t, dpH_S_dT_dS_dt_t, -->
<!--              dpH_AT_dAT_dAT_dt_t, dpH_CT_dCT_dCT_dt_t) -->
<!-- ) -->
<!-- ``` -->

<!-- ```{r kable Garcia-Ibanez pH 1 m on anomalies} -->
<!-- kable(deconv_garcia_total_pH_ano, digits = c(1,4,4,7,4,4,4,4,0), caption="Contributions of 4 variables to pH change at 1 m (using anomalies)") -->
<!-- ``` -->

<!-- <!-- ## Deconvolution of anomalies pH changes at 1 m according to Garcia-Ibanez --> -->
<!-- ```{r Prepare anomalies data for Garcia-Ibanez, include=FALSE} -->
<!-- # #We construct a dataframe with total mean (tXX) -->
<!-- # deconv_garcia_dat_pH_1m_ano <- NULL -->
<!-- # dat0m <- ungroup(dat0m) -->
<!-- # y <- dat0m %>% -->
<!-- #   group_by(year) %>% # First, yearly means -->
<!-- #   summarise(yS = mean(mean_salinity, na.rm = TRUE),  -->
<!-- #             yT = mean(temp_field, na.rm = TRUE), -->
<!-- #             yCT = mean(dic, na.rm = TRUE), -->
<!-- #             yAT = mean(ta, na.rm = TRUE), -->
<!-- #             yP = mean(mean_P, na.rm = TRUE), -->
<!-- #             yPt = mean(mean_Pt, na.rm = TRUE), -->
<!-- #             ySit = mean(mean_Sit, na.rm = TRUE) -->
<!-- #             ) %>% -->
<!-- #   ungroup() -->
<!-- # # Second, monthly means -->
<!-- # dat0m$year_month <- format(dat0m$sampling_date, '%Y-%m') -->
<!-- # ym <- dat0m %>% -->
<!-- #   group_by(year_month) %>% # First, monthly means -->
<!-- #   summarise(ymS = mean(mean_salinity, na.rm = TRUE),  -->
<!-- #             ymT = mean(temp_field, na.rm = TRUE), -->
<!-- #             ymCT = mean(dic, na.rm = TRUE), -->
<!-- #             ymAT = mean(ta, na.rm = TRUE), -->
<!-- #             ymP = mean(mean_P, na.rm = TRUE), -->
<!-- #             ymPt = mean(mean_Pt, na.rm = TRUE), -->
<!-- #             ymSit = mean(mean_Sit, na.rm = TRUE) -->
<!-- #             ) %>% -->
<!-- #   ungroup()  -->
<!-- # # Third, total means (no grouping) -->
<!-- # t <- dat0m %>% -->
<!-- #   summarise(tS = mean(mean_salinity, na.rm = TRUE), -->
<!-- #          tT = mean(temp_field, na.rm = TRUE), -->
<!-- #          tAT = mean(ta, na.rm = TRUE), -->
<!-- #          tCT = mean(dic, na.rm = TRUE), -->
<!-- #          tP = mean(mean_P, na.rm = TRUE), -->
<!-- #          tPt = mean(mean_Pt, na.rm = TRUE), -->
<!-- #          tSit = mean(mean_Sit, na.rm = TRUE) -->
<!-- #          ) -->
<!-- # # bring all variables together -->
<!-- # deconv_garcia_dat_pH_1m <- dat0m %>% -->
<!-- #   select(sampling_date, year, monthd, year_month, CT = dic, AT = ta, -->
<!-- #          S = mean_salinity, T = temp_field) %>% -->
<!-- #   left_join(y) %>% -->
<!-- #   left_join(ym) %>% -->
<!-- #   mutate(tS = t$tS, -->
<!-- #          tT = t$tT, -->
<!-- #          tAT = t$tAT, -->
<!-- #          tCT = t$tCT, -->
<!-- #          tP = t$tP, -->
<!-- #          tPt = t$tPt, -->
<!-- #          tSit = t$tSit) -->
<!-- ``` -->

<!-- ## Deconvolution of pCO2 changes at 1 m with my approach -->
<!-- ```{r Deconvolution of pCO2 changes at 1 m with my approach, include=FALSE} -->
<!-- # We follow the method of Garcia-Ibanez described above. -->
<!-- # construct a dataframe with monthly means for the entire series (mXX) as well as real data (without mrefix m) -->
<!-- deconv_dat_pCO2_1m <- as_tibble( -->
<!--   data.frame(date=as.POSIXct(dat0m$sampling_date), mAT=dat0m_month$at[dat0m$monthd]*1e-6, mCT=dat0m_month$ct[dat0m$monthd]*1e-6, mS=dat0m_month$salinity[dat0m$monthd], mT=dat0m_month$temperature[dat0m$monthd], P=dat0m$depth/10, Pt=dat0m$Pt, Sit=dat0m$Sit, AT=dat0m$ta*1e-6, CT=dat0m$dic*1e-6, S=dat0m$salinity, T=dat0m$temperature) -->
<!-- ) -->

<!-- #d <- NULL; deconv <- NULL # d is for the data to use in carb, deconv is to store the results -->
<!-- deconv_pCO2_1m <- tibble(date = as.POSIXct(dat0m$sampling_date)) -->
<!-- d <- dplyr::filter(deconv_dat_pCO2_1m, !is.na(mAT), !is.na(mCT), !is.na(mS), !is.na(T)) # we eliminate rows with NAs -->
<!-- deconv_pCO2_T_1m <- tibble(date=d$date, -->
<!--                                deconv_pCO2_T_1m = seacarb::carb(flag=15, var1=d$mAT, var2=d$mCT, -->
<!--                                                      S=d$mS, T=d$T, P=d$P, Pt=d$Pt, -->
<!--                                                      Sit=d$Sit, k1k2 = "l",  -->
<!--                                                      kf = "pf",  -->
<!--                                                      pHscale = "T", b="l10")$pCO2 -->
<!--                      ) -->
<!-- d <- filter(deconv_dat_pCO2_1m, !is.na(mAT), !is.na(mCT), !is.na(S), !is.na(mT)) # we eliminate rows with NAs -->

<!-- deconv_pCO2_S_1m <- tibble(date=d$date, -->
<!--                           deconv_pCO2_S_1m=carb(flag=15, var1=d$mAT, var2=d$mCT, S=d$S, T=d$mT,  -->
<!--                                            P=d$P, Pt=d$Pt, Sit=d$Sit, k1k2 = "l", kf = "pf",  -->
<!--                                            pHscale = "T", b="l10")$pCO2 -->
<!--                           ) -->
<!-- d <- filter(deconv_dat_pCO2_1m, !is.na(AT), !is.na(mCT), !is.na(mS), !is.na(mT)) # we eliminate date with NAs -->
<!-- deconv_pCO2_AT_1m <- tibble(date=d$date, -->
<!--                      deconv_pCO2_AT_1m=carb(flag=15, var1=d$AT, var2=d$mCT, S=d$mS, T=d$mT,  -->
<!--                                        P=d$P, Pt=d$Pt, Sit=d$Sit, k1k2 = "l", kf = "pf",  -->
<!--                                        pHscale = "T", b="l10")$pCO2) -->
<!-- d <- filter(deconv_dat_pCO2_1m, !is.na(mAT), !is.na(CT), !is.na(mS), !is.na(mT)) # we eliminate date with NAs -->
<!-- deconv_pCO2_CT_1m <- tibble(date=d$date, -->
<!--                      deconv_pCO2_CT_1m=carb(flag=15, var1=d$mAT, var2=d$CT, S=d$mS, T=d$mT,  -->
<!--                                        P=d$P, Pt=d$Pt, Sit=d$Sit, k1k2 = "l", kf = "pf",  -->
<!--                                        pHscale = "T", b="l10")$pCO2 -->
<!--                      ) -->

<!-- # Bring all results together -->
<!-- deconv_pCO2_1m <- deconv_pCO2_1m %>% -->
<!--   left_join(deconv_pCO2_T_1m) %>% -->
<!--   left_join(deconv_pCO2_S_1m) %>% -->
<!--   left_join(deconv_pCO2_AT_1m) %>% -->
<!--   left_join(deconv_pCO2_CT_1m) -->
<!-- deconv_pCO2_1m$monthd <- month(deconv_pCO2_1m$date) -->
<!-- # Calculate monthly means -->
<!-- tmp <- ungroup(deconv_pCO2_1m) %>% -->
<!--   group_by(monthd) %>% -->
<!--   summarise( -->
<!--   deconv_pCO2_T_1m_month = mean(deconv_pCO2_T_1m, na.rm = TRUE), -->
<!--   deconv_pCO2_S_1m_month = mean(deconv_pCO2_S_1m, na.rm = TRUE), -->
<!--   deconv_pCO2_AT_1m_month = mean(deconv_pCO2_AT_1m, na.rm = TRUE), -->
<!--   deconv_pCO2_CT_1m_month = mean(deconv_pCO2_CT_1m, na.rm = TRUE) -->
<!--   ) -->

<!-- # Calculate anomalies -->
<!-- ano_deconv_pCO2_1m <- left_join(ungroup(deconv_pCO2_1m), tmp, by = "monthd") %>% -->
<!--   mutate( -->
<!--   deconv_pCO2_T_1m_ano = deconv_pCO2_T_1m - deconv_pCO2_T_1m_month, -->
<!--   deconv_pCO2_S_1m_ano = deconv_pCO2_S_1m - deconv_pCO2_S_1m_month, -->
<!--   deconv_pCO2_AT_1m_ano = deconv_pCO2_AT_1m - deconv_pCO2_AT_1m_month, -->
<!--   deconv_pCO2_CT_1m_ano = deconv_pCO2_CT_1m - deconv_pCO2_CT_1m_month -->
<!--   ) %>% -->
<!--   select(-deconv_pCO2_T_1m, -deconv_pCO2_S_1m, -deconv_pCO2_AT_1m, -deconv_pCO2_CT_1m, -deconv_pCO2_T_1m_month, -deconv_pCO2_S_1m_month, -deconv_pCO2_AT_1m_month, -deconv_pCO2_CT_1m_month) -->

<!-- # Regressions and tables of key parameters on real values (as opposed to anomalies) -->
<!-- var_list <- -->
<!--   c( -->
<!--   "deconv_pCO2_T_1m", -->
<!--   "deconv_pCO2_S_1m", -->
<!--   "deconv_pCO2_AT_1m", -->
<!--   "deconv_pCO2_CT_1m" -->
<!--   ) -->
<!-- lms <- lapply(var_list, function(x) { -->
<!--   summary(lm(substitute(i ~ decimal_date(date), list(i = as.name(x))), data = deconv_pCO2_1m)) -->
<!--   }) -->
<!-- reg <- NULL -->
<!-- for (i in 1:length(var_list)) { -->
<!--   #one loops through all anomalies -->
<!--   # calculate probability of fstatistic because it cannot be extracted from lms above -->
<!--   # see http://stats.stackexchange.com/questions/92824/extracting-the-model-p-value-for-a-multiple-regression-in-r -->
<!--   # slope returned by lm is per second -->
<!--   prob <- -->
<!--   pf(lms[[i]]$fstatistic[1], -->
<!--   lms[[i]]$fstatistic[2], -->
<!--   lms[[i]]$fstatistic[3], -->
<!--   lower.tail = FALSE) -->
<!--   reg <- -->
<!--   rbind(reg, as.numeric( -->
<!--   c( -->
<!--     lms[[i]]$coefficients[2, 1], -->
<!--     lms[[i]]$coefficients[2, 2], -->
<!--   lms[[i]]$coefficients[2, 4], -->
<!--   lms[[i]]$coefficients[1, 1], -->
<!--   lms[[i]]$coefficients[1, 2], -->
<!--   lms[[i]]$coefficients[1, 4], -->
<!--   lms[[i]]$r.squared, -->
<!--   prob -->
<!--   ) -->
<!--   )) -->
<!-- } -->
<!-- colnames(reg) <- -->
<!--   c("Slope", -->
<!--   "SE Slope", -->
<!--   "P Slope", -->
<!--   "Intercept", -->
<!--   "SE int.", -->
<!--   "P int.", -->
<!--   "R2", -->
<!--   "P value") -->
<!-- row.names(reg) <- var_list -->
<!-- reg_deconv_pCO2_1m <- reg -->

<!-- # Regressions and tables of key parameters on anomalies (as opposed to real values) -->
<!-- var_list <- -->
<!--   c( -->
<!--   "deconv_pCO2_T_1m_ano", -->
<!--   "deconv_pCO2_S_1m_ano", -->
<!--   "deconv_pCO2_AT_1m_ano", -->
<!--   "deconv_pCO2_CT_1m_ano" -->
<!--   ) -->
<!-- lms <- lapply(var_list, function(x) { -->
<!--   summary(lm(substitute(i ~ decimal_date(date), list(i = as.name(x))), data = ano_deconv_pCO2_1m)) -->
<!--   }) -->
<!-- reg <- NULL -->
<!-- for (i in 1:length(var_list)) { -->
<!--   #one loops through all anomalies -->
<!--   # calculate probability of fstatistic because it cannot be extracted from lms above -->
<!--   # see http://stats.stackexchange.com/questions/92824/extracting-the-model-p-value-for-a-multiple-regression-in-r -->
<!--   # slope returned by lm is per second -->
<!--   prob <- -->
<!--   pf(lms[[i]]$fstatistic[1], -->
<!--   lms[[i]]$fstatistic[2], -->
<!--   lms[[i]]$fstatistic[3], -->
<!--   lower.tail = FALSE) -->
<!--   reg <- -->
<!--   rbind(reg, as.numeric( -->
<!--   c( -->
<!--     lms[[i]]$coefficients[2, 1], -->
<!--     lms[[i]]$coefficients[2, 2], -->
<!--   lms[[i]]$coefficients[2, 4], -->
<!--   lms[[i]]$coefficients[1, 1], -->
<!--   lms[[i]]$coefficients[1, 2], -->
<!--   lms[[i]]$coefficients[1, 4], -->
<!--   lms[[i]]$r.squared, -->
<!--   prob -->
<!--   ) -->
<!--   )) -->
<!-- } -->
<!-- colnames(reg) <- -->
<!--   c("Slope", -->
<!--   "SE Slope", -->
<!--   "P Slope", -->
<!--   "Intercept", -->
<!--   "SE int.", -->
<!--   "P int.", -->
<!--   "R2", -->
<!--   "P value") -->
<!-- row.names(reg) <- var_list -->
<!-- reg_deconv_pCO2_1m_ano <- reg -->

<!-- # Plot with real values -->
<!-- deconv_pCO2_1m_melt <-  gather(data = select(deconv_pCO2_1m, -monthd), key = variable, value=value, -date) -->
<!-- fig_deconv_pCO2_1m <- ggplot(deconv_pCO2_1m_melt) + geom_point(aes(x=date, y=value, color=variable), size=0.5) + -->
<!--   facet_grid(variable ~., scales="free_y") +  -->
<!--   xlab("Time") + ylab("pCO2 (uatm)")+ -->
<!--   Mytheme() + -->
<!--   scale_colour_discrete(guide="none") -->
<!-- ggsave(file="output_jp/figures/fig_deconv_pCO2_1m.png", fig_deconv_pCO2_1m, width = 18, height = 20, units = "cm") -->

<!-- # Plot with anomalies -->
<!-- ano_deconv_pCO2_1m_melt <-  gather(data = select(ano_deconv_pCO2_1m, -monthd), key = variable, value=value, -date) -->
<!-- fig_deconv_pCO2_1m_ano <- ggplot(ano_deconv_pCO2_1m_melt) + geom_point(aes(x=date, y=value, color=variable), size=0.5) + -->
<!--   facet_grid(variable ~., scales="free_y") +  -->
<!--   xlab("Time") + ylab("pCO2 (uatm)")+ -->
<!--   Mytheme() + -->
<!--   scale_colour_discrete(guide="none") -->
<!-- ggsave(file="output_jp/figures/fig_deconv_pCO2_1m_ano.png", fig_deconv_pCO2_1m_ano, width = 18, height = 20, units = "cm") -->
<!-- ``` -->
<!-- Below is the deconvolution performed on values. Here, dvar is the monthly mean value of T, S and CT for the entire time-series. -->

<!-- ![fig_deconv_pCO2_1m.png](output_jp/figures/fig_deconv_pCO2_1m.png) -->
<!-- Below is the deconvolution performed on anomalies Here, dvar is the monthly mean value of the anomalies of T, S and CT for the entire time-series. -->

<!-- ![fig_deconv_pCO2_1m_ano.png](output_jp/figures/fig_deconv_pCO2_1m_ano.png) -->

<!-- ```{r kable regressions deconvolution pCO2 1 m} -->
<!-- kable(reg_deconv_pCO2_1m, digits = c(4,4,11,3,3,2,3), caption="Regressions on values at 1 m depth.") -->
<!-- kable(reg_deconv_pCO2_1m_ano, digits = c(4,4,11,3,3,2,3), caption="Regressions on anomalies at 1 m depth.") -->
<!-- ``` -->

<!-- Using the real values rather than anomalies, the sum of the slopes is slightly higher than the slope found earlier (`r #round(sum(as.data.frame(reg_deconv_pCO2_1m)$Slope), digits=4)` vs `r #round(as.data.frame(reg_var_1m)["pCO2", "Slope"], digits=4)`). -->

<!-- Using the anomalies rather than the real values, the sum of the slopes is slightly lower than the slope found earlier (`r #round(sum(as.data.frame(reg_deconv_pCO2_1m_ano)$Slope), digits=4)` vs `r #round(as.data.frame(reg_ano_1m)["pCO2_ano", "Slope"], digits=4)`). -->

<!-- ## Deconvolution of pCO2 changes at 1 m according to Garcia-Ibanez -->
<!-- ```{r Prepare observed data for Garcia-Ibanez pCO2 at 1 m, include=FALSE} -->
<!-- #We construct a dataframe with total mean (tXX) -->
<!-- deconv_garcia_dat_pCO2_1m <- NULL -->

<!-- # total means (no grouping) -->
<!-- t <- dat0m %>% -->
<!--   summarise(tS = mean(salinity, na.rm = TRUE), -->
<!--          tT = mean(temperature, na.rm = TRUE), -->
<!--          tAT = mean(ta, na.rm = TRUE), -->
<!--          tCT = mean(dic, na.rm = TRUE), -->
<!--          tP = mean(P, na.rm = TRUE), -->
<!--          tPt = mean(Pt, na.rm = TRUE), -->
<!--          tSit = mean(Sit, na.rm = TRUE) -->
<!--          ) -->
<!-- # bring all variables together -->
<!-- deconv_garcia_dat_pCO2_1m <- dat0m %>% -->
<!--   select(sampling_date, year, monthd, year_month, CT = dic, AT = ta, -->
<!--          S = salinity, T = temperature) %>% -->
<!--   mutate(tS = t$tS, -->
<!--          tT = t$tT, -->
<!--          tAT = t$tAT, -->
<!--          tCT = t$tCT, -->
<!--          tP = t$tP, -->
<!--          tPt = t$tPt, -->
<!--          tSit = t$tSit) -->
<!-- ``` -->

<!-- ```{r Garcia-Ibanez delta pCO2 using total means for not changing variables, include=FALSE} -->
<!-- ### delta pCO2 due to temperature using total means for not changing variables -->
<!-- d <- filter(deconv_garcia_dat_pCO2_1m, !is.na(tAT), !is.na(tCT), !is.na(tS),  -->
<!--             !is.na(T)) # we eliminate date with NAs -->
<!-- d$pCO2_T_t <- carb( -->
<!--   flag = 15, -->
<!--   var1 = d$tAT * 1e-6, -->
<!--   var2 = d$tCT * 1e-6, -->
<!--   S = d$tS, -->
<!--   T = d$T, -->
<!--   P = d$tP, -->
<!--   Pt = d$tPt, -->
<!--   Sit = d$tSit, -->
<!--   k1k2 = "l", -->
<!--   kf = "pf", -->
<!--   pHscale = "T", -->
<!--   b = "l10" -->
<!--   )$pCO2 -->
<!-- dpCO2_T_dT_t <- summary(lm(d$pCO2_T_t ~ d$T))$coefficient[2,1] # slope -->
<!-- dpCO2_T_dT_t_se <- summary(lm(d$pCO2_T_t ~ d$T))$coefficient[2,2] # SE slope -->
<!-- dT_dt <- summary(lm(deconv_garcia_dat_pCO2_1m$T ~ decimal_date(deconv_garcia_dat_pCO2_1m$sampling_date)))$coefficient[2,1] # slope -->
<!-- dT_dt_se <- summary(lm(deconv_garcia_dat_pCO2_1m$T ~ decimal_date(deconv_garcia_dat_pCO2_1m$sampling_date)))$coefficient[2,2] # SE slope -->
<!-- dpCO2_T_dT_dT_dt_t <- dpCO2_T_dT_t * dT_dt -->
<!-- dpCO2_T_dT_dT_dt_t_se <- dpCO2_T_dT_dT_dt_t *  -->
<!--   sqrt((dpCO2_T_dT_t_se/dpCO2_T_dT_t)^2 + (dT_dt_se/dT_dt)^2) -->

<!-- title <- "delta pCO2 due to temperature using total means for not changing variables" -->
<!-- fit <- lm(data = d, pCO2_T_t ~ T) -->
<!-- fig_dpCO2_T_dT_t_1m <- ggreg(fit) + -->
<!--   labs(x="Temperature (total mean)", y="pCO2") + -->
<!--   Mytheme(size_labs = 10) -->
<!-- ggsave(file="output_jp/figures/fig_dpCO2_T_t_dT_1m.png", fig_dpCO2_T_dT_t_1m, width = 18, height = 12, units = "cm") -->

<!-- fit <- lm(data = deconv_garcia_dat_pCO2_1m, T ~ sampling_date) -->
<!-- fig_dT_dt_1m <- ggreg(fit) + -->
<!--   labs(x="Year", y="Temperature") + -->
<!--   Mytheme(size_labs = 10) -->
<!-- ggsave(file="output_jp/figures/fig_dT_dt_1m.png", fig_dT_dt_1m, width = 18, height = 12, units = "cm") -->

<!-- title <- "" -->
<!-- d <- filter(deconv_garcia_dat_pCO2_1m, !is.na(tAT), !is.na(tCT), !is.na(S),  -->
<!--             !is.na(tT)) # we eliminate date with NAs -->
<!-- d$pCO2_S_t <- carb( -->
<!--   flag = 15, -->
<!--   var1 = d$tAT * 1e-6, -->
<!--   var2 = d$tCT * 1e-6, -->
<!--   S = d$S, -->
<!--   T = d$tT, -->
<!--   P = d$tP, -->
<!--   Pt = d$tPt, -->
<!--   Sit = d$tSit, -->
<!--   k1k2 = "l", -->
<!--   kf = "pf", -->
<!--   pHscale = "T", -->
<!--   b = "l10" -->
<!--   )$pCO2 -->
<!-- dpCO2_S_dS_t <- summary(lm(d$pCO2_S_t ~ d$S))$coefficient[2,1] # slope -->
<!-- dpCO2_S_dS_t_se <- summary(lm(d$pCO2_S_t ~ d$S))$coefficient[2,2] # SE slope -->
<!-- dS_dt <- summary(lm(deconv_garcia_dat_pCO2_1m$S ~ decimal_date(deconv_garcia_dat_pCO2_1m$sampling_date)))$coefficient[2,1] # slope -->
<!-- dS_dt_se <- summary(lm(deconv_garcia_dat_pCO2_1m$S ~ decimal_date(deconv_garcia_dat_pCO2_1m$sampling_date)))$coefficient[2,2] # SE slope -->
<!-- dpCO2_S_dT_dS_dt_t <- dpCO2_S_dS_t * dS_dt -->
<!-- dpCO2_S_dS_dS_dt_t_se <- dpCO2_S_dT_dS_dt_t *  -->
<!--   sqrt((dpCO2_S_dS_t_se/dpCO2_S_dS_t)^2 + (dS_dt_se/dS_dt)^2) -->

<!-- title <- "delta pCO2 due to salinity using total means for not changing variables" -->
<!-- fit <- lm(data = d, pCO2_S_t ~ S) -->
<!-- fig_dpCO2_S_dS_t_1m <- ggreg(fit) + -->
<!--   labs(x="Salinity (total mean)", y="pCO2") + -->
<!--   Mytheme(size_labs = 10) -->
<!-- ggsave(file="output_jp/figures/fig_dpCO2_S_dS_t_1m.png", fig_dpCO2_S_dS_t_1m, width = 18, height = 12, units = "cm") -->

<!-- fit <- lm(data = deconv_garcia_dat_pCO2_1m, S ~ sampling_date) -->
<!-- fig_dS_dt_1m <- ggreg(fit) + -->
<!--   labs(x="Year", y="Salinity") + -->
<!--   Mytheme(size_labs = 10) -->
<!-- ggsave(file="output_jp/figures/fig_dS_dt_1m.png", fig_dS_dt_1m, width = 18, height = 12, units = "cm") -->

<!-- title <- "" -->
<!-- d <- filter(deconv_garcia_dat_pCO2_1m, !is.na(AT), !is.na(tCT), !is.na(tS),  -->
<!--             !is.na(tT)) # we eliminate date with NAs -->
<!-- d$pCO2_AT_t <- carb( -->
<!--   flag = 15, -->
<!--   var1 = d$AT * 1e-6, -->
<!--   var2 = d$tCT * 1e-6, -->
<!--   S = d$tS, -->
<!--   T = d$tT, -->
<!--   P = d$tP, -->
<!--   Pt = d$tPt, -->
<!--   Sit = d$tSit, -->
<!--   k1k2 = "l", -->
<!--   kf = "pf", -->
<!--   pHscale = "T", -->
<!--   b = "l10" -->
<!--   )$pCO2 -->
<!-- dpCO2_AT_dAT_t <- summary(lm(d$pCO2_AT_t ~ d$AT))$coefficient[2,1] # slope -->
<!-- dpCO2_AT_dAT_t_se <- summary(lm(d$pCO2_AT_t ~ d$AT))$coefficient[2,2] # SE slope -->
<!-- dAT_dt <- summary(lm(deconv_garcia_dat_pCO2_1m$AT ~ decimal_date(deconv_garcia_dat_pCO2_1m$sampling_date)))$coefficient[2,1] # slope -->
<!-- dAT_dt_se <- summary(lm(deconv_garcia_dat_pCO2_1m$AT ~ decimal_date(deconv_garcia_dat_pCO2_1m$sampling_date)))$coefficient[2,2] # SE slope -->
<!-- dpCO2_AT_dAT_dAT_dt_t <- dpCO2_AT_dAT_t * dAT_dt -->
<!-- dpCO2_AT_dAT_dAT_dt_t_se <- dpCO2_AT_dAT_dAT_dt_t *  -->
<!--   sqrt((dpCO2_AT_dAT_t_se/dpCO2_AT_dAT_t)^2 + (dAT_dt_se/dAT_dt)^2) -->

<!-- title <- "delta pCO2 due to AT using total means for not changing variables" -->
<!-- fit <- lm(data = d, pCO2_AT_t ~ AT) -->
<!-- fig_dpCO2_AT_dAT_t_1m <- ggreg(fit) + -->
<!--   labs(x="AT (total mean)", y="pCO2") + -->
<!--   Mytheme(size_labs = 10) -->
<!-- ggsave(file="output_jp/figures/fig_dpCO2_AT_dT_t_1m.png", fig_dpCO2_AT_dAT_t_1m, width = 18, height = 12, units = "cm") -->

<!-- title <- "" -->
<!-- fit <- lm(data = deconv_garcia_dat_pCO2_1m, AT ~ sampling_date) -->
<!-- fig_dAT_dt_1m <- ggreg(fit) + -->
<!--   labs(x="Year", y="AT") + -->
<!--   Mytheme(size_labs = 10) -->
<!-- ggsave(file="output_jp/figures/fig_dAT_dt_1m.png", fig_dAT_dt_1m, width = 18, height = 12, units = "cm") -->

<!-- ### delta pCO2 due to CT using total means for not changing variables -->
<!-- d <- filter(deconv_garcia_dat_pCO2_1m, !is.na(tAT), !is.na(CT), !is.na(tS),  -->
<!--             !is.na(tT)) # we eliminate date with NAs -->
<!-- d$pCO2_CT_t <- carb( -->
<!--   flag = 15, -->
<!--   var1 = d$tAT * 1e-6, -->
<!--   var2 = d$CT * 1e-6, -->
<!--   S = d$tS, -->
<!--   T = d$tT, -->
<!--   P = d$tP, -->
<!--   Pt = d$tPt, -->
<!--   Sit = d$tSit, -->
<!--   k1k2 = "l", -->
<!--   kf = "pf", -->
<!--   pHscale = "T", -->
<!--   b = "l10" -->
<!--   )$pCO2 -->
<!-- dpCO2_CT_dCT_t <- summary(lm(d$pCO2_CT_t ~ d$CT))$coefficient[2,1] # slope -->
<!-- dpCO2_CT_dCT_t_se <- summary(lm(d$pCO2_CT_t ~ d$CT))$coefficient[2,2] # SE slope -->
<!-- dCT_dt <- summary(lm(deconv_garcia_dat_pCO2_1m$CT ~ decimal_date(deconv_garcia_dat_pCO2_1m$sampling_date)))$coefficient[2,1] # slope -->
<!-- dCT_dt_se <- summary(lm(deconv_garcia_dat_pCO2_1m$CT ~ decimal_date(deconv_garcia_dat_pCO2_1m$sampling_date)))$coefficient[2,2] # SEslope -->
<!-- dpCO2_CT_dCT_dCT_dt_t <- dpCO2_CT_dCT_t * dCT_dt -->
<!-- dpCO2_CT_dCT_dCT_dt_t_se <- dpCO2_CT_dCT_dCT_dt_t * -->
<!--   sqrt((dpCO2_CT_dCT_t_se/dpCO2_CT_dCT_t)^2 + (dCT_dt_se/dCT_dt)^2) -->

<!-- title <- "delta pCO2 due to CT using total means for not changing variables" -->
<!-- fit <- lm(data = d, pCO2_CT_t ~ CT) -->
<!-- fig_dpCO2_CT_dCT_t_1m <- ggreg(fit) + -->
<!--   labs(x="CT (total mean)", y="pCO2") + -->
<!--   Mytheme(size_labs = 10) -->
<!-- ggsave(file="output_jp/figures/fig_dpCO2_CT_t_dT_1m.png", fig_dpCO2_CT_dCT_t_1m, width = 18, height = 12, units = "cm") -->

<!-- title <- "" -->
<!-- fit <- lm(data = deconv_garcia_dat_pCO2_1m, CT ~ sampling_date) -->
<!-- fig_dCT_dt_1m <- ggreg(fit) + -->
<!--   labs(x="Year", y="CT") + -->
<!--   Mytheme(size_labs = 10) -->
<!-- ggsave(file="output_jp/figures/fig_dCT_dt_1m.png", fig_dCT_dt_1m, width = 18, height = 12, units = "cm") -->

<!-- deconv_garcia_total_pCO2 <- tibble( -->
<!--   means = c("total", "total", "total", "total", "total"), -->
<!--   var = c("T", "S", "AT", "CT", "sum"), -->
<!--   dpCO2T_dvar = c(dpCO2_T_dT_t, dpCO2_S_dS_t, dpCO2_AT_dAT_t, dpCO2_CT_dCT_t, NA), -->
<!--   dpCO2T_dvar_SE = c(dpCO2_T_dT_t_se, dpCO2_S_dS_t_se, dpCO2_AT_dAT_t_se, dpCO2_CT_dCT_t_se, NA), -->
<!--   dvar_dt = c(dT_dt, dS_dt, dAT_dt, dCT_dt, NA), -->
<!--   dvar_dt_SE = c(dT_dt_se, dS_dt_se, dAT_dt_se, dCT_dt_se, NA), -->
<!--   dpCO2T_dt = c(dpCO2_T_dT_dT_dt_t, dpCO2_S_dT_dS_dt_t, dpCO2_AT_dAT_dAT_dt_t, -->
<!--               dpCO2_CT_dCT_dCT_dt_t, -->
<!--               sum(dpCO2_T_dT_dT_dt_t, dpCO2_S_dT_dS_dt_t, dpCO2_AT_dAT_dAT_dt_t, -->
<!--               dpCO2_CT_dCT_dCT_dt_t)), -->
<!--   dpCO2T_dt_SE = c(dpCO2_T_dT_dT_dt_t_se, dpCO2_S_dS_dS_dt_t_se, -->
<!--                    dpCO2_AT_dAT_dAT_dt_t_se, dpCO2_CT_dCT_dCT_dt_t_se,  -->
<!--                    sqrt(sum(dpCO2_T_dT_dT_dt_t_se^2, dpCO2_S_dS_dS_dt_t_se^2, -->
<!--                         dpCO2_AT_dAT_dAT_dt_t_se^2, dpCO2_CT_dCT_dCT_dt_t_se^2)) -->
<!--                    ) -->
<!-- ) -->
<!-- ``` -->

<!-- ```{r Deconvolution pCO2 1 m according to Garcia-Ibanez using rates of anomalies, include=FALSE} -->
<!-- dT_dt <- reg_ano_1m["Temperature_ano", "Slope"] -->
<!-- dS_dt <- reg_ano_1m["Salinity_ano", "Slope"] -->
<!-- dAT_dt <- reg_ano_1m["ta_ano", "Slope"] -->
<!-- dCT_dt <- reg_ano_1m["dic_ano", "Slope"] -->
<!-- dT_dt_se <- reg_ano_1m["Temperature_ano", "SE Slope"] -->
<!-- dS_dt_se <- reg_ano_1m["Salinity_ano", "SE Slope"] -->
<!-- dAT_dt_se <- reg_ano_1m["ta_ano", "SE Slope"] -->
<!-- dCT_dt_se <- reg_ano_1m["dic_ano", "SE Slope"] -->

<!-- #recalculate dpHT_dt with new dvar_dt above (on anomalies) -->
<!-- dpCO2_T_dT_dT_dt_t <- dpCO2_T_dT_t * dT_dt -->
<!-- dpCO2_S_dT_dS_dt_t <- dpCO2_S_dS_t * dS_dt -->
<!-- dpCO2_AT_dAT_dAT_dt_t <- dpCO2_AT_dAT_t * dAT_dt -->
<!-- dpCO2_CT_dCT_dCT_dt_t <- dpCO2_CT_dCT_t * dCT_dt -->

<!-- #recalculate dpCO2T_dt_SE with new dvar_dt AND dpCO2T_dt above (on anomalies) -->
<!-- dpCO2_T_dT_dT_dt_t_se <- abs(dpCO2_T_dT_dT_dt_t) * sqrt((dpCO2_T_dT_t_se/dpCO2_T_dT_t)^2 + -->
<!--                                                  (dT_dt_se/dT_dt)^2) -->
<!-- dpCO2_S_dS_dS_dt_t_se <- abs(dpCO2_S_dT_dS_dt_t) * sqrt((dpCO2_S_dS_t_se/dpCO2_S_dS_t)^2 + (dS_dt_se/dS_dt)^2) -->
<!-- dpCO2_AT_dAT_dAT_dt_t_se <- abs(dpCO2_AT_dAT_dAT_dt_t) * -->
<!--   sqrt((dpCO2_AT_dAT_t_se/dpCO2_AT_dAT_t)^2 + (dAT_dt_se/dAT_dt)^2) -->
<!-- dpCO2_CT_dCT_dCT_dt_t_se <- abs(dpCO2_CT_dCT_dCT_dt_t) * -->
<!--   sqrt((dpCO2_CT_dCT_t_se/dpCO2_CT_dCT_t)^2 + (dCT_dt_se/dCT_dt)^2) -->

<!-- deconv_garcia_total_pCO2_ano <- tibble( -->
<!--   means = c("total", "total", "total", "total", "total"), -->
<!--   var = c("T", "S", "AT", "CT", "sum"), -->
<!--   dpCO2T_dvar = c(dpCO2_T_dT_t, dpCO2_S_dS_t, dpCO2_AT_dAT_t, dpCO2_CT_dCT_t, NA), -->
<!--   dpCO2T_dvar_SE = c(dpCO2_T_dT_t_se, dpCO2_S_dS_t_se, dpCO2_AT_dAT_t_se, dpCO2_CT_dCT_t_se, NA), -->
<!--   dvar_dt = c(dT_dt, dS_dt, dAT_dt, dCT_dt, NA), -->
<!--   dvar_dt_SE = c(dT_dt_se, dS_dt_se, dAT_dt_se, dCT_dt_se, NA), -->
<!--   dpCO2T_dt = c(dpCO2_T_dT_dT_dt_t, dpCO2_S_dT_dS_dt_t, dpCO2_AT_dAT_dAT_dt_t, -->
<!--               dpCO2_CT_dCT_dCT_dt_t, -->
<!--               sum(dpCO2_T_dT_dT_dt_t, dpCO2_S_dT_dS_dt_t, dpCO2_AT_dAT_dAT_dt_t, -->
<!--               dpCO2_CT_dCT_dCT_dt_t)), -->
<!--   dpCO2T_dt_SE = c(dpCO2_T_dT_dT_dt_t_se, dpCO2_S_dS_dS_dt_t_se, dpCO2_AT_dAT_dAT_dt_t_se, -->
<!--               dpCO2_CT_dCT_dCT_dt_t_se,  -->
<!--               sqrt(sum(dpCO2_T_dT_dT_dt_t_se^2, dpCO2_S_dS_dS_dt_t_se^2, -->
<!--                         dpCO2_AT_dAT_dAT_dt_t_se^2, dpCO2_CT_dCT_dCT_dt_t_se^2)) -->
<!--               ), -->
<!--   dpCO2T_dt_percent = c(dpCO2_T_dT_dT_dt_t, dpCO2_S_dT_dS_dt_t, dpCO2_AT_dAT_dAT_dt_t, -->
<!--               dpCO2_CT_dCT_dCT_dt_t,  -->
<!--               sum(dpCO2_T_dT_dT_dt_t, dpCO2_S_dT_dS_dt_t, -->
<!--                   dpCO2_AT_dAT_dAT_dt_t, dpCO2_CT_dCT_dCT_dt_t))* -->
<!--     100 /sum(dpCO2_T_dT_dT_dt_t, dpCO2_S_dT_dS_dt_t, -->
<!--              dpCO2_AT_dAT_dAT_dt_t, dpCO2_CT_dCT_dCT_dt_t) -->
<!-- ) -->
<!-- ``` -->

<!-- This is using total means for non-changing variables. -->

<!-- ```{r kable Garcia-Ibanez pCO2 1 m} -->
<!-- kable(deconv_garcia_total_pCO2, digits = c(1,4,4,4,4,4,4,4), caption="Contributions of 4 variables to pCO2 change (using observed values)") -->
<!-- kable(deconv_garcia_total_pCO2_ano, digits = c(1,4,4,7,4,4,4,4,0), caption="Contributions of 4 variables to pCO2 change (using anomalies)") -->
<!-- ``` -->

<!-- ## Deconvolution of pH changes at 50 m -->
<!-- ```{r Deconvolution of pH changes at 50 m, include=FALSE} -->
<!-- #We construct a dataframe with monthly means for the entire series (mXX) as well as real data (without mrefix m) -->
<!-- deconv_dat_50m <- tibble(date=as.POSIXct(dat50m$sampling_date), mAT=dat0m$ta[dat50m$monthd]*1e-6, mCT=dat0m$dic[dat50m$monthd]*1e-6, mS=dat0m$salinity[dat50m$monthd], mT=dat0m$temperature[dat50m$monthd], P=dat50m$depth/10, Pt=dat50m$Pt, Sit=dat50m$Sit, AT=dat50m$ta*1e-6, CT=dat50m$dic*1e-6, S=dat50m$salinity, T=dat50m$temperature) -->

<!-- #d <- NULL; deconv_50m <- NULL # d is for the data to use in carb, deconv is to store the results -->
<!-- deconv_pH_50m <- tibble(date=as.POSIXct(dat50m$sampling_date)) -->
<!-- d <- filter(deconv_dat_50m, !is.na(mAT), !is.na(mCT), !is.na(mS), !is.na(T)) # we eliminate rows with NAs -->
<!-- deconv_pH_T_50m <- tibble(date=d$date, -->
<!--                      deconv_pH_T_50m = seacarb::carb(flag=15, var1=d$mAT, var2=d$mCT, S=d$mS, T=d$T,  -->
<!--                                       P=d$P, Pt=d$Pt, Sit=d$Sit, k1k2 = "l", kf = "pf",  -->
<!--                                       pHscale = "T", b="l10")$pH -->
<!--                      ) -->
<!-- d <- filter(deconv_dat_50m, !is.na(mAT), !is.na(mCT), !is.na(S), !is.na(mT)) # we eliminate rows with NAs -->

<!-- deconv_pH_S_50m <- tibble(date=d$date, -->
<!--                           deconv_pH_S_50m=carb(flag=15, var1=d$mAT, var2=d$mCT, S=d$S, T=d$mT,  -->
<!--                                            P=d$P, Pt=d$Pt, Sit=d$Sit, k1k2 = "l", kf = "pf",  -->
<!--                                            pHscale = "T", b="l10")$pH -->
<!--                           ) -->
<!-- d <- filter(deconv_dat_50m, !is.na(AT), !is.na(mCT), !is.na(mS), !is.na(mT)) # we eliminate date with NAs -->
<!-- deconv_pH_AT_50m <- tibble(date=d$date, -->
<!--                      deconv_pH_AT_50m=carb(flag=15, var1=d$AT, var2=d$mCT, S=d$mS, T=d$mT,  -->
<!--                                        P=d$P, Pt=d$Pt, Sit=d$Sit, k1k2 = "l", kf = "pf",  -->
<!--                                        pHscale = "T", b="l10")$pH) -->
<!-- d <- filter(deconv_dat_50m, !is.na(mAT), !is.na(CT), !is.na(mS), !is.na(mT)) # we eliminate date with NAs -->
<!-- deconv_pH_CT_50m <- tibble(date=d$date, -->
<!--                      deconv_pH_CT_50m=carb(flag=15, var1=d$mAT, var2=d$CT, S=d$mS, T=d$mT,  -->
<!--                                        P=d$P, Pt=d$Pt, Sit=d$Sit, k1k2 = "l", kf = "pf",  -->
<!--                                        pHscale = "T", b="l10")$pH -->
<!--                      ) -->

<!-- # Bring all results together -->
<!-- deconv_pH_50m <- deconv_pH_50m %>% -->
<!--   left_join(deconv_pH_T_50m) %>% -->
<!--   left_join(deconv_pH_S_50m) %>% -->
<!--   left_join(deconv_pH_AT_50m) %>% -->
<!--   left_join(deconv_pH_CT_50m) -->
<!-- deconv_pH_50m$monthd <- month(deconv_pH_50m$date) -->
<!-- # Calculate monthly means -->
<!-- tmp <- ungroup(deconv_pH_50m) %>% -->
<!--   group_by(monthd) %>% -->
<!--   summarise( -->
<!--   deconv_pH_T_50m_month = mean(deconv_pH_T_50m, na.rm = TRUE), -->
<!--   deconv_pH_S_50m_month = mean(deconv_pH_S_50m, na.rm = TRUE), -->
<!--   deconv_pH_AT_50m_month = mean(deconv_pH_AT_50m, na.rm = TRUE), -->
<!--   deconv_pH_CT_50m_month = mean(deconv_pH_CT_50m, na.rm = TRUE) -->
<!--   ) -->

<!-- # Calculate anomalies -->
<!-- ano_deconv_pH_50m <- left_join(ungroup(deconv_pH_50m), tmp, by = "monthd") %>% -->
<!--   mutate( -->
<!--   deconv_pH_T_50m_ano = deconv_pH_T_50m - deconv_pH_T_50m_month, -->
<!--   deconv_pH_S_50m_ano = deconv_pH_S_50m - deconv_pH_S_50m_month, -->
<!--   deconv_pH_AT_50m_ano = deconv_pH_AT_50m - deconv_pH_AT_50m_month, -->
<!--   deconv_pH_CT_50m_ano = deconv_pH_CT_50m - deconv_pH_CT_50m_month -->
<!--   ) %>% -->
<!--   select(-deconv_pH_T_50m, -deconv_pH_S_50m, -deconv_pH_AT_50m, -deconv_pH_CT_50m, -deconv_pH_T_50m_month, -deconv_pH_S_50m_month, -deconv_pH_AT_50m_month, -deconv_pH_CT_50m_month) -->

<!-- # Regressions and tables of key parameters on real values (as opposed to anomalies) -->
<!-- var_list <- -->
<!--   c( -->
<!--   "deconv_pH_T_50m", -->
<!--   "deconv_pH_S_50m", -->
<!--   "deconv_pH_AT_50m", -->
<!--   "deconv_pH_CT_50m" -->
<!--   ) -->
<!-- lms <- lapply(var_list, function(x) { -->
<!--   summary(lm(substitute(i ~ decimal_date(date), list(i = as.name(x))), data = deconv_pH_50m)) -->
<!--   }) -->
<!-- reg <- NULL -->
<!-- for (i in 1:length(var_list)) { -->
<!--   #one loops through all anomalies -->
<!--   # calculate probability of fstatistic because it cannot be extracted from lms above -->
<!--   # see http://stats.stackexchange.com/questions/92824/extracting-the-model-p-value-for-a-multiple-regression-in-r -->
<!--   # slope returned by lm is per second -->
<!--   prob <- -->
<!--   pf(lms[[i]]$fstatistic[1], -->
<!--   lms[[i]]$fstatistic[2], -->
<!--   lms[[i]]$fstatistic[3], -->
<!--   lower.tail = FALSE) -->
<!--   reg <- -->
<!--   rbind(reg, as.numeric( -->
<!--   c( -->
<!--     lms[[i]]$coefficients[2, 1], -->
<!--     lms[[i]]$coefficients[2, 2], -->
<!--   lms[[i]]$coefficients[2, 4], -->
<!--   lms[[i]]$coefficients[1, 1], -->
<!--   lms[[i]]$coefficients[1, 2], -->
<!--   lms[[i]]$coefficients[1, 4], -->
<!--   lms[[i]]$r.squared, -->
<!--   prob -->
<!--   ) -->
<!--   )) -->
<!-- } -->
<!-- colnames(reg) <- -->
<!--   c("Slope", -->
<!--   "SE Slope", -->
<!--   "P Slope", -->
<!--   "Intercept", -->
<!--   "SE int.", -->
<!--   "P int.", -->
<!--   "R2", -->
<!--   "P value") -->
<!-- row.names(reg) <- var_list -->
<!-- reg_deconv_pH_50m <- reg -->

<!-- # Regressions and tables of key parameters on anomalies (as opposed to real values) -->
<!-- var_list <- -->
<!--   c( -->
<!--   "deconv_pH_T_50m_ano", -->
<!--   "deconv_pH_S_50m_ano", -->
<!--   "deconv_pH_AT_50m_ano", -->
<!--   "deconv_pH_CT_50m_ano" -->
<!--   ) -->
<!-- lms <- lapply(var_list, function(x) { -->
<!--   summary(lm(substitute(i ~ decimal_date(date), list(i = as.name(x))), data = ano_deconv_pH_50m)) -->
<!--   }) -->
<!-- reg <- NULL -->
<!-- for (i in 1:length(var_list)) { -->
<!--   #one loops through all anomalies -->
<!--   # calculate probability of fstatistic because it cannot be extracted from lms above -->
<!--   # see http://stats.stackexchange.com/questions/92824/extracting-the-model-p-value-for-a-multiple-regression-in-r -->
<!--   # slope returned by lm is per second -->
<!--   prob <- -->
<!--   pf(lms[[i]]$fstatistic[1], -->
<!--   lms[[i]]$fstatistic[2], -->
<!--   lms[[i]]$fstatistic[3], -->
<!--   lower.tail = FALSE) -->
<!--   reg <- -->
<!--   rbind(reg, as.numeric( -->
<!--   c( -->
<!--     lms[[i]]$coefficients[2, 1], -->
<!--     lms[[i]]$coefficients[2, 2], -->
<!--   lms[[i]]$coefficients[2, 4], -->
<!--   lms[[i]]$coefficients[1, 1], -->
<!--   lms[[i]]$coefficients[1, 2], -->
<!--   lms[[i]]$coefficients[1, 4], -->
<!--   lms[[i]]$r.squared, -->
<!--   prob -->
<!--   ) -->
<!--   )) -->
<!-- } -->
<!-- colnames(reg) <- -->
<!--   c("Slope", -->
<!--   "SE Slope", -->
<!--   "P Slope", -->
<!--   "Intercept", -->
<!--   "SE int.", -->
<!--   "P int.", -->
<!--   "R2", -->
<!--   "P value") -->
<!-- row.names(reg) <- var_list -->
<!-- reg_deconv_pH_50m_ano <- reg -->

<!-- # Plot with real values -->
<!-- deconv_pH_50m_melt <-  gather(data = select(deconv_pH_50m, -monthd), key = variable, value=value, -date) -->
<!-- fig_deconv_pH_50m <- ggplot(deconv_pH_50m_melt) + geom_point(aes(x=date, y=value, color=variable), size=0.5) + -->
<!--   facet_grid(variable ~., scales="free_y") +  -->
<!--   xlab("Time") + ylab("pH (total scale)")+ -->
<!--   Mytheme() + -->
<!--   scale_colour_discrete(guide="none") -->
<!-- ggsave(file="output_jp/figures/fig_deconv_pH_50m.png", fig_deconv_pH_50m, width = 18, height = 20, units = "cm") -->

<!-- # Plot with anomalies -->
<!-- ano_deconv_pH_50m_melt <-  gather(data = select(ano_deconv_pH_50m, -monthd), key = variable, value=value, -date) -->
<!-- fig_deconv_pH_ano_50m <- ggplot(ano_deconv_pH_50m_melt) + geom_point(aes(x=date, y=value, color=variable), size=0.5) + -->
<!--   facet_grid(variable ~., scales="free_y") +  -->
<!--   xlab("Time") + ylab("pH (total scale)")+ -->
<!--   Mytheme() + -->
<!--   scale_colour_discrete(guide="none") -->
<!-- ggsave(file="output_jp/figures/fig_deconv_pH_ano_50m.png", fig_deconv_pH_ano_50m, width = 18, height = 20, units = "cm") -->
<!-- ``` -->

<!-- Below is the deconvolution performed on values at 50 m. Here, dvar is the monthly mean value of T, S and CT for the entire time-series. -->

<!-- ![fig_deconv_pH_50m.png](output_jp/figures/fig_deconv_pH_50m.png) -->
<!-- Below is the deconvolution performed on anomalies at 50 m. Here, dvar is the monthly mean value of the anomalies of T, S and CT for the entire time-series. -->

<!-- ![fig_deconv_pH_ano_50m.png](output_jp/figures/fig_deconv_pH_ano_50m.png) -->

<!-- ```{r kable regressions deconvolution pH 50 m} -->
<!-- kable(reg_deconv_pH_50m, digits = c(4,4,11,3,3,2,3), caption="Regressions on values at 50 m depth.") -->
<!-- kable(reg_deconv_pH_50m_ano, digits = c(4,4,11,3,3,2,3), caption="Regressions on anomalies at 50 m depth.") -->
<!-- ``` -->

<!-- Using the real values rather than anomalies, the sum of the slopes is higher that the slope found earlier (`r #round(sum(as.data.frame(reg_deconv_pH_50m)$Slope), digits=4)` vs `r #round(as.data.frame(reg_var_1m)["pH", "Slope"], digits=4)`). -->

<!-- Using the anomalies rather than the real values, the sum of the slopes is much closer to the slope found earlier (`r #round(sum(as.data.frame(reg_deconv_pH_50m_ano)$Slope), digits=4)` vs `r #round(as.data.frame(reg_ano_1m)["pH_ano", "Slope"], digits=4)`). -->

<!-- ## Deconvolution of pCO2 changes at 50 m -->
<!-- ```{r Deconvolution of pCO2 changes at 50 m, include=FALSE} -->
<!-- # We follow the method of Garcia-Ibanez described above. -->
<!-- # construct a dataframe with monthly means for the entire series (mXX) as well as real data (without mrefix m) -->
<!-- deconv_dat_50m <- tibble(date=as.POSIXct(dat50m$sampling_date), mAT=dat0m$ta[dat50m$monthd]*1e-6, mCT=dat0m$dic[dat50m$monthd]*1e-6, mS=dat0m$salinity[dat50m$monthd], mT=dat0m$temperature[dat50m$monthd], P=dat50m$depth/10, Pt=dat50m$Pt, Sit=dat50m$Sit, AT=dat50m$ta*1e-6, CT=dat50m$dic*1e-6, S=dat50m$salinity, T=dat50m$temperature) -->


<!-- #d <- NULL; deconv_50m <- NULL # d is for the data to use in carb, deconv is to store the results -->
<!-- #deconv_pCO2_50m <- dplyr::mutate(date = as.POSIXct(dat50m$sampling_date)) -->
<!-- #d <- NULL; deconv <- NULL # d is for the data to use in carb, deconv is to store the results -->
<!-- deconv_pCO2_50m <- tibble(date = as.POSIXct(dat50m$sampling_date)) -->
<!-- d <- filter(deconv_dat_50m, !is.na(mAT), !is.na(mCT), !is.na(mS), !is.na(T)) # we eliminate rows with NAs -->
<!-- deconv_pCO2_T_50m <- tibble(date=d$date, -->
<!--                      deconv_pCO2_T_50m=carb(flag=15, var1=d$mAT, var2=d$mCT, S=d$mS, T=d$T,  -->
<!--                                       P=d$P, Pt=d$Pt, Sit=d$Sit, k1k2 = "l", kf = "pf",  -->
<!--                                       pHscale = "T", b="l10")$pCO2 -->
<!--                      ) -->
<!-- d <- filter(deconv_dat_50m, !is.na(mAT), !is.na(mCT), !is.na(S), !is.na(mT)) # we eliminate rows with NAs -->

<!-- deconv_pCO2_S_50m <- tibble(date=d$date, -->
<!--                           deconv_pCO2_S_50m=carb(flag=15, var1=d$mAT, var2=d$mCT, S=d$S, T=d$mT,  -->
<!--                                            P=d$P, Pt=d$Pt, Sit=d$Sit, k1k2 = "l", kf = "pf",  -->
<!--                                            pHscale = "T", b="l10")$pCO2 -->
<!--                           ) -->
<!-- d <- filter(deconv_dat_50m, !is.na(AT), !is.na(mCT), !is.na(mS), !is.na(mT)) # we eliminate date with NAs -->
<!-- deconv_pCO2_AT_50m <- tibble(date=d$date, -->
<!--                      deconv_pCO2_AT_50m=carb(flag=15, var1=d$AT, var2=d$mCT, S=d$mS, T=d$mT,  -->
<!--                                        P=d$P, Pt=d$Pt, Sit=d$Sit, k1k2 = "l", kf = "pf",  -->
<!--                                        pHscale = "T", b="l10")$pCO2) -->
<!-- d <- filter(deconv_dat_50m, !is.na(mAT), !is.na(CT), !is.na(mS), !is.na(mT)) # we eliminate date with NAs -->
<!-- deconv_pCO2_CT_50m <- tibble(date=d$date, -->
<!--                      deconv_pCO2_CT_50m=carb(flag=15, var1=d$mAT, var2=d$CT, S=d$mS, T=d$mT,  -->
<!--                                        P=d$P, Pt=d$Pt, Sit=d$Sit, k1k2 = "l", kf = "pf",  -->
<!--                                        pHscale = "T", b="l10")$pCO2 -->
<!--                      ) -->

<!-- # Bring all results together -->
<!-- deconv_pCO2_50m <- deconv_pCO2_50m %>% -->
<!--   left_join(deconv_pCO2_T_50m) %>% -->
<!--   left_join(deconv_pCO2_S_50m) %>% -->
<!--   left_join(deconv_pCO2_AT_50m) %>% -->
<!--   left_join(deconv_pCO2_CT_50m) -->
<!-- deconv_pCO2_50m$monthd <- month(deconv_pCO2_50m$date) -->
<!-- # Calculate monthly means -->
<!-- tmp <- ungroup(deconv_pCO2_50m) %>% -->
<!--   group_by(monthd) %>% -->
<!--   summarise( -->
<!--   deconv_pCO2_T_50m_month = mean(deconv_pCO2_T_50m, na.rm = TRUE), -->
<!--   deconv_pCO2_S_50m_month = mean(deconv_pCO2_S_50m, na.rm = TRUE), -->
<!--   deconv_pCO2_AT_50m_month = mean(deconv_pCO2_AT_50m, na.rm = TRUE), -->
<!--   deconv_pCO2_CT_50m_month = mean(deconv_pCO2_CT_50m, na.rm = TRUE) -->
<!--   ) -->

<!-- # Calculate anomalies -->
<!-- ano_deconv_pCO2_50m <- left_join(ungroup(deconv_pCO2_50m), tmp, by = "monthd") %>% -->
<!--   mutate( -->
<!--   deconv_pCO2_T_50m_ano = deconv_pCO2_T_50m - deconv_pCO2_T_50m_month, -->
<!--   deconv_pCO2_S_50m_ano = deconv_pCO2_S_50m - deconv_pCO2_S_50m_month, -->
<!--   deconv_pCO2_AT_50m_ano = deconv_pCO2_AT_50m - deconv_pCO2_AT_50m_month, -->
<!--   deconv_pCO2_CT_50m_ano = deconv_pCO2_CT_50m - deconv_pCO2_CT_50m_month -->
<!--   ) %>% -->
<!--   select(-deconv_pCO2_T_50m, -deconv_pCO2_S_50m, -deconv_pCO2_AT_50m, -deconv_pCO2_CT_50m, -deconv_pCO2_T_50m_month, -deconv_pCO2_S_50m_month, -deconv_pCO2_AT_50m_month, -deconv_pCO2_CT_50m_month) -->

<!-- # Regressions and tables of key parameters on real values (as opposed to anomalies) -->
<!-- var_list <- -->
<!--   c( -->
<!--   "deconv_pCO2_T_50m", -->
<!--   "deconv_pCO2_S_50m", -->
<!--   "deconv_pCO2_AT_50m", -->
<!--   "deconv_pCO2_CT_50m" -->
<!--   ) -->
<!-- lms <- lapply(var_list, function(x) { -->
<!--   summary(lm(substitute(i ~ decimal_date(date), list(i = as.name(x))), data = deconv_pCO2_50m)) -->
<!--   }) -->
<!-- reg <- NULL -->
<!-- for (i in 1:length(var_list)) { -->
<!--   #one loops through all anomalies -->
<!--   # calculate probability of fstatistic because it cannot be extracted from lms above -->
<!--   # see http://stats.stackexchange.com/questions/92824/extracting-the-model-p-value-for-a-multiple-regression-in-r -->
<!--   # slope returned by lm is per second -->
<!--   prob <- -->
<!--   pf(lms[[i]]$fstatistic[1], -->
<!--   lms[[i]]$fstatistic[2], -->
<!--   lms[[i]]$fstatistic[3], -->
<!--   lower.tail = FALSE) -->
<!--   reg <- -->
<!--   rbind(reg, as.numeric( -->
<!--   c( -->
<!--     lms[[i]]$coefficients[2, 1], -->
<!--     lms[[i]]$coefficients[2, 2], -->
<!--   lms[[i]]$coefficients[2, 4], -->
<!--   lms[[i]]$coefficients[1, 1], -->
<!--   lms[[i]]$coefficients[1, 2], -->
<!--   lms[[i]]$coefficients[1, 4], -->
<!--   lms[[i]]$r.squared, -->
<!--   prob -->
<!--   ) -->
<!--   )) -->
<!-- } -->
<!-- colnames(reg) <- -->
<!--   c("Slope", -->
<!--   "SE Slope", -->
<!--   "P Slope", -->
<!--   "Intercept", -->
<!--   "SE int.", -->
<!--   "P int.", -->
<!--   "R2", -->
<!--   "P value") -->
<!-- row.names(reg) <- var_list -->
<!-- reg_deconv_pCO2_50m <- reg -->

<!-- # Regressions and tables of key parameters on anomalies (as opposed to real values) -->
<!-- var_list <- -->
<!--   c( -->
<!--   "deconv_pCO2_T_50m_ano", -->
<!--   "deconv_pCO2_S_50m_ano", -->
<!--   "deconv_pCO2_AT_50m_ano", -->
<!--   "deconv_pCO2_CT_50m_ano" -->
<!--   ) -->
<!-- lms <- lapply(var_list, function(x) { -->
<!--   summary(lm(substitute(i ~ decimal_date(date), list(i = as.name(x))), data = ano_deconv_pCO2_50m)) -->
<!--   }) -->
<!-- reg <- NULL -->
<!-- for (i in 1:length(var_list)) { -->
<!--   #one loops through all anomalies -->
<!--   # calculate probability of fstatistic because it cannot be extracted from lms above -->
<!--   # see http://stats.stackexchange.com/questions/92824/extracting-the-model-p-value-for-a-multiple-regression-in-r -->
<!--   # slope returned by lm is per second -->
<!--   prob <- -->
<!--   pf(lms[[i]]$fstatistic[1], -->
<!--   lms[[i]]$fstatistic[2], -->
<!--   lms[[i]]$fstatistic[3], -->
<!--   lower.tail = FALSE) -->
<!--   reg <- -->
<!--   rbind(reg, as.numeric( -->
<!--   c( -->
<!--     lms[[i]]$coefficients[2, 1], -->
<!--     lms[[i]]$coefficients[2, 2], -->
<!--   lms[[i]]$coefficients[2, 4], -->
<!--   lms[[i]]$coefficients[1, 1], -->
<!--   lms[[i]]$coefficients[1, 2], -->
<!--   lms[[i]]$coefficients[1, 4], -->
<!--   lms[[i]]$r.squared, -->
<!--   prob -->
<!--   ) -->
<!--   )) -->
<!-- } -->
<!-- colnames(reg) <- -->
<!--   c("Slope", -->
<!--   "SE Slope", -->
<!--   "P Slope", -->
<!--   "Intercept", -->
<!--   "SE int.", -->
<!--   "P int.", -->
<!--   "R2", -->
<!--   "P value") -->
<!-- row.names(reg) <- var_list -->
<!-- reg_deconv_pCO2_50m_ano <- reg -->

<!-- # Plot with real values -->
<!-- deconv_pCO2_50m_melt <-  gather(data = select(deconv_pCO2_50m, -monthd), key = variable, value=value, -date) -->
<!-- fig_deconv_pCO2_50m <- ggplot(deconv_pCO2_50m_melt) + geom_point(aes(x=date, y=value, color=variable), size=0.5) + -->
<!--   facet_grid(variable ~., scales="free_y") +  -->
<!--   xlab("Time") + ylab("pCO2 (uatm)")+ -->
<!--   Mytheme() + -->
<!--   scale_colour_discrete(guide="none") -->
<!-- ggsave(file="output_jp/figures/fig_deconv_pCO2_50m.png", fig_deconv_pCO2_50m, width = 18, height = 20, units = "cm") -->

<!-- # Plot with anomalies -->
<!-- ano_deconv_pCO2_50m_melt <-  gather(data = select(ano_deconv_pCO2_50m, -monthd), key = variable, value=value, -date) -->
<!-- fig_deconv_pCO2_50m_ano <- ggplot(ano_deconv_pCO2_50m_melt) + geom_point(aes(x=date, y=value, color=variable), size=0.5) + -->
<!--   facet_grid(variable ~., scales="free_y") +  -->
<!--   xlab("Time") + ylab("pCO2 (uatm)")+ -->
<!--   Mytheme() + -->
<!--   scale_colour_discrete(guide="none") -->
<!-- ggsave(file="output_jp/figures/fig_deconv_pCO2_50m_ano.png", fig_deconv_pCO2_50m_ano, width = 18, height = 20, units = "cm") -->
<!-- ``` -->
<!-- Below is the deconvolution performed on values. Here, dvar is the monthly mean value of T, S and CT for the entire time-series. -->

<!-- ![fig_deconv_pCO2_50m.png](output_jp/figures/fig_deconv_pCO2_50m.png) -->
<!-- Below is the deconvolution performed on anomalies Here, dvar is the monthly mean value of the anomalies of T, S and CT for the entire time-series. -->

<!-- ![fig_deconv_pCO2_50m_ano.png](output_jp/figures/fig_deconv_pCO2_50m_ano.png) -->

<!-- ```{r kable regressions deconvolution pCO2 50 m} -->
<!-- kable(reg_deconv_pCO2_50m, digits = c(4,4,11,3,3,2,3), caption="Regressions on values at 50 m depth.") -->
<!-- kable(reg_deconv_pCO2_50m_ano, digits = c(4,4,11,3,3,2,3), caption="Regressions on anomalies at 50 m depth.") -->
<!-- ``` -->

<!-- Using the real values rather than anomalies, the sum of the slopes is larger than the slope found earlier (`r #round(sum(as.data.frame(reg_deconv_pCO2_50m)$Slope), digits=4)` vs `r #round(as.data.frame(reg_var_1m)["pCO2", "Slope"], digits=4)`). -->

<!-- Using the anomalies rather than the real values, the sum of the slopes is lower than the slope found earlier (`r #round(sum(as.data.frame(reg_deconv_pCO2_50m_ano)$Slope), digits=4)` vs `r #round(as.data.frame(reg_ano_1m)["pCO2_ano", "Slope"], digits=4)`). -->

<!-- ## Deconvolution of observed pH changes at 50 m according to Garcia-Ibanez -->
<!-- ```{r Prepare observed data for Garcia-Ibanez pH at 50 m, include=FALSE} -->
<!-- #We construct a dataframe with total mean (tXX) -->
<!-- deconv_garcia_dat_pH_50m <- NULL -->

<!-- # Third, total means (no grouping) -->
<!-- dat50m <- ungroup(dat50m) -->
<!-- t <- dat50m %>% -->
<!--   summarise(tS = mean(salinity, na.rm = TRUE), -->
<!--          tT = mean(temperature, na.rm = TRUE), -->
<!--          tAT = mean(ta, na.rm = TRUE), -->
<!--          tCT = mean(dic, na.rm = TRUE), -->
<!--          tP = mean(P, na.rm = TRUE), -->
<!--          tPt = mean(Pt, na.rm = TRUE), -->
<!--          tSit = mean(Sit, na.rm = TRUE) -->
<!--          ) -->
<!-- # bring all variables together -->
<!-- deconv_garcia_dat_pH_50m <- dat50m %>% -->
<!--   select(sampling_date, year, monthd, CT = dic, AT = ta, -->
<!--          S = salinity, T = temperature) %>% -->
<!--   mutate(tS = t$tS, -->
<!--          tT = t$tT, -->
<!--          tAT = t$tAT, -->
<!--          tCT = t$tCT, -->
<!--          tP = t$tP, -->
<!--          tPt = t$tPt, -->
<!--          tSit = t$tSit) -->
<!-- ``` -->

<!-- ### Deconvolution of pH changes at 50 m using total means for not changing variables -->

<!-- ```{r Garcia-Ibanez delta pH at 50 m using total means for not changing variables, include=FALSE} -->
<!-- ### delta pH due to temperature using total means for not changing variables -->
<!-- d <- filter(deconv_garcia_dat_pH_50m, !is.na(tAT), !is.na(tCT), !is.na(tS),  -->
<!--             !is.na(T)) # we eliminate date with NAs -->
<!-- d$pH_T_t <- carb( -->
<!--   flag = 15, -->
<!--   var1 = d$tAT * 1e-6, -->
<!--   var2 = d$tCT * 1e-6, -->
<!--   S = d$tS, -->
<!--   T = d$T, -->
<!--   P = d$tP, -->
<!--   Pt = d$tPt, -->
<!--   Sit = d$tSit, -->
<!--   k1k2 = "l", -->
<!--   kf = "pf", -->
<!--   pHscale = "T", -->
<!--   b = "l10" -->
<!--   )$pH -->
<!-- dpH_T_dT_t <- summary(lm(d$pH_T_t ~ d$T))$coefficient[2,1] # slope -->
<!-- dpH_T_dT_t_se <- summary(lm(d$pH_T_t ~ d$T))$coefficient[2,2] # SE slope -->
<!-- dT_dt <- summary(lm(deconv_garcia_dat_pH_50m$T ~ decimal_date(deconv_garcia_dat_pH_50m$sampling_date)))$coefficient[2,1] # slope -->
<!-- dT_dt_se <- summary(lm(deconv_garcia_dat_pH_50m$T ~ decimal_date(deconv_garcia_dat_pH_50m$sampling_date)))$coefficient[2,2] # SE slope -->
<!-- dpH_T_dT_dT_dt_t <- dpH_T_dT_t * dT_dt -->
<!-- dpH_T_dT_dT_dt_t_se <- abs(dpH_T_dT_dT_dt_t) * sqrt((dpH_T_dT_t_se/dpH_T_dT_t)^2 + -->
<!--                                                  (dT_dt_se/dT_dt)^2) -->

<!-- title <- "delta pH due to temperature using total means for not changing variables" -->
<!-- fit <- lm(data = d, pH_T_t ~ T) -->
<!-- fig_dpH_T_dT_t_50m <- ggreg(fit) + -->
<!--   labs(x="Temperature (total mean)", y="pH") + -->
<!--   Mytheme(size_labs = 10) -->
<!-- ggsave(file="output_jp/figures/fig_dpH_T_t_dT_50m.png", fig_dpH_T_dT_t_50m, width = 18, height = 12, units = "cm") -->

<!-- fit <- lm(data = deconv_garcia_dat_pH_50m, T ~ sampling_date) -->
<!-- fig_dT_dt_50m <- ggreg(fit) + -->
<!--   labs(x="Year", y="Temperature") + -->
<!--   Mytheme(size_labs = 10) -->
<!-- ggsave(file="output_jp/figures/fig_dT_dt_50m.png", fig_dT_dt_50m, width = 18, height = 12, units = "cm") -->

<!-- title <- "" -->
<!-- d <- filter(deconv_garcia_dat_pH_50m, !is.na(tAT), !is.na(tCT), !is.na(S),  -->
<!--             !is.na(tT)) # we eliminate date with NAs -->
<!-- d$pH_S_t <- carb( -->
<!--   flag = 15, -->
<!--   var1 = d$tAT * 1e-6, -->
<!--   var2 = d$tCT * 1e-6, -->
<!--   S = d$S, -->
<!--   T = d$tT, -->
<!--   P = d$tP, -->
<!--   Pt = d$tPt, -->
<!--   Sit = d$tSit, -->
<!--   k1k2 = "l", -->
<!--   kf = "pf", -->
<!--   pHscale = "T", -->
<!--   b = "l10" -->
<!--   )$pH -->
<!-- dpH_S_dS_t <- summary(lm(d$pH_S_t ~ d$S))$coefficient[2,1] # slope -->
<!-- dpH_S_dS_t_se <- summary(lm(d$pH_S_t ~ d$S))$coefficient[2,2] # SE slope -->
<!-- dS_dt <- summary(lm(deconv_garcia_dat_pH_50m$S ~ decimal_date(deconv_garcia_dat_pH_50m$sampling_date)))$coefficient[2,1] # slope -->
<!-- dS_dt_se <- summary(lm(deconv_garcia_dat_pH_50m$S ~ decimal_date(deconv_garcia_dat_pH_50m$sampling_date)))$coefficient[2,2] # SE slope -->
<!-- dpH_S_dT_dS_dt_t <- dpH_S_dS_t * dS_dt -->
<!-- dpH_S_dS_dS_dt_t_se <- abs(dpH_S_dT_dS_dt_t) * sqrt((dpH_S_dS_t_se/dpH_S_dS_t)^2 + (dS_dt_se/dS_dt)^2) -->

<!-- title <- "delta pH due to salinity using total means for not changing variables" -->
<!-- fit <- lm(data = d, pH_S_t ~ S) -->
<!-- fig_dpH_S_dS_t_50m <- ggreg(fit) + -->
<!--   labs(x="Salinity (total mean)", y="pH") + -->
<!--   Mytheme(size_labs = 10) -->
<!-- ggsave(file="output_jp/figures/fig_dpH_S_dS_t_50m.png", fig_dpH_S_dS_t_50m, width = 18, height = 12, units = "cm") -->

<!-- fit <- lm(data = deconv_garcia_dat_pH_50m, S ~ sampling_date) -->
<!-- fig_dS_dt_50m <- ggreg(fit) + -->
<!--   labs(x="Year", y="Salinity") + -->
<!--   Mytheme(size_labs = 10) -->
<!-- ggsave(file="output_jp/figures/fig_dS_dt_50m.png", fig_dS_dt_50m, width = 18, height = 12, units = "cm") -->

<!-- title <- "" -->
<!-- d <- filter(deconv_garcia_dat_pH_50m, !is.na(AT), !is.na(tCT), !is.na(tS),  -->
<!--             !is.na(tT)) # we eliminate date with NAs -->
<!-- d$pH_AT_t <- carb( -->
<!--   flag = 15, -->
<!--   var1 = d$AT * 1e-6, -->
<!--   var2 = d$tCT * 1e-6, -->
<!--   S = d$tS, -->
<!--   T = d$tT, -->
<!--   P = d$tP, -->
<!--   Pt = d$tPt, -->
<!--   Sit = d$tSit, -->
<!--   k1k2 = "l", -->
<!--   kf = "pf", -->
<!--   pHscale = "T", -->
<!--   b = "l10" -->
<!--   )$pH -->
<!-- dpH_AT_dAT_t <- summary(lm(d$pH_AT_t ~ d$AT))$coefficient[2,1] # slope -->
<!-- dpH_AT_dAT_t_se <- summary(lm(d$pH_AT_t ~ d$AT))$coefficient[2,2] # SE slope -->
<!-- dAT_dt <- summary(lm(deconv_garcia_dat_pH_50m$AT ~ decimal_date(deconv_garcia_dat_pH_50m$sampling_date)))$coefficient[2,1] # slope -->
<!-- dAT_dt_se <- summary(lm(deconv_garcia_dat_pH_50m$AT ~ decimal_date(deconv_garcia_dat_pH_50m$sampling_date)))$coefficient[2,2] # SE slope -->
<!-- dpH_AT_dAT_dAT_dt_t <- dpH_AT_dAT_t * dAT_dt -->
<!-- dpH_AT_dAT_dAT_dt_t_se <- abs(dpH_AT_dAT_dAT_dt_t) * -->
<!--   sqrt((dpH_AT_dAT_t_se/dpH_AT_dAT_t)^2 + (dAT_dt_se/dAT_dt)^2) -->

<!-- title <- "delta pH due to AT using total means for not changing variables" -->
<!-- fit <- lm(data = d, pH_AT_t ~ AT) -->
<!-- fig_dpH_AT_dAT_t_50m <- ggreg(fit) + -->
<!--   labs(x="AT (total mean)", y="pH") + -->
<!--   Mytheme(size_labs = 10) -->
<!-- ggsave(file="output_jp/figures/fig_dpH_AT_dT_t_50m.png", fig_dpH_AT_dAT_t_50m, width = 18, height = 12, units = "cm") -->

<!-- title <- "" -->
<!-- fit <- lm(data = deconv_garcia_dat_pH_50m, AT ~ sampling_date) -->
<!-- fig_dAT_dt_50m <- ggreg(fit) + -->
<!--   labs(x="Year", y="AT") + -->
<!--   Mytheme(size_labs = 10) -->
<!-- ggsave(file="output_jp/figures/fig_dAT_dt_50m.png", fig_dAT_dt_50m, width = 18, height = 12, units = "cm") -->

<!-- ### delta pH due to CT using total means for not changing variables -->
<!-- d <- filter(deconv_garcia_dat_pH_50m, !is.na(tAT), !is.na(CT), !is.na(tS),  -->
<!--             !is.na(tT)) # we eliminate date with NAs -->
<!-- d$pH_CT_t <- carb( -->
<!--   flag = 15, -->
<!--   var1 = d$tAT * 1e-6, -->
<!--   var2 = d$CT * 1e-6, -->
<!--   S = d$tS, -->
<!--   T = d$tT, -->
<!--   P = d$tP, -->
<!--   Pt = d$tPt, -->
<!--   Sit = d$tSit, -->
<!--   k1k2 = "l", -->
<!--   kf = "pf", -->
<!--   pHscale = "T", -->
<!--   b = "l10" -->
<!--   )$pH -->
<!-- dpH_CT_dCT_t <- summary(lm(d$pH_CT_t ~ d$CT))$coefficient[2,1] # slope -->
<!-- dpH_CT_dCT_t_se <- summary(lm(d$pH_CT_t ~ d$CT))$coefficient[2,2] # SE slope -->
<!-- dCT_dt <- summary(lm(deconv_garcia_dat_pH_50m$CT ~ decimal_date(deconv_garcia_dat_pH_50m$sampling_date)))$coefficient[2,1] # slope -->
<!-- dCT_dt_se <- summary(lm(deconv_garcia_dat_pH_50m$CT ~ decimal_date(deconv_garcia_dat_pH_50m$sampling_date)))$coefficient[2,2] # SEslope -->
<!-- dpH_CT_dCT_dCT_dt_t <- dpH_CT_dCT_t * dCT_dt -->
<!-- dpH_CT_dCT_dCT_dt_t_se <- abs(dpH_CT_dCT_dCT_dt_t) * -->
<!--   sqrt((dpH_CT_dCT_t_se/dpH_CT_dCT_t)^2 + (dCT_dt_se/dCT_dt)^2) -->

<!-- title <- "delta pH due to CT using total means for not changing variables" -->
<!-- fit <- lm(data = d, pH_CT_t ~ CT) -->
<!-- fig_dpH_CT_dCT_t_50m <- ggreg(fit) + -->
<!--   labs(x="CT (total mean)", y="pH") + -->
<!--   Mytheme(size_labs = 10) -->
<!-- ggsave(file="output_jp/figures/fig_dpH_CT_t_dT_50m.png", fig_dpH_CT_dCT_t_50m, width = 18, height = 12, units = "cm") -->

<!-- title <- "" -->
<!-- fit <- lm(data = deconv_garcia_dat_pH_50m, CT ~ sampling_date) -->
<!-- fig_dCT_dt_50m <- ggreg(fit) + -->
<!--   labs(x="Year", y="CT") + -->
<!--   Mytheme(size_labs = 10) -->
<!-- ggsave(file="output_jp/figures/fig_dCT_dt_50m.png", fig_dCT_dt_50m, width = 18, height = 12, units = "cm") -->

<!-- deconv_garcia_total_50m <- tibble( -->
<!--   means = c("total", "total", "total", "total", "total"), -->
<!--   var = c("T", "S", "AT", "CT", "sum"), -->
<!--   dpHT_dvar = c(dpH_T_dT_t, dpH_S_dS_t, dpH_AT_dAT_t, dpH_CT_dCT_t, NA), -->
<!--   dpHT_dvar_SE = c(dpH_T_dT_t_se, dpH_S_dS_t_se, dpH_AT_dAT_t_se, dpH_CT_dCT_t_se, NA), -->
<!--   dvar_dt = c(dT_dt, dS_dt, dAT_dt, dCT_dt, NA), -->
<!--   dvar_dt_SE = c(dT_dt_se, dS_dt_se, dAT_dt_se, dCT_dt_se, NA), -->
<!--   dpHT_dt = c(dpH_T_dT_dT_dt_t, dpH_S_dT_dS_dt_t, dpH_AT_dAT_dAT_dt_t, -->
<!--               dpH_CT_dCT_dCT_dt_t, -->
<!--               sum(dpH_T_dT_dT_dt_t, dpH_S_dT_dS_dt_t, dpH_AT_dAT_dAT_dt_t, -->
<!--               dpH_CT_dCT_dCT_dt_t)), -->
<!--   dpHT_dt_SE = c(dpH_T_dT_dT_dt_t_se, dpH_S_dS_dS_dt_t_se, dpH_AT_dAT_dAT_dt_t_se, -->
<!--               dpH_CT_dCT_dCT_dt_t_se,  -->
<!--               sqrt(sum(dpH_T_dT_dT_dt_t_se^2, dpH_S_dS_dS_dt_t_se^2, -->
<!--                         dpH_AT_dAT_dAT_dt_t_se^2, dpH_CT_dCT_dCT_dt_t_se^2)) -->
<!--               ) -->
<!-- ) -->
<!-- ``` -->

<!-- ![fig_dpH_T_t_dT_50m.png](output_jp/figures/fig_dpH_T_t_dT_50m.png) -->
<!-- ![fig_dT_dt_50m.png](output_jp/figures/fig_dT_dt_50m.png) -->
<!-- ![fig_dpH_S_dS_t_50m.png](output_jp/figures/fig_dpH_S_dS_t_50m.png) -->
<!-- ![fig_dS_dt_50m.png](output_jp/figures/fig_dS_dt_50m.png) -->
<!-- ![fig_dpH_AT_dT_t_50m.png](output_jp/figures/fig_dpH_AT_dT_t_50m.png) -->
<!-- ![fig_dAT_dt_50m.png](output_jp/figures/fig_dAT_dt_50m.png) -->
<!-- ![fig_dpH_CT_t_dT_50m.png](output_jp/figures/fig_dpH_CT_t_dT_50m.png) -->
<!-- ![fig_dCT_dt_50m.png](output_jp/figures/fig_dCT_dt_50m.png) -->

<!-- ```{r kable Garcia-Ibanez pH 50 m} -->
<!-- kable(deconv_garcia_total_50m, digits = c(1,4,4,7,4,4,4,4), caption="Contributions of 4 variables to pH change at 50 m") -->
<!-- ``` -->
<!-- ```{r Deconvolution pH 50 m according to Garcia-Ibanez using rates of anomalies, include=FALSE} -->
<!-- dT_dt <- reg_ano_50m["Temperature_ano", "Slope"] -->
<!-- dS_dt <- reg_ano_50m["Salinity_ano", "Slope"] -->
<!-- dAT_dt <- reg_ano_50m["ta_ano", "Slope"] -->
<!-- dCT_dt <- reg_ano_50m["dic_ano", "Slope"] -->
<!-- dT_dt_se <- reg_ano_50m["Temperature_ano", "SE Slope"] -->
<!-- dS_dt_se <- reg_ano_50m["Salinity_ano", "SE Slope"] -->
<!-- dAT_dt_se <- reg_ano_50m["ta_ano", "SE Slope"] -->
<!-- dCT_dt_se <- reg_ano_50m["dic_ano", "SE Slope"] -->

<!-- #recalculate dpHT_dt with new dvar_dt above (on anomalies) -->
<!-- dpH_T_dT_dT_dt_t <- dpH_T_dT_t * dT_dt -->
<!-- dpH_S_dT_dS_dt_t <- dpH_S_dS_t * dS_dt -->
<!-- dpH_AT_dAT_dAT_dt_t <- dpH_AT_dAT_t * dAT_dt -->
<!-- dpH_CT_dCT_dCT_dt_t <- dpH_CT_dCT_t * dCT_dt -->

<!-- #recalculate dpHT_dt_SE with new dvar_dt AND dpHT_dt above (on anomalies) -->
<!-- dpH_T_dT_dT_dt_t_se <- abs(dpH_T_dT_dT_dt_t) * sqrt((dpH_T_dT_t_se/dpH_T_dT_t)^2 + -->
<!--                                                  (dT_dt_se/dT_dt)^2) -->
<!-- dpH_S_dS_dS_dt_t_se <- abs(dpH_S_dT_dS_dt_t) * sqrt((dpH_S_dS_t_se/dpH_S_dS_t)^2 + (dS_dt_se/dS_dt)^2) -->
<!-- dpH_AT_dAT_dAT_dt_t_se <- abs(dpH_AT_dAT_dAT_dt_t) * -->
<!--   sqrt((dpH_AT_dAT_t_se/dpH_AT_dAT_t)^2 + (dAT_dt_se/dAT_dt)^2) -->
<!-- dpH_CT_dCT_dCT_dt_t_se <- abs(dpH_CT_dCT_dCT_dt_t) * -->
<!--   sqrt((dpH_CT_dCT_t_se/dpH_CT_dCT_t)^2 + (dCT_dt_se/dCT_dt)^2) -->



<!-- deconv_garcia_total_pH_50m_ano <- tibble( -->
<!--   means = c("total", "total", "total", "total", "total"), -->
<!--   var = c("T", "S", "AT", "CT", "sum"), -->
<!--   dpHT_dvar = c(dpH_T_dT_t, dpH_S_dS_t, dpH_AT_dAT_t, dpH_CT_dCT_t, NA), -->
<!--   dpHT_dvar_SE = c(dpH_T_dT_t_se, dpH_S_dS_t_se, dpH_AT_dAT_t_se, dpH_CT_dCT_t_se, NA), -->
<!--   dvar_dt = c(dT_dt, dS_dt, dAT_dt, dCT_dt, NA), -->
<!--   dvar_dt_SE = c(dT_dt_se, dS_dt_se, dAT_dt_se, dCT_dt_se, NA), -->
<!--   dpHT_dt = c(dpH_T_dT_dT_dt_t, dpH_S_dT_dS_dt_t, dpH_AT_dAT_dAT_dt_t, -->
<!--               dpH_CT_dCT_dCT_dt_t, -->
<!--               sum(dpH_T_dT_dT_dt_t, dpH_S_dT_dS_dt_t, dpH_AT_dAT_dAT_dt_t, -->
<!--               dpH_CT_dCT_dCT_dt_t)), -->
<!--   dpHT_dt_SE = c(dpH_T_dT_dT_dt_t_se, dpH_S_dS_dS_dt_t_se, dpH_AT_dAT_dAT_dt_t_se, -->
<!--               dpH_CT_dCT_dCT_dt_t_se,  -->
<!--               sqrt(sum(dpH_T_dT_dT_dt_t_se^2, dpH_S_dS_dS_dt_t_se^2, -->
<!--                         dpH_AT_dAT_dAT_dt_t_se^2, dpH_CT_dCT_dCT_dt_t_se^2)) -->
<!--               ), -->
<!--   dpHT_dt_percent = c(dpH_T_dT_dT_dt_t, dpH_S_dT_dS_dt_t, dpH_AT_dAT_dAT_dt_t, -->
<!--               dpH_CT_dCT_dCT_dt_t,  -->
<!--               sum(dpH_T_dT_dT_dt_t, dpH_S_dT_dS_dt_t, -->
<!--                   dpH_AT_dAT_dAT_dt_t, dpH_CT_dCT_dCT_dt_t))* -->
<!--     100 /sum(dpH_T_dT_dT_dt_t, dpH_S_dT_dS_dt_t, -->
<!--              dpH_AT_dAT_dAT_dt_t, dpH_CT_dCT_dCT_dt_t) -->
<!-- ) -->
<!-- ``` -->

<!-- ```{r kable Garcia-Ibanez pH 50 m on anomalies} -->
<!-- kable(deconv_garcia_total_pH_50m_ano, digits = c(1,4,4,7,4,4,5,5,0), caption="Contributions of 4 variables to pH change (using anomalies)") -->
<!-- ``` -->


<!-- ## Deconvolution of pCO2 changes at 50 m according to Garcia-Ibanez -->
<!-- ```{r Prepare observed data for Garcia-Ibanez pCO2 at 50 m, include=FALSE} -->
<!-- #We construct a dataframe with total mean (tXX) -->
<!-- deconv_garcia_dat_pCO2_50m <- NULL -->

<!-- # total means (no grouping) -->
<!-- t <- dat50m %>% -->
<!--   summarise(tS = mean(salinity, na.rm = TRUE), -->
<!--          tT = mean(temperature, na.rm = TRUE), -->
<!--          tAT = mean(ta, na.rm = TRUE), -->
<!--          tCT = mean(dic, na.rm = TRUE), -->
<!--          tP = mean(P, na.rm = TRUE), -->
<!--          tPt = mean(Pt, na.rm = TRUE), -->
<!--          tSit = mean(Sit, na.rm = TRUE) -->
<!--          ) -->
<!-- # bring all variables together -->
<!-- deconv_garcia_dat_pCO2_50m <- dat50m %>% -->
<!--   select(sampling_date, year, monthd, CT = dic, AT = ta, -->
<!--          S = salinity, T = temperature) %>% -->
<!--   mutate(tS = t$tS, -->
<!--          tT = t$tT, -->
<!--          tAT = t$tAT, -->
<!--          tCT = t$tCT, -->
<!--          tP = t$tP, -->
<!--          tPt = t$tPt, -->
<!--          tSit = t$tSit) -->
<!-- ``` -->

<!-- ```{r Garcia-Ibanez delta pCO2 at 50 m using total means for not changing variables, include=FALSE} -->
<!-- ### delta pCO2 due to temperature using total means for not changing variables -->
<!-- d <- filter(deconv_garcia_dat_pCO2_50m, !is.na(tAT), !is.na(tCT), !is.na(tS),  -->
<!--             !is.na(T)) # we eliminate date with NAs -->
<!-- d$pCO2_T_t <- carb( -->
<!--   flag = 15, -->
<!--   var1 = d$tAT * 1e-6, -->
<!--   var2 = d$tCT * 1e-6, -->
<!--   S = d$tS, -->
<!--   T = d$T, -->
<!--   P = d$tP, -->
<!--   Pt = d$tPt, -->
<!--   Sit = d$tSit, -->
<!--   k1k2 = "l", -->
<!--   kf = "pf", -->
<!--   pHscale = "T", -->
<!--   b = "l10" -->
<!--   )$pCO2 -->
<!-- dpCO2_T_dT_t <- summary(lm(d$pCO2_T_t ~ d$T))$coefficient[2,1] # slope -->
<!-- dpCO2_T_dT_t_se <- summary(lm(d$pCO2_T_t ~ d$T))$coefficient[2,2] # SE slope -->
<!-- dT_dt <- summary(lm(deconv_garcia_dat_pCO2_50m$T ~ decimal_date(deconv_garcia_dat_pCO2_50m$sampling_date)))$coefficient[2,1] # slope -->
<!-- dT_dt_se <- summary(lm(deconv_garcia_dat_pCO2_50m$T ~ decimal_date(deconv_garcia_dat_pCO2_50m$sampling_date)))$coefficient[2,2] # SE slope -->
<!-- dpCO2_T_dT_dT_dt_t <- dpCO2_T_dT_t * dT_dt -->
<!-- dpCO2_T_dT_dT_dt_t_se <- dpCO2_T_dT_dT_dt_t *  -->
<!--   sqrt((dpCO2_T_dT_t_se/dpCO2_T_dT_t)^2 + (dT_dt_se/dT_dt)^2) -->

<!-- title <- "delta pCO2 due to temperature using total means for not changing variables" -->
<!-- fit <- lm(data = d, pCO2_T_t ~ T) -->
<!-- fig_dpCO2_T_dT_t_50m <- ggreg(fit) + -->
<!--   labs(x="Temperature (total mean)", y="pCO2") + -->
<!--   Mytheme(size_labs = 10) -->
<!-- ggsave(file="output_jp/figures/fig_dpCO2_T_t_dT_50m.png", fig_dpCO2_T_dT_t_50m, width = 18, height = 12, units = "cm") -->

<!-- fit <- lm(data = deconv_garcia_dat_pCO2_50m, T ~ sampling_date) -->
<!-- fig_dT_dt_50m <- ggreg(fit) + -->
<!--   labs(x="Year", y="Temperature") + -->
<!--   Mytheme(size_labs = 10) -->
<!-- ggsave(file="output_jp/figures/fig_dT_dt_50m.png", fig_dT_dt_50m, width = 18, height = 12, units = "cm") -->

<!-- title <- "" -->
<!-- d <- filter(deconv_garcia_dat_pCO2_50m, !is.na(tAT), !is.na(tCT), !is.na(S),  -->
<!--             !is.na(tT)) # we eliminate date with NAs -->
<!-- d$pCO2_S_t <- carb( -->
<!--   flag = 15, -->
<!--   var1 = d$tAT * 1e-6, -->
<!--   var2 = d$tCT * 1e-6, -->
<!--   S = d$S, -->
<!--   T = d$tT, -->
<!--   P = d$tP, -->
<!--   Pt = d$tPt, -->
<!--   Sit = d$tSit, -->
<!--   k1k2 = "l", -->
<!--   kf = "pf", -->
<!--   pHscale = "T", -->
<!--   b = "l10" -->
<!--   )$pCO2 -->
<!-- dpCO2_S_dS_t <- summary(lm(d$pCO2_S_t ~ d$S))$coefficient[2,1] # slope -->
<!-- dpCO2_S_dS_t_se <- summary(lm(d$pCO2_S_t ~ d$S))$coefficient[2,2] # SE slope -->
<!-- dS_dt <- summary(lm(deconv_garcia_dat_pCO2_50m$S ~ decimal_date(deconv_garcia_dat_pCO2_50m$sampling_date)))$coefficient[2,1] # slope -->
<!-- dS_dt_se <- summary(lm(deconv_garcia_dat_pCO2_50m$S ~ decimal_date(deconv_garcia_dat_pCO2_50m$sampling_date)))$coefficient[2,2] # SE slope -->
<!-- dpCO2_S_dT_dS_dt_t <- dpCO2_S_dS_t * dS_dt -->
<!-- dpCO2_S_dS_dS_dt_t_se <- dpCO2_S_dT_dS_dt_t *  -->
<!--   sqrt((dpCO2_S_dS_t_se/dpCO2_S_dS_t)^2 + (dS_dt_se/dS_dt)^2) -->

<!-- title <- "delta pCO2 due to salinity using total means for not changing variables" -->
<!-- fit <- lm(data = d, pCO2_S_t ~ S) -->
<!-- fig_dpCO2_S_dS_t_50m <- ggreg(fit) + -->
<!--   labs(x="Salinity (total mean)", y="pCO2") + -->
<!--   Mytheme(size_labs = 10) -->
<!-- ggsave(file="output_jp/figures/fig_dpCO2_S_dS_t_50m.png", fig_dpCO2_S_dS_t_50m, width = 18, height = 12, units = "cm") -->

<!-- fit <- lm(data = deconv_garcia_dat_pCO2_50m, S ~ sampling_date) -->
<!-- fig_dS_dt_50m <- ggreg(fit) + -->
<!--   labs(x="Year", y="Salinity") + -->
<!--   Mytheme(size_labs = 10) -->
<!-- ggsave(file="output_jp/figures/fig_dS_dt_50m.png", fig_dS_dt_50m, width = 18, height = 12, units = "cm") -->

<!-- title <- "" -->
<!-- d <- filter(deconv_garcia_dat_pCO2_50m, !is.na(AT), !is.na(tCT), !is.na(tS),  -->
<!--             !is.na(tT)) # we eliminate date with NAs -->
<!-- d$pCO2_AT_t <- carb( -->
<!--   flag = 15, -->
<!--   var1 = d$AT * 1e-6, -->
<!--   var2 = d$tCT * 1e-6, -->
<!--   S = d$tS, -->
<!--   T = d$tT, -->
<!--   P = d$tP, -->
<!--   Pt = d$tPt, -->
<!--   Sit = d$tSit, -->
<!--   k1k2 = "l", -->
<!--   kf = "pf", -->
<!--   pHscale = "T", -->
<!--   b = "l10" -->
<!--   )$pCO2 -->
<!-- dpCO2_AT_dAT_t <- summary(lm(d$pCO2_AT_t ~ d$AT))$coefficient[2,1] # slope -->
<!-- dpCO2_AT_dAT_t_se <- summary(lm(d$pCO2_AT_t ~ d$AT))$coefficient[2,2] # SE slope -->
<!-- dAT_dt <- summary(lm(deconv_garcia_dat_pCO2_50m$AT ~ decimal_date(deconv_garcia_dat_pCO2_50m$sampling_date)))$coefficient[2,1] # slope -->
<!-- dAT_dt_se <- summary(lm(deconv_garcia_dat_pCO2_50m$AT ~ decimal_date(deconv_garcia_dat_pCO2_50m$sampling_date)))$coefficient[2,2] # SE slope -->
<!-- dpCO2_AT_dAT_dAT_dt_t <- dpCO2_AT_dAT_t * dAT_dt -->
<!-- dpCO2_AT_dAT_dAT_dt_t_se <- dpCO2_AT_dAT_dAT_dt_t *  -->
<!--   sqrt((dpCO2_AT_dAT_t_se/dpCO2_AT_dAT_t)^2 + (dAT_dt_se/dAT_dt)^2) -->

<!-- title <- "delta pCO2 due to AT using total means for not changing variables" -->
<!-- fit <- lm(data = d, pCO2_AT_t ~ AT) -->
<!-- fig_dpCO2_AT_dAT_t_50m <- ggreg(fit) + -->
<!--   labs(x="AT (total mean)", y="pCO2") + -->
<!--   Mytheme(size_labs = 10) -->
<!-- ggsave(file="output_jp/figures/fig_dpCO2_AT_dT_t_50m.png", fig_dpCO2_AT_dAT_t_50m, width = 18, height = 12, units = "cm") -->

<!-- title <- "" -->
<!-- fit <- lm(data = deconv_garcia_dat_pCO2_50m, AT ~ sampling_date) -->
<!-- fig_dAT_dt_50m <- ggreg(fit) + -->
<!--   labs(x="Year", y="AT") + -->
<!--   Mytheme(size_labs = 10) -->
<!-- ggsave(file="output_jp/figures/fig_dAT_dt_50m.png", fig_dAT_dt_50m, width = 18, height = 12, units = "cm") -->

<!-- ### delta pCO2 due to CT using total means for not changing variables -->
<!-- d <- filter(deconv_garcia_dat_pCO2_50m, !is.na(tAT), !is.na(CT), !is.na(tS),  -->
<!--             !is.na(tT)) # we eliminate date with NAs -->
<!-- d$pCO2_CT_t <- carb( -->
<!--   flag = 15, -->
<!--   var1 = d$tAT * 1e-6, -->
<!--   var2 = d$CT * 1e-6, -->
<!--   S = d$tS, -->
<!--   T = d$tT, -->
<!--   P = d$tP, -->
<!--   Pt = d$tPt, -->
<!--   Sit = d$tSit, -->
<!--   k1k2 = "l", -->
<!--   kf = "pf", -->
<!--   pHscale = "T", -->
<!--   b = "l10" -->
<!--   )$pCO2 -->
<!-- dpCO2_CT_dCT_t <- summary(lm(d$pCO2_CT_t ~ d$CT))$coefficient[2,1] # slope -->
<!-- dpCO2_CT_dCT_t_se <- summary(lm(d$pCO2_CT_t ~ d$CT))$coefficient[2,2] # SE slope -->
<!-- dCT_dt <- summary(lm(deconv_garcia_dat_pCO2_50m$CT ~ decimal_date(deconv_garcia_dat_pCO2_50m$sampling_date)))$coefficient[2,1] # slope -->
<!-- dCT_dt_se <- summary(lm(deconv_garcia_dat_pCO2_50m$CT ~ decimal_date(deconv_garcia_dat_pCO2_50m$sampling_date)))$coefficient[2,2] # SEslope -->
<!-- dpCO2_CT_dCT_dCT_dt_t <- dpCO2_CT_dCT_t * dCT_dt -->
<!-- dpCO2_CT_dCT_dCT_dt_t_se <- dpCO2_CT_dCT_dCT_dt_t * -->
<!--   sqrt((dpCO2_CT_dCT_t_se/dpCO2_CT_dCT_t)^2 + (dCT_dt_se/dCT_dt)^2) -->

<!-- title <- "delta pCO2 due to CT using total means for not changing variables" -->
<!-- fit <- lm(data = d, pCO2_CT_t ~ CT) -->
<!-- fig_dpCO2_CT_dCT_t_50m <- ggreg(fit) + -->
<!--   labs(x="CT (total mean)", y="pCO2") + -->
<!--   Mytheme(size_labs = 10) -->
<!-- ggsave(file="output_jp/figures/fig_dpCO2_CT_t_dT_50m.png", fig_dpCO2_CT_dCT_t_50m, width = 18, height = 12, units = "cm") -->

<!-- title <- "" -->
<!-- fit <- lm(data = deconv_garcia_dat_pCO2_50m, CT ~ sampling_date) -->
<!-- fig_dCT_dt_50m <- ggreg(fit) + -->
<!--   labs(x="Year", y="CT") + -->
<!--   Mytheme(size_labs = 10) -->
<!-- ggsave(file="output_jp/figures/fig_dCT_dt_50m.png", fig_dCT_dt_50m, width = 18, height = 12, units = "cm") -->

<!-- deconv_garcia_total_pCO2_50m <- tibble( -->
<!--   means = c("total", "total", "total", "total", "total"), -->
<!--   var = c("T", "S", "AT", "CT", "sum"), -->
<!--   dpCO2T_dvar = c(dpCO2_T_dT_t, dpCO2_S_dS_t, dpCO2_AT_dAT_t, dpCO2_CT_dCT_t, NA), -->
<!--   dpCO2T_dvar_SE = c(dpCO2_T_dT_t_se, dpCO2_S_dS_t_se, dpCO2_AT_dAT_t_se, dpCO2_CT_dCT_t_se, NA), -->
<!--   dvar_dt = c(dT_dt, dS_dt, dAT_dt, dCT_dt, NA), -->
<!--   dvar_dt_SE = c(dT_dt_se, dS_dt_se, dAT_dt_se, dCT_dt_se, NA), -->
<!--   dpCO2T_dt = c(dpCO2_T_dT_dT_dt_t, dpCO2_S_dT_dS_dt_t, dpCO2_AT_dAT_dAT_dt_t, -->
<!--               dpCO2_CT_dCT_dCT_dt_t, -->
<!--               sum(dpCO2_T_dT_dT_dt_t, dpCO2_S_dT_dS_dt_t, dpCO2_AT_dAT_dAT_dt_t, -->
<!--               dpCO2_CT_dCT_dCT_dt_t)), -->
<!--   dpCO2T_dt_SE = c(dpCO2_T_dT_dT_dt_t_se, dpCO2_S_dS_dS_dt_t_se, -->
<!--                    dpCO2_AT_dAT_dAT_dt_t_se, dpCO2_CT_dCT_dCT_dt_t_se,  -->
<!--                    sqrt(sum(dpCO2_T_dT_dT_dt_t_se^2, dpCO2_S_dS_dS_dt_t_se^2, -->
<!--                         dpCO2_AT_dAT_dAT_dt_t_se^2, dpCO2_CT_dCT_dCT_dt_t_se^2)) -->
<!--                    ) -->
<!-- ) -->
<!-- ``` -->

<!-- ```{r Deconvolution pCO2 50 m according to Garcia-Ibanez using rates of anomalies, include=FALSE} -->
<!-- dT_dt <- reg_ano_50m["Temperature_ano", "Slope"] -->
<!-- dS_dt <- reg_ano_50m["Salinity_ano", "Slope"] -->
<!-- dAT_dt <- reg_ano_50m["ta_ano", "Slope"] -->
<!-- dCT_dt <- reg_ano_50m["dic_ano", "Slope"] -->
<!-- dT_dt_se <- reg_ano_50m["Temperature_ano", "SE Slope"] -->
<!-- dS_dt_se <- reg_ano_50m["Salinity_ano", "SE Slope"] -->
<!-- dAT_dt_se <- reg_ano_50m["ta_ano", "SE Slope"] -->
<!-- dCT_dt_se <- reg_ano_50m["dic_ano", "SE Slope"] -->

<!-- #recalculate dpHT_dt with new dvar_dt above (on anomalies) -->
<!-- dpCO2_T_dT_dT_dt_t <- dpCO2_T_dT_t * dT_dt -->
<!-- dpCO2_S_dT_dS_dt_t <- dpCO2_S_dS_t * dS_dt -->
<!-- dpCO2_AT_dAT_dAT_dt_t <- dpCO2_AT_dAT_t * dAT_dt -->
<!-- dpCO2_CT_dCT_dCT_dt_t <- dpCO2_CT_dCT_t * dCT_dt -->

<!-- #recalculate dpCO2T_dt_SE with new dvar_dt AND dpCO2T_dt above (on anomalies) -->
<!-- dpCO2_T_dT_dT_dt_t_se <- abs(dpCO2_T_dT_dT_dt_t) * sqrt((dpCO2_T_dT_t_se/dpCO2_T_dT_t)^2 + -->
<!--                                                  (dT_dt_se/dT_dt)^2) -->
<!-- dpCO2_S_dS_dS_dt_t_se <- abs(dpCO2_S_dT_dS_dt_t) * sqrt((dpCO2_S_dS_t_se/dpCO2_S_dS_t)^2 + (dS_dt_se/dS_dt)^2) -->
<!-- dpCO2_AT_dAT_dAT_dt_t_se <- abs(dpCO2_AT_dAT_dAT_dt_t) * -->
<!--   sqrt((dpCO2_AT_dAT_t_se/dpCO2_AT_dAT_t)^2 + (dAT_dt_se/dAT_dt)^2) -->
<!-- dpCO2_CT_dCT_dCT_dt_t_se <- abs(dpCO2_CT_dCT_dCT_dt_t) * -->
<!--   sqrt((dpCO2_CT_dCT_t_se/dpCO2_CT_dCT_t)^2 + (dCT_dt_se/dCT_dt)^2) -->

<!-- deconv_garcia_total_pCO2_50m_ano <- tibble( -->
<!--   means = c("total", "total", "total", "total", "total"), -->
<!--   var = c("T", "S", "AT", "CT", "sum"), -->
<!--   dpCO2T_dvar = c(dpCO2_T_dT_t, dpCO2_S_dS_t, dpCO2_AT_dAT_t, dpCO2_CT_dCT_t, NA), -->
<!--   dpCO2T_dvar_SE = c(dpCO2_T_dT_t_se, dpCO2_S_dS_t_se, dpCO2_AT_dAT_t_se, dpCO2_CT_dCT_t_se, NA), -->
<!--   dvar_dt = c(dT_dt, dS_dt, dAT_dt, dCT_dt, NA), -->
<!--   dvar_dt_SE = c(dT_dt_se, dS_dt_se, dAT_dt_se, dCT_dt_se, NA), -->
<!--   dpCO2T_dt = c(dpCO2_T_dT_dT_dt_t, dpCO2_S_dT_dS_dt_t, dpCO2_AT_dAT_dAT_dt_t, -->
<!--               dpCO2_CT_dCT_dCT_dt_t, -->
<!--               sum(dpCO2_T_dT_dT_dt_t, dpCO2_S_dT_dS_dt_t, dpCO2_AT_dAT_dAT_dt_t, -->
<!--               dpCO2_CT_dCT_dCT_dt_t)), -->
<!--   dpCO2T_dt_SE = c(dpCO2_T_dT_dT_dt_t_se, dpCO2_S_dS_dS_dt_t_se, dpCO2_AT_dAT_dAT_dt_t_se, -->
<!--               dpCO2_CT_dCT_dCT_dt_t_se,  -->
<!--               sqrt(sum(dpCO2_T_dT_dT_dt_t_se^2, dpCO2_S_dS_dS_dt_t_se^2, -->
<!--                         dpCO2_AT_dAT_dAT_dt_t_se^2, dpCO2_CT_dCT_dCT_dt_t_se^2)) -->
<!--               ), -->
<!--   dpCO2T_dt_percent = c(dpCO2_T_dT_dT_dt_t, dpCO2_S_dT_dS_dt_t, dpCO2_AT_dAT_dAT_dt_t, -->
<!--               dpCO2_CT_dCT_dCT_dt_t,  -->
<!--               sum(dpCO2_T_dT_dT_dt_t, dpCO2_S_dT_dS_dt_t, -->
<!--                   dpCO2_AT_dAT_dAT_dt_t, dpCO2_CT_dCT_dCT_dt_t))* -->
<!--     100 /sum(dpCO2_T_dT_dT_dt_t, dpCO2_S_dT_dS_dt_t, -->
<!--              dpCO2_AT_dAT_dAT_dt_t, dpCO2_CT_dCT_dCT_dt_t) -->
<!-- ) -->
<!-- ``` -->

<!-- This is using total means for non-changing variables. -->

<!-- ```{r kable Garcia-Ibanez pCO2 50 m} -->
<!-- kable(deconv_garcia_total_pCO2_50m, digits = c(1,4,4,4,4,4,4,4), caption="Contributions of 4 variables to pCO2 change at 50 m (using observed values)") -->
<!-- kable(deconv_garcia_total_pCO2_50m_ano, digits = c(1,4,4,7,4,4,4,4,0), caption="Contributions of 4 variables to pCO2 change at 50 m (using anomalies)") -->
<!-- ``` -->

## Issue of total alkalinity
```{r Total alkalinity Point B, include=FALSE}

# AT versus salinity at the surface per month with facet
p1 <- ggplot(data=dplyr::filter(dat, depth== 0)) +
  aes(salinity, ta) +
  geom_point(na.rm=TRUE, size=size_point) +
  stat_smooth(method=lm, na.rm=TRUE, show.legend=FALSE, se=FALSE, colour="black", size=0.5) +
  facet_wrap(~ month) +
  scale_x_continuous(limits = c(36.8, 38.4), breaks=c(37, 37.5, 38), expand = c(0,0)) +
  scale_y_continuous(limits = c(2490, 2600), expand = c(0,0)) +
  labs(title = "Point B (1 m, with month of sampling)", x = "Salinity", y = expression(paste("Total alkalinity (",mu, "mol ", kg^-1,")"))) +
  Mytheme()
png(file = "output_jp/figures/fig_ta_vs_salinity_month_pointB_0m.png", 
    width = 20, height = 13, units = "cm", res = 300)
print(p1)
dev.off()

# AT versus salinity at the surface per year with facet
p1 <- ggplot(data=dplyr::filter(dat, depth== 0)) +
  aes(salinity, ta) +
  geom_point(na.rm=TRUE, size=size_point) +
  stat_smooth(method=lm, na.rm=TRUE, show.legend=FALSE, se=FALSE, colour="black", size=0.5) +
  facet_wrap(~ year) +
  scale_x_continuous(limits = c(36.8, 38.4), breaks=c(37, 37.5, 38), expand = c(0,0)) +
  scale_y_continuous(limits = c(2490, 2600), expand = c(0,0)) +
  labs(title = NULL, x = "Salinity", y = expression(paste("Total alkalinity (",mu, "mol ", kg^-1,")"))) +
Mytheme_facet()
ggsave(p1, file = "output_jp/figures/fig_ta_vs_salinity_year_pointB_0m.png", 
    width = 6, height = 6)

# AT versus salinity at the surface per year with loop
panel <- c("(a)","(b)","(c)","(d)","(e)","(f)","(g)","(h)","(i)", "(j)", "(k)", "(l)", "(m)")
tmp <- filter(dat, depth== 0, sampling_date < cutoff_date)
p <- NULL; j <- 0
for (i in unique(tmp$year)[-length(unique(tmp$year))]) {
  #i <- 13
  j <- j+1
  print(j)
  p[[j]] <- ggplot(data=filter(tmp, tmp$year==i), aes(x=salinity, y=ta, colour=month)) +
    geom_point(na.rm=TRUE, size=2) +
    stat_smooth(method=lm, na.rm=TRUE, show.legend=FALSE, se=FALSE, colour="black", size=0.5) +
    scale_x_continuous(limits = c(36.8, 38.5), breaks=c(37, 37.5, 38, 38.5), expand = c(0,0)) +
    scale_y_continuous(limits = c(2490, 2600), expand = c(0,0)) +
    labs(title = NULL, x = NULL, y = NULL) +
    annotate(geom = "text", x=36.9, y=2495, label= as.character(i), hjust=0, vjust=0, size=3) +
    annotate(geom = "text", x=36.9, y=2590, label= panel[[j]], hjust=0, vjust=0, size=3) +
    Mytheme(size_labs = 9) +
    scale_color_viridis(name="Month", discrete=TRUE, option="plasma") + 
    theme(aspect.ratio = 1,
          plot.margin = margin(t = 0, r = 0, b = 0, l = 0, unit = "cm"),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          legend.title = element_blank(),
          legend.key = element_rect(colour = 'white', fill = 'white', size = 0),
          legend.background = element_rect(fill="white", size=0.15),
          legend.key.width = unit(1, "cm"),
          legend.position='none')
if (j %in% c(1,4,7, 10)) {p[[j]] <- p[[j]] + labs(y=expression(paste(italic(A)[T], " (",mu, "mol ", kg^-1,")")))}
  else {
    p[[j]] <- p[[j]] + theme(axis.text.y = element_blank())
    p[[j]] <- p[[j]] + theme(plot.margin = margin(t = 0, r = 0.3, b = 0, l = 0, unit = "cm"))
  }
 if (j %in% c(7,8,9)) {p[[j]] <- p[[j]] + labs(x = "Salinity")
 p[[j]] <- p[[j]] + theme(axis.title.x = element_text(margin=margin(t = 0.2, r = 0, b = 0.2, l = 0, unit="cm")))
 }
 else {
    p[[j]] <- p[[j]] + theme(axis.text.x = element_blank())
 }
  #   #p[[j]] <- p[[j]] + theme(axis.title.x = element_text(margin=margin(t = 0.2, r = 0, b = 0.2, l = 0, unit="cm")))
  #   #p[[j]] <- p[[j]] + theme(plot.margin = margin(t = 0, r = 0, b = 0, l = 0, unit = "cm"))
}
g1 <- plot_grid(p[[1]], p[[2]], p[[3]], p[[4]], p[[5]], p[[6]], p[[7]], p[[8]], 
                p[[9]], p[[10]], p[[11]], p[[12]], ncol=3, align="vh")
grobs <- ggplotGrob(p[[1]] + theme(legend.position="top"))$grobs
legend_top <- grobs[[which(sapply(grobs, function(x) x$name) == "guide-box")]]
g <- plot_grid(legend_top, g1, ncol = 1, rel_heights = c(0.15, 1))
ggsave(file="output_jp/figures/fig6.pdf", g, width = 16, height = 15, units = "cm")


# AT=f(S) with all data
lms <- summary(lm(data = dat0m, ta ~ salinity))
prob <- pf(lms$fstatistic[1],lms$fstatistic[2],lms$fstatistic[3],lower.tail=FALSE)
reg_AT_S_all <- cbind(as.numeric(c(lms$coefficients[2,1], lms$coefficients[2,2], 
                                       lms$coefficients[2,4], lms$coefficients[1,1],
                                       lms$coefficients[1,2], lms$fstatistic[1], lms$fstatistic[3], 
                                       lms$coefficients[1,4], lms$r.squared, prob)))
colnames(reg_AT_S_all) <- c("AT")
row.names(reg_AT_S_all) <- c("Slope", "SE Slope", "P Slope","Intercept","SE int.","P int.", "F", "df",
                    "R2","P value")

p1 <- ggplot(data=dat0m) +
  aes(x= salinity, y=ta) +
  geom_point(na.rm=TRUE, size=size_point) +
  stat_smooth(method=lm, na.rm=TRUE, show.legend=FALSE, se=FALSE, colour="black", size=0.5) +
  labs(title = "With monthly means", x = "Salinity", y = expression(paste("Total alkalinity (",mu, "mol ", kg^-1,")"))) +
  Mytheme()
ggsave(p1, filename = "output_jp/figures/fig_ta_vs_salinity_all_pointB_0m.png", width = 20, height = 13, units = "cm")

# AT=f(S) with monthly means
lms <- summary(lm(data = dat0m, ta ~ salinity))
prob <- pf(lms$fstatistic[1],lms$fstatistic[2],lms$fstatistic[3],lower.tail=FALSE)
reg_AT_S_monthly <- cbind(as.numeric(c(lms$coefficients[2,1], lms$coefficients[2,2], 
                                       lms$coefficients[2,4], lms$coefficients[1,1],
                                       lms$coefficients[1,2], lms$fstatistic[1], lms$fstatistic[3], 
                                       lms$coefficients[1,4], lms$r.squared, prob)))
colnames(reg_AT_S_monthly) <- c("AT")
row.names(reg_AT_S_monthly) <- c("Slope", "SE Slope", "P Slope","Intercept","SE int.","P int.", "F", "df",
                    "R2","P value")

p1 <- ggplot(data=dat_month0m) +
  aes(x= Salinity, y=AT) +
  geom_point(na.rm=TRUE, size=size_point) +
  stat_smooth(method=lm, na.rm=TRUE, show.legend=FALSE, se=FALSE, colour="black", size=0.5) +
  labs(title = "With all data", x = "Salinity", 
       y = expression(paste("Total alkalinity (",mu, "mol ", kg^-1,")"))) +
  Mytheme()
png(file = "output_jp/figures/fig_ta_vs_salinity_monthly_means_pointB_0m.png", 
    width = 20, height = 13, units = "cm", res = 300)
print(p1)
dev.off()


# Alkalinity as a function of precipitation
w <- tibble::as_tibble(read.table(paste0(path, "data/meteo_nice_airport/Meteo_2007_2015.csv"), header=T, sep=",", dec=".", as.is=T, na.strings = c("NA", "-999", "999999")))
w$sampling_date <- ymd(w$sampling_date)
w$days <- wday(w$sampling_date, label = TRUE, abbr = FALSE)
w$group <- format(w$sampling_date - 1, "%Y%W") # Group the weeks tuesday to monday
w <- w %>%
   group_by(group) %>%
   mutate(rr_cumsum =  cumsum(rr)  ) #cumsum of precipitation tuesday to monday
# take the monday precipitation value (cumsum) and match it with TA of the day after (tuesday).
 w_monday <- w %>%
   filter(days == "Monday" | days== "Lundi")
 w_monday$group <- as.numeric(w_monday$group)
 w_monday$group <-w_monday$group + 1 # Add + 1 to w$group to match with AT
 
#dat0m$days <- wday(dat0m$sampling_date)
dat0m$group <- format(dat0m$sampling_date, "%Y%W") # Create "group" column in dat0m for AT
dat0m$group <- as.numeric(dat0m$group)

# merge the 2 df
w_AT_precip <- left_join(dat0m,w_monday[,c(2,43:45)], by="group") %>%
  rename(sampling_date=sampling_date.x)
 
# PLOTS
precip_cumsum <-
  ggplot(w_AT_precip, aes(x = sampling_date, y = rr_cumsum)) +
  scale_x_datetime(breaks = date_breaks("2 year"), labels = date_format("%Y")) +
  geom_point(colour = "blue", na.rm=TRUE) +
  labs(title = NULL, x = "Time", y = "Weekly precipitation (mm)") +
  Mytheme(size_labs = 9) +
  theme(aspect.ratio = 1/2,
        plot.margin = margin(t=0.25, r=0.5, b=0, l=0, unit = "cm"),
        axis.title.x = element_text(margin=margin(t=0.15, r=0, b=0.25, l=0, unit = "cm")))
  #annotation_custom(grob_A)
  
precip_ta <- ggplot(w_AT_precip, aes(x = rr_cumsum, y = ta)) +
  geom_point(colour = "blue", na.rm=TRUE) +
  labs(title = NULL,
       x = "Weekly precipitation (mm)", 
       y = expression(paste(italic(A)[T]," ","(",mu, "mol ", kg^-1,")"))) +
  Mytheme(size_labs = 9) +
  theme(aspect.ratio = 1/2,
        plot.margin = margin(t=0.25, r=0.5, b=0, l=0, unit = "cm"),
        axis.title.x = element_text(margin=margin(t=0.15, r=0, b=0.25, l=0, unit = "cm")))
  #annotation_custom(grob_B_bl)

precip_S <- ggplot(w_AT_precip, aes(x = rr_cumsum, y = salinity)) +
  geom_point(colour = "blue", na.rm=TRUE) +
  labs(title = NULL,
       x = "Weekly precipitation (mm)", 
       y = "Salinity") +
  Mytheme(size_labs = 9) +
    theme(aspect.ratio = 1/2,
        plot.margin = margin(t=0.25, r=0.5, b=0, l=0, unit = "cm"),
        axis.title.x = element_text(margin=margin(t=0.15, r=0, b=0.25, l=0, unit = "cm")))
#annotation_custom(grob_C_bl)

g <- plot_grid(precip_cumsum, precip_ta, precip_S, ncol=1, align="h")
ggsave("output_jp/figures/precip.png",g, width = 18, height = 14, units = "cm")
ggsave("output_jp/figures/figS2.pdf",g, width = 8, height = 14, units = "cm")
```

The relationship between AT and salinity using all data is shown below.
![fig_ta_vs_salinity_all_pointB_0m.png](output_jp/figures/fig_ta_vs_salinity_all_pointB_0m.png)

The relationship between AT and salinity using monthly means is shown below.
![fig_ta_vs_salinity_monthly_means_pointB_0m.png](output_jp/figures/fig_ta_vs_salinity_monthly_means_pointB_0m.png)

```{r reg_AT_S_monthly}
  kable(reg_AT_S_monthly, digits = c(3), padding = 0, caption="Regression parameters of the AT=f(S) relationship derived using monthly means.")
  kable(reg_AT_S_all, digits = c(3), padding = 0, caption="Regression parameters of the AT=f(S) relationship derived using all data.")
```


Salinity and total alkalinity data were compared with the weekly, from Tuesday to Monday, sum of precipitation data (Nice airport). Note that the analysis is incomplete as the 2015 data are currenly missing.
![precip.png](output_jp/figures/precip.png)


## Daily and monthly changes in pH and T
```{r Daily and seasonal changes, include=FALSE}
# Long series
continuous_discrete <- read_csv(file = paste0(path, "data/continuous_discrete.csv"), 
                                col_names = TRUE,
                                col_types = "cdddddddddddddddddddd") %>% 
  dplyr::mutate(date = as.POSIXct(date))
continuous_discrete$pHspec_Tptb <- as.numeric(continuous_discrete$pHspec_Tptb)
continuous_discrete <- filter(continuous_discrete, date > "2014-06-27 00:00:00")
deploy <- as.numeric(as.POSIXct(
   c("2014-01-07 09:00:08",
  "2014-02-11 09:00:08",
  "2014-04-28 13:00:08",
  "2014-06-27 10:00:08",
  "2014-09-16 08:00:08",
  "2014-11-20 09:30:08",
  "2014-02-11 09:00:08",
  "2014-12-19 09:30:08",
  "2015-03-31 07:10:08",
  "2015-06-01 08:00:08",
  "2015-07-06 08:00:08",
  "2015-09-29 09:00:08",
  "2015-12-08 09:00:08",
  "2016-01-07 09:00:08",
  "2016-03-08 09:00:08",
  "2016-04-08 08:00:08"
  ), tz = "UTC"))
plot_continuous_discrete_pH  <- ggplot(data = filter(continuous_discrete,!is.na(pHT_sfint))) +
  geom_vline(xintercept = deploy, colour="grey") + 
  geom_point(aes(x = date, y = pHT_sfint), size = 0.1) +
  geom_point(data = filter(continuous_discrete, !is.na(pHspec_Tptb)),
    aes(x = date, y = pHspec_Tptb), size = size_point, colour = "#51C56AFF") +
  labs(x = NULL, y=expression(paste(pH[T])), title = NULL) +
  scale_x_datetime(date_breaks="4 months", 
               date_minor_breaks="1 month", labels=date_format("%b %Y")) +
  Mytheme() +
  theme(panel.grid.major.x = element_blank())
  #annotation_custom(grob_A)

  # Plot Seafet temperature
plot_continuous_discrete_T  <- ggplot(data = filter(continuous_discrete,!is.na(T_seaF))) +
  geom_vline(xintercept = deploy, colour="grey") + 
  geom_point(aes(x = date, y = T_seaF), size = 0.1) +
  labs(x = NULL, y="Temperature (°C)", title = NULL) +
  scale_x_datetime(date_breaks="4 months", 
               date_minor_breaks="1 month", labels=date_format("%b %Y")) +
  Mytheme() +
  theme(panel.grid.major.x = element_blank())
  #annotation_custom(grob_B)

# Zoom on a few days
date_min <- as.numeric(as.POSIXct("2015-05-01"))
date_max <- as.numeric(as.POSIXct("2015-05-05"))
dat <- filter(continuous_discrete, !is.na(pHT_sfint) & date > date_min & date < date_max)
plot_zoom <- ggplot(data =dat) +
  geom_point(aes(x = date, y = pHT_sfint), size = size_point) +
  labs(x = NULL, y=expression(paste(pH[T])), title = NULL) +
  scale_x_datetime(breaks = date_breaks("1 days"), labels = date_format("%d %b")) +
  Mytheme() +
  theme(panel.grid.major.x = element_blank())
  #annotation_custom(grob_E)

# Offset between seafet pH and spec pH (Fig. 2 Kapsenberg et al.)
dat <- mutate(continuous_discrete, diff_pH = pHspec_Tptb - pHT_sfint)
average_offset <- mean(abs(dat$diff_pH), na.rm=TRUE)

plot_offset <- ggplot(data = filter(dat, !is.na(diff_pH))) +
  geom_hline(yintercept=mean(dat$diff_pH, na.rm = TRUE), size=0.3) +
  geom_point(aes(x = date, y = diff_pH), size = 1, colour = "#51C56AFF") +
  labs(x = NULL, y=expression(paste(pH[T], " difference")), title = NULL) +
  scale_x_datetime(date_breaks="4 months", 
               date_minor_breaks="1 month", labels=date_format("%b %Y")) +
  Mytheme() +
  theme(panel.grid.major.x = element_blank())
  #annotation_custom(grob_C)

# Range of daily pH changes
range <- tbl_df(
  dat %>%
  group_by(date=as.Date(date), month=month(date, label=TRUE), year=year(date)) %>%
  summarize(pH_range = max(pHT_sfint) - min(pHT_sfint))
)
quant <- quantile(range$pH_range, probs =c(2.5/100, 97.5/100))

# Per month
range_month <-
  range %>%
  group_by(Month = month(date, label=TRUE, abbr=FALSE)) %>%
  summarize(pH_range_month = mean(pH_range, na.rm=TRUE))
# add chla in range_month
range_month <- inner_join(range_month, select(dat_month0m, Month, Temperature, Chla), by="Month")
range_month$monthd <- c(1:12)

#regressions
reg_Temperature <- lm(pH_range_month ~ Temperature, data=range_month)
reg_Chla <- lm(pH_range_month ~ Chla, data=range_month)

# plot
plot_range_pH_Chla_month <-  ggplot(data = range_month) +
  geom_text(aes(x = Chla, y = pH_range_month, label = Month)) +
  labs(x = "Chl-a concentration", y = "pH range", title = NULL) +
  theme_bw()
ggsave("output_jp/figures/plot_range_pH_Chla_month.png", plot_range_pH_Chla_month)

plot_range_pH_Temperature <-  ggplot(data = range_month) +
  geom_text(aes(x = Temperature, y = pH_range_month, label = Month), na.rm=TRUE) +
  scale_x_continuous(limits=c(12, 25)) +
  scale_y_continuous(limits=c(0.02, 0.041)) +
  labs(title = NULL,
       x = "Temperature (°C)",
       y = expression(paste(pH[T], " range"))) +
  Mytheme(size_labs = 9) +
  theme(aspect.ratio=1/2,
        axis.title.x = element_text(margin=margin(t=0.25, r=0, b=0.25, l=0, unit = "cm")))
  #annotation_custom(grob_A)
ggsave("output_jp/figures/plot_range_pH_Temperature.png", plot_range_pH_Temperature)

size_point <- 0.4 # size of data points
plot_range <-  
  ggplot(data=range, aes(x = as.factor(month), y = pH_range)) +
  geom_violin(fill='lightblue', alpha=0.5, size=0.2, trim = TRUE) +
  geom_boxplot(notch=TRUE, size=0.2, fill="grey50", outlier.color = "blue", outlier.size = 0.3) +
  labs(y =expression(paste(pH[T], " range")), x=NULL, title=NULL) +
  Mytheme() +
  theme(panel.grid.major.x = element_blank())
  #annotation_custom(grob_D)

g <- plot_grid(plot_continuous_discrete_pH, plot_continuous_discrete_T, plot_offset, plot_range, plot_zoom, align='vh', ncol=1)
ggsave("output_jp/figures/fig_paper_time_series.png", g, width = 18, height = 14, units = "cm")
ggsave(file="output_jp/figures/fig7.pdf", g, width = 8, height = 16, units = "cm")

# Per year and week
range$year_week <- paste0(range$year,"-", week(range$date))
range_year_week <-
  ungroup(range) %>%
  group_by(year_week) %>%
  summarize(pH_range_year_week = mean(pH_range, na.rm=TRUE))
# add year_month to weekly data
tmp <- ungroup(dat0m) %>%
  mutate(year_week=paste0(year,"-", week(sampling_date))) %>%
  select(sampling_date, Chla, year_week)
# add chla in range_month
range_year_week <- inner_join(range_year_week, tmp, by="year_week")
plot_range_pH_Chla_week <-  ggplot(data =  range_year_week) +
  geom_point(aes(x = Chla, y = pH_range_year_week), na.rm=TRUE) +
  labs(title = NULL,
       x = expression(paste("Chl-a concentration (mg ", m^-3,")")),
       y = "pH range") +
  Mytheme(size_labs = 9) +
  theme(aspect.ratio=1/2,
        axis.title.x = element_text(margin=margin(t=0.25, r=0, b=0.25, l=0, unit = "cm")))
  #annotation_custom(grob_B)
ggsave("output_jp/figures/plot_range_pH_Chla_week.png", plot_range_pH_Chla_week)

plot_range_pH_Chla_temp <- plot_grid(plot_range_pH_Temperature,
                                     plot_range_pH_Chla_week, ncol = 1, align = "h")
ggsave("output_jp/figures/plot_range_pH_Chla_temp.png", plot_range_pH_Chla_temp, width = 8)
ggsave("output_jp/figures/figS1.pdf", plot_range_pH_Chla_temp, width = 8, height = 8)

```

The average error in pH due to spatiotemporal mismatch between sensor and discrete sample is `r average_offset`.
![fig_paper_time_series.png](output_jp/figures/fig_paper_time_series.png)

The quantiles of interest for the daily pH range of the total scale are `r quant ` (respectively 2.5% and 97.5%).

The changes in the daily pH range do not seem to be driven by the concentration of Chl-a nor by temperature as the relationships between pH range with temperature and Chla are not significant. For temperature r-square is `r summary(reg_Temperature)$r.squared` with a p-value of `r summary(reg_Temperature)$fstatistic[1]`. For Chla r-square is `r summary(reg_Chla)$r.squared` with a p-value of `r summary(reg_Chla)$fstatistic[1]`. 


```{r kable pH range vs temperature and Chla}
pander(summary(reg_Temperature), digits = c(5,5,5,3,3), caption="Regressions on values monthly means of pH range as a function of temperature")
pander(summary(reg_Chla), digits = c(5,5,5,3,3), caption="Regressions on values monthly means of pH range as a function of Chla")
```


![plot_range_pH_Chla_month.png](output_jp/figures/plot_range_pH_Chla_month.png)
![plot_range_pH_Chla_temp.png](output_jp/figures/plot_range_pH_Chla_temp.png)


## CO2
```{r CO2, include=FALSE}
CO2_pr <- tbl_df(
  read_csv(file=paste0(path, "data/CO2_data_PlateauRosa_daily_1993-2015_R.csv"), col_names=TRUE, skip=7)
) %>%
  rename(dt=date) %>%
  mutate(year=year(dt)) %>%
  filter(dt >= "2007-01-01")
NAs_by_year <- summarise(group_by(CO2_pr, year), NAs=sum(is.na(atm_CO2))) # N NAs per year
duration <- CO2_pr$dt[length(CO2_pr$dt)] - CO2_pr$dt[1]
CO2_pr_zoo <- zooreg(CO2_pr$atm_CO2, order.by=CO2_pr$dt) # create zoo time series
CO2_pr_zoo_i <- na.approx(CO2_pr_zoo) # interpolate NAs
CO2_pr_i <- tbl_df(fortify.zoo(CO2_pr_zoo_i)) %>% # change to df
  rename(dt=Index, atm_CO2=CO2_pr_zoo_i) %>%
  mutate(year=year(dt), monthd = month(dt), month = month(dt, label = TRUE, abbr = FALSE))
# add seawater pCO2
tmp <- ungroup(dat0m) %>%
  select(sampling_date, pCO2)
tmp$dt <- as.Date(tmp$sampling_date)
CO2_pr_i <- left_join(CO2_pr_i, tmp)
# Calculate monthly means
tmp <- CO2_pr_i %>%
  group_by(monthd) %>%
  summarise(atm_CO2__month = mean(atm_CO2, na.rm = TRUE))

# Calculate anomalies
ano_atm_CO2 <- left_join(ungroup(CO2_pr_i), tmp, by = "monthd") %>%
  mutate(atm_CO2_ano = atm_CO2 - atm_CO2__month)

#regression atmospheric CO2
lms <- summary(lm(data = CO2_pr_i, atm_CO2 ~ decimal_date(dt)))
prob <- pf(lms$fstatistic[1],lms$fstatistic[2],lms$fstatistic[3],lower.tail=FALSE)
reg_atm_CO2 <- cbind(as.numeric(c(lms$coefficients[2,1], lms$coefficients[2,2], 
                               lms$coefficients[2,4], lms$coefficients[1,1],
                          lms$coefficients[1,2],
                          lms$coefficients[1,4], lms$fstatistic[1], lms$fstatistic[3], lms$r.squared, prob)))
colnames(reg_atm_CO2) <- c("atm_CO2 interpolated")
row.names(reg_atm_CO2) <- c("Slope", "SE Slope", "P Slope","Intercept","SE int.","P int.", "F", "df",
                    "R2","P value")

#regression atmospheric CO2 anomalies
lms <- summary(lm(data = ano_atm_CO2, atm_CO2_ano ~ decimal_date(dt)))
prob <- pf(lms$fstatistic[1],lms$fstatistic[2],lms$fstatistic[3],lower.tail=FALSE)
reg_atm_CO2_ano <- cbind(as.numeric(c(lms$coefficients[2,1], lms$coefficients[2,2], 
                               lms$coefficients[2,4], lms$coefficients[1,1],
                          lms$coefficients[1,2],
                          lms$coefficients[1,4], lms$fstatistic[1], lms$fstatistic[3], lms$r.squared, prob)))
colnames(reg_atm_CO2_ano) <- c("ano_atm_CO2")
row.names(reg_atm_CO2_ano) <- c("Slope", "SE Slope", "P Slope","Intercept","SE int.","P int.", "F", "df",
                    "R2","P value")
# bind the two regression tables
reg_atm_CO2 <- cbind(reg_atm_CO2, reg_atm_CO2_ano)

# plots CO2
# CO2_pr_i_melt <- CO2_pr_i %>%
#   select(dt, atm_CO2, pCO2) %>%
#   melt(id.var = "dt")
CO2_pr_i_melt <- CO2_pr_i %>%
  select(dt, atm_CO2, pCO2) %>%
  gather(key = variable, value=value, -dt, na.rm = TRUE)

fig_CO2_time_series <- ggplot(data=CO2_pr_i_melt) +
  geom_point(aes(x=dt, y=value, colour=variable)) +
  geom_smooth(aes(x=dt, y=value,color=variable), method = "lm") +
  labs(title=NULL, x="Time", y="CO2") +
  Mytheme() +
  theme(legend.position="top") +
  guides(col = guide_legend(ncol = 2, byrow = TRUE))
  #annotation_custom(grob_A)

fig_CO2_ano <- ggplot(data = ano_atm_CO2, aes(x = as.POSIXct(dt), y = atm_CO2_ano)) +
  scale_x_datetime(breaks = date_breaks("2 year"), labels = date_format("%Y")) +
  geom_point(colour="orange", na.rm=TRUE, size=size_point) + 
  geom_smooth(method=lm, colour="black", fill="grey", size=0.6) +
  labs(title=NULL, x="Time", y=expression(paste("Atmospheric ", CO[2]))) +
  Mytheme()
  #annotation_custom(grob_B)

fig_delta_CO2 <- ggplot(data = CO2_pr_i, aes(x = as.POSIXct(dt), y = pCO2 - atm_CO2), na.rm=TRUE) +
  scale_x_datetime(breaks = date_breaks("2 year"), labels = date_format("%Y")) +
  geom_point(colour="orange", na.rm=TRUE, size=size_point) + 
  #geom_smooth(method=lm, colour="black", fill="grey", size=0.6) +
  labs(title="Positive values indicate a source for the atmosphere", x="Time", y=expression(paste("Seawater ", pCO[2], " - atmospheric ", CO[2]))) +
  Mytheme() +
  geom_hline(yintercept = 0)
  
g <- arrangeGrob(fig_CO2_time_series, fig_CO2_ano, ncol=1)
ggsave("output_jp/figures/fig_atm_CO2.png", g)
```

Atmospheric concentration of CO2 measured at Plateau Rosa from 1993 to 2015 were downloaded from <http://ds.data.jma.go.jp/gmd/wdcgg/cgi-bin/wdcgg/download.cgi?index=PRS645N00-RSE&param=200612120114&select=inventory>. Note that contributors should be contacted for proper acknowledgement for use of the data or offer of co-authorship
<http://ds.data.jma.go.jp/gmd/wdcgg/cgi-bin/wdcgg/accessdata.cgi?lang=&contributor_index=200612120057>

There are missing data:

```{r kable NAs atm CO2}
  kable(NAs_by_year, digits = c(0,0), padding = 0, caption="Number of days without atmospheric CO2 data.")
```

Missing values were filled by linear interpolation between nearest values in order to obtain the same sampling number per year. The rate of increase was calculated by regressing the CO$_2$ concentration (`r round(reg_atm_CO2[1,1], digit=2)` ppm per year) and the anomaly (`r round(reg_atm_CO2[1,2], digit=2)` ppm per year) following subtraction of monthly means against time.

The rate of increase of seawater pCO2 (`r round(reg_var_1m[7,1], digit=2)` uatm per year) is much larger than that of atmospheric CO2 (`r round(reg_atm_CO2[1,1], digit=2)` ppm per year).

![fig_atm_CO2.png](output_jp/figures/fig_atm_CO2.png)

```{r Table reg atm CO2}
  kable(reg_atm_CO2, digits = c(2,2), caption="Regressions of atmospheric CO2 (time series and anomalies).")
```

```{r deffayes plot}
ct <- seq(2155e-6, 2300e-6, length.out=20)
at <- seq(2455e-6, 2600e-6, length.out=20)
grid_data <- data.frame(ct=ct, at=at)
zz <- tbl_df(expand.grid(ct,at))
colnames(zz) <- c("ct", "at")
zz2 <- carb(flag=15, var1=zz$at, var2=zz$ct, S=38, T=18, P=0)
zz$pCO2 <- zz2$pCO2
zz$CO3 <- zz2$CO3
zz$pH <- zz2$pH
deff <- ggplot() + 
  geom_contour(data=zz, aes(x=ct*1e6, y=at*1e6, z=pH), stat = "contour", binwidth = 0.1, na.rm=TRUE) +
stat_contour(aes(colour=..level..), breaks=c(8, 8.1, 8.2)) +
  geom_point(data=dat0m, aes(x = dic, y=ta, col=as.factor(year)), na.rm=TRUE) + 
  scale_color_viridis(name="Year", discrete=TRUE, option="plasma")

deff_monthly <- ggplot() + 
  stat_contour(data=zz, aes(x=ct*1e6, y=at*1e6, z=pH), breaks=seq(8,8.2, by=0.1), col="blue", na.rm=TRUE) +
  geom_text(data=dat0m_month, aes(x = ct, y=at, label=monthd, col=as.factor(year)), na.rm=TRUE) + 
    lims(x=c(2190, 2275), y=c(2510, 2580)) +
scale_color_viridis(name="Year", discrete=TRUE, option="plasma") +
    labs(title="Point B", 
       x=expression(paste(italic(C)[T]," ","(",mu, mol.kg^-1,")")),
       y=expression(paste(italic(A)[T]," ","(",mu, mol.kg^-1,")")))

deff_monthly <- ggplot() +
  stat_contour(
  data = zz,
  aes(x = ct * 1e6, y = at * 1e6, z = pH),
  breaks = seq(8, 8.2, by = 0.05),
  col = "blue",
  na.rm = TRUE
  ) +
  geom_text(data = dat0m_month,
  aes(x = ct, y = at, label = substr(dat0m_month$year, 3, 4), col = as.factor(monthd)),
  na.rm = TRUE) +
  lims(x = c(2190, 2275), y = c(2510, 2580)) +
  labs(title="Point B, coded with month (color) and year (digits)", 
       x=expression(paste(italic(C)[T]," ","(",mu, mol.kg^-1,")")),
       y=expression(paste(italic(A)[T]," ","(",mu, mol.kg^-1,")"))) +
  scale_color_viridis(name = "Month", discrete = TRUE, option = "plasma")
  #direct.label(deff_monthly, "top.pieces")
  ggsave(file = "output_jp/figures/fig_deffayes_monthly.png", deff_monthly,
  width = 15, height = 15, units = "cm")
  
# Yearly Deffayes plot
tmp <- summarize_all(group_by(dat0m_month, year), mean)
deff_yearly <- ggplot() +
  stat_contour(
  data = zz,
  aes(x = ct * 1e6, y = at * 1e6, z = pH),
  breaks = seq(8, 8.2, by = 0.05),
  col = "blue",
  na.rm = TRUE
  ) +
  geom_text(data = tmp ,
  aes(x = ct, y = at, label = substr(tmp$year, 3, 4)),
  na.rm = TRUE) +
  lims(x = c(2190, 2275), y = c(2510, 2580)) +
  labs(title="Point", 
       x=expression(paste(italic(C)[T]," ","(",mu, mol.kg^-1,")")),
       y=expression(paste(italic(A)[T]," ","(",mu, mol.kg^-1,")"))) +
  scale_color_viridis(name = "Month", discrete = TRUE, option = "plasma")
  #ggsave(file = "output_jp/figures/fig_deffayes_monthly.png", deff_monthly, width = 15, height = 15, units = "cm")

# Quarterly Deffayes plot
tmp <- ungroup(dat0m) %>%
  select(dic, ta, year, quarter) %>%
  rename(ct=dic, at=ta) %>%
  group_by(year, quarter) %>%
  summarize_all(mean,na.rm=TRUE)
deff_quarterly <- ggplot() +
  stat_contour(
  data = zz,
  aes(x = ct * 1e6, y = at * 1e6, z = pH),
  breaks = seq(8, 8.2, by = 0.05),
  col = "blue",
  na.rm = TRUE
  ) +
  geom_text(data = tmp ,
  aes(x = ct, y = at, label = tmp$quarter, col=as.factor(tmp$year)),
  na.rm = TRUE) +
  lims(x = c(2190, 2275), y = c(2510, 2580)) +
  labs(title="Point", 
       x=expression(paste(italic(C)[T]," ","(",mu, mol.kg^-1,")")),
       y=expression(paste(italic(A)[T]," ","(",mu, mol.kg^-1,")"))) +
  scale_color_viridis(name = "Month", discrete = TRUE, option = "plasma")
```

Test of a Deffayes plot.
![fig_deffayes_monthly.png](output_jp/figures/fig_deffayes_monthly.png)


